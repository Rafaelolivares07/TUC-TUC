<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda - Medicamentos a Domicilio</title>

    <!-- QRCode.js library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: #2e89ff; /* azul limpio tipo logo */
            color: white;
            padding: 0.25rem 0.2rem;  /* üÜï Reducido de 8rem 1rem 3rem 1rem */
            align-items: flex-start;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 1.3rem;  /* üÜï Reducido de 1.8rem */
            margin-bottom: 0.25rem;  /* üÜï Reducido de 0.5rem */
        }

        .header p {
            opacity: 0.9;
            font-size: 0.8rem;  /* üÜï Reducido de 0.9rem */
        }
        
        /* üÜï ESTILOS PARA BOTONES DEL HEADER */
        .btn-header {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        


        .btn-header:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-carrito-grande {
            font-size: 1.1rem;
            padding: 0.7rem 1.5rem;
        }
        
        .badge-header {
            background: #e74c3c;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.5rem;  /* üÜï Reducido de 0.75rem */
        }

        @media (min-width: 768px) {
            .container {
                padding: 1rem;  /* üÜï Reducido de 1.5rem */
            }
        }
        
        .filtros {
            background: #2e89ff;
            padding: 1rem;  /* üÜï Reducido de 1.5rem */
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;  /* üÜï Reducido de 2rem */
        }

        .filtros h3 {
            margin-bottom: 0.5rem;  /* üÜï Reducido de 1rem */
            color: #fcfcfd;
            font-size: 1rem;  /* üÜï Reducido de 1.1rem */
        }
        
        .filtro-grupo {
            margin-bottom: 1rem;
        }
        
        .filtro-grupo label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #fcf9f9;
        }
        
        .filtro-grupo input, .filtro-grupo select, .filtro-grupo textarea {
            width: 100%;
            padding: 0.5rem;  /* Reducido 33%: de 0.75rem a 0.5rem */
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .filtro-grupo textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .filtro-grupo input:focus, .filtro-grupo select:focus, .filtro-grupo textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .btn-buscar {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-buscar:hover {
            background: #5568d3;
        }
        
        /* üÜï ESTILOS PARA DIAGN√ìSTICOS DETECTADOS */
        .diagnosticos-detectados {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 0.75rem;  /* üÜï Reducido de 1rem */
            margin-bottom: 1rem;  /* üÜï Reducido de 1.5rem */
        }

        .diagnosticos-detectados h4 {
            color: #667eea;
            margin-bottom: 0.4rem;  /* üÜï Reducido de 0.5rem */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;  /* üÜï M√°s peque√±o */
        }
        
        .sintomas-detectados {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .sintoma-tag {
            background: #667eea;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .diagnostico-tag {
            background: #e74c3c;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .productos-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            max-width: 100% !important;
            width: 100%;
            padding: 0;
            margin: -3 -3rem;
        }
        
        /* üÜï RESPONSIVE LAYOUT */
        @media (min-width: 768px) {
            .productos-grid {
                grid-template-columns: repeat(2, 1fr);
                max-width: 100%;
                width: 100%;
            }
        }
        
        /* Mobile: 2 columnas solo cuando est√° activado */
        .productos-grid.dos-columnas {
            grid-template-columns: repeat(2, 1fr);
            max-width: 100% !important;
            width: 100%;
            gap: 0.75rem;  /* Reducir gap en m√≥vil */
            padding: 0;
            margin: 0;
        }
        
        /* üÜï BOT√ìN TOGGLE DE COLUMNAS */
        .toggle-columnas {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;  /* üÜï Reducido de 1.5rem */
            padding: 0.75rem;  /* üÜï Reducido de 1rem */
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .toggle-columnas label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            margin: 0;
        }
        
        .toggle-columnas input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
        }
        
        @media (min-width: 768px) {
            .toggle-columnas {
                display: none;
            }
        }
        
        .producto-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .producto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        
        .producto-imagen {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f9f9f9;
            padding: 1rem;
        }
        
        .producto-info {
            padding: 1rem;
        }
        
        .producto-nombre {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .producto-fabricante {
            color: #667eea;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .producto-presentacion {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .producto-diagnostico {
            background: #ffe6e6;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .producto-precio {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2196F3;
            margin: 0.5rem 0;
        }
        
        .btn-agregar {
            width: 100%;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            width: calc(100% - 2rem);
            margin-bottom: 1rem;
        }

        .btn-agregar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .sin-resultados {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .carrito-flotante {
            position: fixed;
            top: 10px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none; /* Oculto por defecto, aparece cuando header desaparece */
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
        }

        .carrito-flotante.visible {
            display: flex;
            opacity: 1;
        }

        .carrito-flotante:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.6);
        }

        .carrito-flotante svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        
        .carrito-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            width: 28px;  /* üÜï Aumentado de 24px */
            height: 28px; /* üÜï Aumentado de 24px */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;  /* üÜï Aumentado de 0.75rem */
            font-weight: bold;
        }
        
        /* üÜï BOT√ìN FLOTANTE PASTILLERO */
        .pastillero-flotante {
            position: fixed;
            top: 10px;  /* Misma altura que el carrito */
            left: 20px;  /* Mismo margen que el carrito (pero a la izquierda) */
            background: #2ecc71;
            color: white;
            width: 60px;  /* Mismo tama√±o que el carrito */
            height: 60px;  /* Mismo tama√±o que el carrito */
            border-radius: 50%;
            display: none;  /* Oculto por defecto, aparece cuando header desaparece */
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;  /* Misma transici√≥n que el carrito */
            z-index: 1000;
            opacity: 0;  /* Inicia invisible como el carrito */
        }
        
        .pastillero-flotante:hover {
            transform: scale(1.1);
        }
        
        .pastillero-flotante.visible {
            display: flex;
            opacity: 1;  /* Se hace visible como el carrito */
        }
        
        .pastillero-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        /* üÜï BOT√ìN SCROLL TO TOP - Moverlo m√°s arriba */
        .scroll-to-top {
            bottom: 12rem !important;  /* Moverlo arriba del pastillero */
        }
        
        /* üÜï ESTILOS MODAL PASTILLERO */
        .modal-pastillero {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-pastillero.active {
            display: flex;
        }
        
        .modal-pastillero-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-pastillero-header {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-pastillero-header h2 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-cerrar-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .btn-cerrar-modal:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* üÜï BOT√ìN ORDENAR PASTILLERO */
        .btn-ordenar-pastillero {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-ordenar-pastillero:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Bot√≥n de contactos */
        .btn-contactos-pastillero {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-contactos-pastillero:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-pastillero-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .pastillero-busqueda {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .pastillero-busqueda input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .pastillero-busqueda input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .pastillero-sugerencias {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .pastillero-sugerencias.active {
            display: block;
        }
        
        .sugerencia-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sugerencia-item:hover {
            background: #f8f8f8;
        }
        
        .sugerencia-item.sugerencia-activa {
            background: #2196F3;
            color: white;
        }
        
        .sugerencia-item:last-child {
            border-bottom: none;
        }
        
        .medicamento-item {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e0e0e0;
            transition: border-color 0.3s;
        }
        
        .medicamento-item:hover {
            border-color: #2196F3;
        }
        
        .medicamento-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }
        
        .medicamento-nombre {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }
        
        .medicamento-cantidad {
            background: #2196F3;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .medicamento-acciones {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .btn-medicamento {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .btn-tome {
            background: #e74c3c;
            color: white;
        }
        
        .btn-tome:hover {
            background: #c0392b;
        }
        
        .btn-agregar-cantidad {
            background: #2196F3;
            color: white;
        }

        .btn-agregar-cantidad:hover {
            background: #1976D2;
        }
        
        .btn-ver-sintomas {
            background: #3498db;
            color: white;
        }

        .btn-ver-sintomas:hover {
            background: #2980b9;
        }

        .btn-recordatorio {
            background: #95a5a6;
            color: white;
        }

        .btn-recordatorio:hover {
            background: #7f8c8d;
        }

        .btn-recordatorio.activo {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .btn-recordatorio.activo:hover {
            background: #229954;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .medicamento-sintomas {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            display: none;
        }
        
        .medicamento-sintomas.visible {
            display: block;
        }
        
        .medicamento-sintomas h4 {
            color: #3498db;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        .sintomas-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        /* üÜï Animaci√≥n para alertar medicamentos disponibles */
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            }
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }
        }
        
        .pastillero-vacio {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }
        
        .pastillero-vacio-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .productos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
        }

        /* üÜï MODAL DE REGISTRO PARA PASTILLERO */
        .modal-registro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-registro-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-registro-header {
            background: linear-gradient(135deg, #2e89ff 0%, #1976D2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .modal-registro-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-registro-body {
            padding: 1.5rem;
        }

        .modal-registro-body .form-group {
            margin-bottom: 1.2rem;
        }

        .modal-registro-body .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.95rem;
        }

        .modal-registro-body .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .modal-registro-body .form-group input:focus {
            outline: none;
            border-color: #2e89ff;
        }

        .modal-registro-body .nota {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.3rem;
        }

        .modal-registro-footer {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            gap: 0.75rem;
        }

        .btn-registrar {
            flex: 1;
            padding: 0.9rem;
            background: linear-gradient(135deg, #2e89ff 0%, #1976D2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-registrar:hover {
            transform: translateY(-2px);
        }

        .btn-registrar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancelar-registro {
            flex: 1;
            padding: 0.9rem;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-cancelar-registro:hover {
            background: #e0e0e0;
        }

        /* Botones de hora en modal de recordatorio */
        .btn-hora {
            padding: 0.75rem 1.5rem;
            background: #f0f0f0;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-hora:hover {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .btn-hora.selected {
            background: linear-gradient(135deg, #2e89ff 0%, #1976D2 100%);
            color: white;
            border-color: #1976D2;
        }


        /* CONTENEDOR DEL LOGO ‚Äî t√∫ mandas aqu√≠ */
        .logo-tuc {
            width: 450px;          /* üëà aqu√≠ juegas */
            height: 450px;         /* üëà aqu√≠ juegas */
            position: relative;
            display: flex;
            align-items: flex-start; /* pegado arriba */
            justify-content: center;
            overflow: hidden;     /* nada se sale */
        }

        /* LOGOS (base, navidad, promo) */
        .logo {
            width: 100%;
            height: 100%;
            object-fit: contain;     /* siempre dentro del contenedor */
            position: absolute;
            top: 0;
            left: 0;
            display: block;          /* mata espacios fantasmas */
            opacity: 0;
            transform: scale(0.97);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        /* LOGO ACTIVO */
        .logo.active {
            opacity: 1;
            transform: scale(1);
        }




        /* üîß LIMPIEZA DE ESPACIOS FANTASMA EN EL HEADER */
        .header h1,
        .header p {
            margin: 0;
            padding: 0;
        }

        /* Separaci√≥n controlada entre t√≠tulo y subt√≠tulo */
        .header p {
            margin-top: 0.25rem;
        }


        html, body {
            margin: 0;
            padding: 0;
        }


    </style>
</head>
<body>
    <div class="header" id="header-carousel" style="transition: all 0.5s ease; overflow: hidden;">
        <div class="container" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">

            <div class="logo-tuc" id="logoContainer">
                <!-- Promos se cargar√°n din√°micamente desde la BD -->
            </div>


        </div>
    </div>

    <div class="header" id="header-principal" style="transition: all 0.5s ease; position: sticky; top: 0; z-index: 999; background: #2e89ff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="container" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">

           <div id="titulo-principal" style="text-align: center; width: 100%; transition: all 0.5s ease; margin: 0.5rem 0; position: relative;">
               <h1 id="titulo-h1" style="margin: 0;">MAS QUE MEDICAMENTOS</h1>
               <p id="subtitulo-p" style="margin: 0.3rem 0;">Domicilio 30 minutos - Gratis en compras superiores a $50.000</p>

               <!-- üÜï Nombre de usuario en header -->
               <div id="usuario-header" style="display: none; position: absolute; top: 0; right: 0; color: #f8f9fa; font-size: 0.9rem; background: rgba(255,255,255,0.15); padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600;">
                   <span style="margin-right: 0.3rem;">üë§</span>
                   <span id="usuario-nombre-header">Hola, Usuario</span>
               </div>
           </div>

           <!-- Textarea de b√∫squeda -->
           <textarea
               id="busqueda_unificada"
               placeholder="Escribe aqui"
               rows="1"
               style="
                   width: 100%;
                   padding: 1rem;
                   border: 2px solid #e0e0e0;
                   border-radius: 8px;
                   font-size: 1.1rem;
                   font-family: inherit;
                   resize: none;
                   overflow: hidden;
                   transition: border-color 0.3s;
                   min-height: 42px;
                   margin-top: 0.5rem;
               "
               onfocus="activarModoInteraccion()"
               oninput="autoExpand(this); clearTimeout(window.busquedaTimeout); window.busquedaTimeout = setTimeout(() => { if(this.value.length <= 200) buscarProductos(); }, 800);"
               onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); buscarProductos(); }"
           ></textarea>

           <!-- Filtros de precio (interactivos con contador) -->
           <div id="filtros-container" style="display: none; margin-top: 0.5rem; width: 100%;">
               <div style="cursor: pointer; color: #f8f9fa; font-weight: 600; user-select: none; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;" onclick="toggleFiltrosAvanzados()">
                   <span id="contador-resultados">0 resultados</span> ‚Ä¢ <span>Filtros ‚öôÔ∏è</span>
               </div>

               <div id="filtros-avanzados-content" style="display: none; margin-top: 0.5rem;">

               <!-- Toggle de columnas -->
               <div class="toggle-columnas" id="toggleColumnasContainer" style="margin-top: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 8px;">
                   <label style="color: #f8f9fa;">
                       <input type="checkbox" id="toggleDosColumnas">
                        Ver 2 medicamentos por pantalla
                   </label>
               </div>

               <div class="filtros-grid" style="margin-top: 1rem; display: flex; gap: 1rem;">
                   <div class="filtro-grupo" style="flex: 1;">
                       <label>Precio M√≠nimo</label>
                       <input type="number" id="precioMin" placeholder="0">
                   </div>

                   <div class="filtro-grupo" style="flex: 1;">
                       <label>Precio M√°ximo</label>
                       <input type="number" id="precioMax" placeholder="50000">
                   </div>
               </div>
               </div>
           </div>






           <!-- Botones del header eliminados - ahora solo se usan los flotantes -->


        </div>
    </div>


    <div class="header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
        



        </div>
    </div>


    <div class="container">
        
        <!-- üÜï Diagn√≥sticos Detectados -->
        <div id="diagnosticosDetectados" style="display: none;" class="diagnosticos-detectados">
            <h4>ü©∫ An√°lisis de tus s√≠ntomas:</h4>
            <div id="diagnosticosContent"></div>
            <div id="sintomasDetectados" class="sintomas-detectados"></div>
        </div>

        <!-- Selector horizontal de categor√≠as -->
        <div id="selector-categorias" style="
            width: 100%;
            margin: 1rem 0;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            flex-wrap: nowrap;
            gap: 0.17rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        ">
            <style>
                #selector-categorias::-webkit-scrollbar {
                    display: none;
                }

                .categoria-chip {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    width: 130px;
                    min-width: 130px;
                    flex-shrink: 0;
                    padding: 0.6rem 0.4rem;
                    background: rgba(255, 255, 255, 0.2);
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    border-radius: 12px;
                    color: white;
                    font-size: 0.5rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    user-select: none;
                    text-align: center;
                    gap: 0.4rem;
                }

                .categoria-chip:hover {
                    background: rgba(255, 255, 255, 0.3);
                    transform: translateY(-2px);
                }

                .categoria-chip.activa {
                    background: rgba(255, 255, 255, 0.2);
                    border: 4px solid #22c55e;
                    box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
                }

                .categoria-chip img {
                    width: 110px !important;
                    height: 110px !important;
                    max-width: 110px !important;
                    max-height: 110px !important;
                    min-width: 110px !important;
                    min-height: 110px !important;
                    object-fit: cover;
                    border-radius: 8px;
                    display: block;
                }
            </style>

            <!-- Las categor√≠as se cargar√°n din√°micamente aqu√≠ -->
        </div>

        <!-- Productos -->
        <div id="productosContainer" class="loading">
            Cargando productos...
        </div>
    </div>
    
    <!-- Carrito Flotante -->
    <!-- üÜï BOT√ìN FLOTANTE PASTILLERO (lado izquierdo) -->
    <div id="pastillero-flotante" class="pastillero-flotante" onclick="abrirPastillero()">
        üíä
        <span class="pastillero-badge" id="pastilleroCount">0</span>
    </div>
    
    <!-- BOT√ìN FLOTANTE CARRITO (lado derecho) -->
    <div class="carrito-flotante" onclick="verCarrito()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-9.8-3.2v-.1l.9-1.7h7.4c.7 0 1.4-.4 1.7-1l3.9-7-1.7-1-3.9 7h-7l-4.4-9.5H1v2h2l3.6 7.6L5.2 14c-.1.3-.2.6-.2 1 0 1.1.9 2 2 2h12v-2H7.4c-.1 0-.2-.1-.2-.2z"/>
        </svg>
        <span class="carrito-badge" id="carritoCount">0</span>
    </div>
    
    <script>
        let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
        actualizarBadgeCarrito();

        // Cargar productos iniciales al cargar la p√°gina
        function cargarProductosIniciales() {
            console.log('üì¶ Cargando productos iniciales...');

            document.getElementById('productosContainer').innerHTML = '<div class="loading">Cargando productos...</div>';

            fetch('/api/productos')
                .then(res => res.json())
                .then(data => {
                    console.log('üì• Productos iniciales recibidos:', data.productos ? data.productos.length : 0);

                    if (data.ok && data.productos && data.productos.length > 0) {
                        mostrarProductos(data.productos, data);
                        productosMostradosEnTienda = data.productos;
                    } else {
                        document.getElementById('productosContainer').innerHTML = `
                            <div class="sin-resultados" style="text-align: center; padding: 3rem 1.5rem;">
                                <p style="color: #666;">Escribe un s√≠ntoma o nombre de medicamento para buscar</p>
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    console.error('Error cargando productos iniciales:', err);
                    document.getElementById('productosContainer').innerHTML = '<div class="sin-resultados">Error al cargar productos</div>';
                });
        }

        // Variables globales para categor√≠as
        let categoriaActiva = null;
        let categorias = [];

        // Cargar categor√≠as desde el backend
        async function cargarCategorias() {
            try {
                const response = await fetch('/api/categorias');
                const data = await response.json();

                if (data.ok) {
                    categorias = data.categorias;
                    const categoriaDestacadaId = data.categoria_destacada_id;

                    renderizarCategorias(categorias, categoriaDestacadaId);

                    // Establecer categor√≠a activa inicial (destacada o primera)
                    if (categoriaDestacadaId) {
                        categoriaActiva = categoriaDestacadaId;
                    } else if (categorias.length > 0) {
                        categoriaActiva = categorias[0].id;
                    }
                }
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
            }
        }

        // Renderizar selector de categor√≠as
        function renderizarCategorias(cats, destacadaId) {
            const container = document.getElementById('selector-categorias');

            container.innerHTML = cats.map(cat => `
                <div class="categoria-chip ${cat.id === destacadaId ? 'activa' : ''}"
                     data-categoria-id="${cat.id}"
                     onclick="filtrarPorCategoria(${cat.id})">
                    ${cat.imagen ? `<div style="width: 110px; height: 110px; overflow: hidden; flex-shrink: 0;"><img src="${cat.imagen}" alt="${cat.nombre}" style="width: 110px; height: 110px; object-fit: cover; display: block; margin: 0;"></div>` : ''}
                </div>
            `).join('');
        }

        // Filtrar productos por categor√≠a
        async function filtrarPorCategoria(categoriaId) {
            categoriaActiva = categoriaId;

            // Actualizar UI (marcar chip activo)
            document.querySelectorAll('.categoria-chip').forEach(chip => {
                if (parseInt(chip.dataset.categoriaId) === categoriaId) {
                    chip.classList.add('activa');
                } else {
                    chip.classList.remove('activa');
                }
            });

            // Cargar productos de la categor√≠a
            document.getElementById('productosContainer').innerHTML = '<div class="loading">Cargando productos...</div>';

            try {
                const response = await fetch(`/api/productos?categoria_id=${categoriaId}`);
                const data = await response.json();

                if (data.ok && data.productos && data.productos.length > 0) {
                    mostrarProductos(data.productos, data);
                    productosMostradosEnTienda = data.productos;
                } else {
                    document.getElementById('productosContainer').innerHTML = `
                        <div class="sin-resultados" style="text-align: center; padding: 3rem 1.5rem;">
                            <p style="color: #666;">No hay productos en esta categor√≠a</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error filtrando por categor√≠a:', error);
                document.getElementById('productosContainer').innerHTML = '<div class="sin-resultados">Error al cargar productos</div>';
            }
        }

        // Cargar categor√≠as y productos al inicio
        window.addEventListener('DOMContentLoaded', () => {
            cargarCategorias().then(() => {
                // Despu√©s de cargar categor√≠as, cargar productos de la categor√≠a destacada
                if (categoriaActiva) {
                    filtrarPorCategoria(categoriaActiva);
                } else {
                    cargarProductosIniciales();
                }
            });
        });

        // Funci√≥n para auto-expandir el textarea
        function autoExpand(field) {
            field.style.height = 'inherit';

            const computed = window.getComputedStyle(field);
            const height = field.scrollHeight
                + parseInt(computed.getPropertyValue('border-top-width'), 10)
                + parseInt(computed.getPropertyValue('border-bottom-width'), 10);

            const maxHeight = 200;

            if (height > maxHeight) {
                field.style.height = maxHeight + 'px';
                field.style.overflowY = 'auto';
            } else {
                field.style.height = height + 'px';
                field.style.overflowY = 'hidden';
            }
        }

        // üÜï Activar modo interacci√≥n cuando el usuario hace clic en el textarea
        let modoInteraccionActivo = false;
        const leyendasRotativas = [
            'TUC TUC siempre a tu lado!',
            'Tu salud es nuestra prioridad',
            'Medicamentos seguros y confiables',
            'Cuidando tu bienestar'
        ];
        let leyendaIndex = 0;

        function activarModoInteraccion() {
            if (modoInteraccionActivo) return; // Ya est√° activado
            modoInteraccionActivo = true;

            const headerCarousel = document.getElementById('header-carousel');
            const tituloH1 = document.getElementById('titulo-h1');
            const subtituloP = document.getElementById('subtitulo-p');
            const filtrosContainer = document.getElementById('filtros-container');

            // Mostrar filtros interactivos
            filtrosContainer.style.display = 'block';

            // Iniciar rotaci√≥n de leyendas
            tituloH1.textContent = leyendasRotativas[0];
            tituloH1.style.fontSize = '1.2rem';
            tituloH1.style.margin = '0';
            subtituloP.style.display = 'none';

            setInterval(() => {
                leyendaIndex = (leyendaIndex + 1) % leyendasRotativas.length;
                tituloH1.style.opacity = '0';
                setTimeout(() => {
                    tituloH1.textContent = leyendasRotativas[leyendaIndex];
                    tituloH1.style.opacity = '1';
                }, 300);
            }, 5000);

            // Esperar 3 segundos y hacer animaci√≥n electrocardiograma
            setTimeout(() => {
                animacionElectrocardiograma();
            }, 3000);

            // Esperar a que el navegador termine su scroll autom√°tico del teclado
            setTimeout(() => {
                // Guardar altura del carrusel y posici√≥n de scroll ANTES de ocultar
                const alturaCarrusel = headerCarousel.offsetHeight;
                const scrollAntes = window.pageYOffset || document.documentElement.scrollTop;

                // Configurar transici√≥n del carrusel
                headerCarousel.style.maxHeight = alturaCarrusel + 'px';

                // Iniciar ocultamiento del carrusel
                setTimeout(() => {
                    headerCarousel.style.maxHeight = '0';
                    headerCarousel.style.opacity = '0';
                    headerCarousel.style.marginBottom = '0';
                    headerCarousel.style.paddingTop = '0';
                    headerCarousel.style.paddingBottom = '0';

                    // Ajustar scroll INMEDIATAMENTE junto con la animaci√≥n para evitar saltos
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const scrollActual = window.pageYOffset || document.documentElement.scrollTop;
                            window.scrollTo({
                                top: scrollActual - alturaCarrusel,
                                behavior: 'auto'
                            });
                        });
                    });
                }, 10);
            }, 100);
        }

        function animacionElectrocardiograma() {
            const tituloH1 = document.getElementById('titulo-h1');
            const fontSizeOriginal = parseFloat(window.getComputedStyle(tituloH1).fontSize);
            const fontSizeNuevo = fontSizeOriginal + 2;

            // Crear animaci√≥n de latido tipo electrocardiograma
            tituloH1.style.transition = 'font-size 0.1s ease';

            // Latido 1
            setTimeout(() => { tituloH1.style.fontSize = fontSizeNuevo + 'px'; }, 0);
            setTimeout(() => { tituloH1.style.fontSize = fontSizeOriginal + 'px'; }, 100);

            // Latido 2 (m√°s fuerte)
            setTimeout(() => { tituloH1.style.fontSize = (fontSizeNuevo + 2) + 'px'; }, 200);
            setTimeout(() => { tituloH1.style.fontSize = fontSizeOriginal + 'px'; }, 300);

            // Latido 3
            setTimeout(() => { tituloH1.style.fontSize = fontSizeNuevo + 'px'; }, 400);
            setTimeout(() => { tituloH1.style.fontSize = fontSizeOriginal + 'px'; }, 500);

            // Transformar a texto final
            setTimeout(() => {
                tituloH1.style.fontSize = fontSizeNuevo + 'px';
                tituloH1.style.transition = 'all 0.5s ease';
                tituloH1.textContent = 'TUC TUC';
            }, 800);

            // Despu√©s de 2 segundos m√°s, transformar al texto de b√∫squeda
            setTimeout(() => {
                tituloH1.textContent = 'Busca medicamentos o describe tus necesidades o afecciones';
                tituloH1.style.fontSize = (fontSizeOriginal - 2) + 'px';
                tituloH1.style.textTransform = 'capitalize';
            }, 2800);
        }

        function toggleFiltrosAvanzados() {
            const content = document.getElementById('filtros-avanzados-content');
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }

        // üÜï Variable global para s√≠ntomas actuales
        let sintomasBuscados = '';
        let sintomasDetectadosGlobal = []; // üÜï S√≠ntomas que el backend detect√≥
        let productosMostradosEnTienda = []; // üéØ NUEVO: Productos actualmente mostrados en tienda
        
        // üîç EXPONER GLOBALMENTE para debug desde consola
        window.DEBUG_verProductosTienda = function() {
            console.log('üì¶ Productos en tienda:', productosMostradosEnTienda.length);
            console.log(productosMostradosEnTienda);
            return productosMostradosEnTienda;
        };
        
        function buscarProductos() {
            console.log('üîç buscarProductos() ejecutado');

            const busquedaUnificada = document.getElementById('busqueda_unificada').value;
            
            // üÜï Guardar s√≠ntomas buscados
            sintomasBuscados = busquedaUnificada.trim();
            
            // üÜï No buscar si hay menos de 3 caracteres
            if (busquedaUnificada.trim().length > 0 && busquedaUnificada.trim().length < 3) {
                return; // Esperar a que escriba m√°s
            }
            
            // üÜï NUEVO: Prevenir 414 URI Too Long
            if (busquedaUnificada.length > 200) {
                document.getElementById('productosContainer').innerHTML = `
                    <div class="sin-resultados">
                        <p style="color: #e74c3c;">‚ö†Ô∏è La b√∫squeda es demasiado larga (m√°x 200 caracteres)</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Por favor, describe tus s√≠ntomas de forma m√°s breve.</p>
                    </div>
                `;
                return;
            }
            
            const precioMin = document.getElementById('precioMin').value;
            const precioMax = document.getElementById('precioMax').value;
            const params = new URLSearchParams();
            
            if (busquedaUnificada) {
                params.append('q', busquedaUnificada);
            }
            
            if (precioMin) params.append('precio_min', precioMin);
            if (precioMax) params.append('precio_max', precioMax);
            
            document.getElementById('productosContainer').innerHTML = '<div class="loading">Buscando...</div>';
            
            console.log('üöÄ INICIANDO B√öSQUEDA con params:', params.toString());
            
            fetch(`/api/productos?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    console.log('üì• Respuesta API:', {
                        ok: data.ok,
                        productos: data.productos ? data.productos.length : 0,
                        busqueda: busquedaUnificada,
                        params: params.toString()
                    });

                    if (data.ok) {
                        // üÜï Envolver en try-catch para que errores no detengan verificaci√≥n de pastillero
                        try {
                            mostrarDiagnosticos(data.sintomas_detectados || [], data.diagnosticos_posibles || [], data.busqueda_parcial || false);
                        } catch(e) {
                            console.error('Error en mostrarDiagnosticos:', e);
                        }
                        
                        try {
                            mostrarProductos(data.productos, data);
                        } catch(e) {
                            console.error('Error en mostrarProductos:', e);
                        }
                        
                        // üéØ CR√çTICO: Guardar productos ANTES del setTimeout
                        productosMostradosEnTienda = data.productos || [];
                        console.log('üíæ Productos guardados:', productosMostradosEnTienda.length);
                        
                        // üÜï CR√çTICO: Verificar pastillero SIEMPRE, incluso si hay errores arriba
                        // Usar setTimeout para asegurar que se ejecute despu√©s de todo lo dem√°s
                        setTimeout(() => {
                            try {
                                const sintomasDetectados = data.sintomas_detectados || [];
                                sintomasDetectadosGlobal = sintomasDetectados; // üÜï Guardar globalmente
                                
                                if (sintomasDetectados.length > 0 || productosMostradosEnTienda.length > 0) {
                                    console.log('üîç Llamando verificarMedicamentosPastillero');
                                    console.log('   S√≠ntomas:', sintomasDetectados);
                                    console.log('   Productos:', productosMostradosEnTienda.length);
                                    verificarMedicamentosPastillero();
                                } else {
                                    console.log('‚ÑπÔ∏è No hay s√≠ntomas ni productos, desactivando animaci√≥n');
                                    desactivarAnimacionPastillero();
                                }
                            } catch(e) {
                                console.error('Error en verificarMedicamentosPastillero:', e);
                            }
                        }, 100);
                    } else {
                        document.getElementById('productosContainer').innerHTML = 
                            '<div class="sin-resultados">Error al cargar productos</div>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('productosContainer').innerHTML = 
                        '<div class="sin-resultados">Error de conexi√≥n</div>';
                });
        }
        
        // üÜï Verificar si el usuario tiene medicamentos en su pastillero para los s√≠ntomas buscados
        // üéØ VERSI√ìN SIMPLE: Verificar qu√© productos de la tienda est√°n en el pastillero
        function verificarMedicamentosPastillero() {
            console.log('üîç Verificando coincidencias entre tienda y pastillero...');
            console.log('üè™ Productos en tienda:', productosMostradosEnTienda.length);
            
            // üéØ NUEVO: Solo verificar si el usuario busc√≥ algo espec√≠fico
            const busquedaActual = document.getElementById('busqueda_unificada').value.trim();
            if (!busquedaActual || busquedaActual.length < 3) {
                console.log('‚ÑπÔ∏è No hay b√∫squeda activa, no verificar pastillero');
                desactivarAnimacionPastillero();
                return;
            }
            
            if (productosMostradosEnTienda.length === 0) {
                console.log('‚ùå No hay productos en la tienda para comparar');
                desactivarAnimacionPastillero();
                return;
            }
            
            // Traer el pastillero completo (simple GET, sin filtros)
            fetch('/api/pastillero')
                .then(res => res.json())
                .then(data => {
                    const medicamentosPastillero = data.medicamentos || [];
                    console.log('üì¶ Medicamentos en pastillero:', medicamentosPastillero.length);
                    
                    // üîç DEBUG: Ver estructura de datos COMPLETA
                    if (medicamentosPastillero.length > 0) {
                        console.log('üì¶ PASTILLERO COMPLETO:', medicamentosPastillero[0]);
                        console.log('üì¶ Todos los medicamentos del pastillero:', medicamentosPastillero.map(m => ({
                            nombre: m.nombre,
                            todos_los_campos: Object.keys(m)
                        })));
                    }
                    if (productosMostradosEnTienda.length > 0) {
                        console.log('üè™ TIENDA COMPLETO:', productosMostradosEnTienda[0]);
                        console.log('üè™ Todos los productos de la tienda:', productosMostradosEnTienda.map(p => ({
                            nombre: p.nombre,
                            todos_los_campos: Object.keys(p)
                        })));
                    }
                    
                    // üîç PROBAR TODAS LAS COMBINACIONES POSIBLES
                    console.log('üß™ PROBANDO COMPARACIONES...');
                    productosMostradosEnTienda.forEach(producto => {
                        medicamentosPastillero.forEach(med => {
                            if (producto.nombre.toLowerCase().includes('aspirina') && 
                                med.nombre.toLowerCase().includes('aspirina')) {
                                console.log('üéØ ENCONTR√â ASPIRINA EN AMBOS:', {
                                    producto: {
                                        nombre: producto.nombre,
                                        todos_ids: Object.entries(producto).filter(([k,v]) => k.includes('id'))
                                    },
                                    medicamento: {
                                        nombre: med.nombre,
                                        todos_ids: Object.entries(med).filter(([k,v]) => k.includes('id'))
                                    }
                                });
                            }
                        });
                    });
                    
                    // üéØ COMPARAR IDS: ¬øCu√°les productos de la tienda est√°n en el pastillero?
                    const coincidencias = productosMostradosEnTienda.filter(producto => 
                        medicamentosPastillero.some(med => 
                            med.id_medicamento === producto.medicamento_id ||
                            med.medicamento_id === producto.medicamento_id
                        )
                    );
                    
                    console.log('‚úÖ Coincidencias encontradas:', coincidencias.length);
                    if (coincidencias.length > 0) {
                        console.log('   Medicamentos:', coincidencias.map(c => c.nombre));
                    }
                    
                    const btnPastillero = document.getElementById('pastillero-flotante');

                    if (!btnPastillero) {
                        console.warn('‚ö†Ô∏è Bot√≥n pastillero no encontrado');
                        return;
                    }

                    if (coincidencias.length > 0) {
                        console.log(`üéØ ACTIVANDO ANIMACI√ìN: ${coincidencias.length} de los productos mostrados est√°n en tu pastillero`);
                        btnPastillero.style.animation = 'pulse 1.5s ease-in-out infinite';
                        btnPastillero.style.boxShadow = '0 0 20px rgba(46, 204, 113, 0.7)';
                        btnPastillero.title = `¬°Tienes ${coincidencias.length} de estos medicamentos en tu pastillero!`;
                    } else {
                        console.log('‚ùå Ning√∫n producto mostrado est√° en el pastillero');
                        desactivarAnimacionPastillero();
                    }
                })
                .catch(err => {
                    console.error('üí• Error al verificar pastillero:', err);
                    desactivarAnimacionPastillero();
                });
        }
        
        // üÜï Desactivar animaci√≥n del pastillero
        function desactivarAnimacionPastillero() {
            console.log('üîá desactivarAnimacionPastillero llamada');
            const btnPastillero = document.getElementById('pastillero-flotante');

            if (!btnPastillero) {
                console.warn('‚ö†Ô∏è Bot√≥n no encontrado al desactivar');
                return;
            }

            btnPastillero.style.animation = '';
            btnPastillero.style.boxShadow = '';
            btnPastillero.title = 'Mi Pastillero';
            console.log('‚úÖ Animaci√≥n desactivada');
        }
        


        function mostrarDiagnosticos(sintomas, diagnosticos, esBusquedaParcial = false) {
            const container = document.getElementById('diagnosticosDetectados');
            const content = document.getElementById('diagnosticosContent');
            const sintomasDiv = document.getElementById('sintomasDetectados');
            
            if (sintomas.length === 0 && diagnosticos.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const diagnosticosDirectos = diagnosticos.filter(d => d.es_directo);
            const diagnosticosPorSintomas = diagnosticos.filter(d => !d.es_directo);
            
            let html = '';
            
            if (diagnosticosDirectos.length > 0) {
                diagnosticosDirectos.forEach(d => {
                    html += `
                        <div class="diagnostico-directo" style="
                            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
                            border: 2px solid #667eea;
                            border-radius: 10px;
                            padding: 1rem;
                            margin-bottom: 1rem;
                        ">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">üéØ</span>
                                <strong style="color: #667eea; font-size: 1.1rem;">Diagn√≥stico y/o tratamiento identificado:</strong>
                                <span style="color: #333; font-size: 1.1rem; font-weight: 600;">${d.nombre}</span>
                            </div>
                    `;
                    
                    if (d.sintomas_faltantes && d.sintomas_faltantes.length > 0) {
                        html += `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    ‚ùì ¬øTambi√©n presentas estos s√≠ntomas y/o indicaciones?
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        `;
                        
                        d.sintomas_faltantes.forEach(sintoma => {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 5px; transition: background 0.2s;" 
                                       onmouseover="this.style.background='#f0f0f0'" 
                                       onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" 
                                           class="sintoma-faltante-check" 
                                           data-sintoma-id="${sintoma.id}" 
                                           data-sintoma-nombre="${sintoma.nombre}"
                                           style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #555; font-size: 0.95rem;">${sintoma.nombre}</span>
                                </label>
                            `;
                        });
                        
                        html += `
                                </div>
                                <button onclick="refinarBusquedaConSintomasFaltantes()" 
                                        style="
                                            margin-top: 0.75rem;
                                            background: #667eea;
                                            color: white;
                                            border: none;
                                            padding: 0.5rem 1rem;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-weight: 600;
                                            transition: background 0.3s;
                                        "
                                        onmouseover="this.style.background='#5568d3'"
                                        onmouseout="this.style.background='#667eea'">
                            Refinar b√∫squeda
                        </button>
                    </div>
                `;
            }
            
            html += `</div>`;
        });
    }
    
    if (diagnosticosPorSintomas.length > 0) {
        diagnosticosPorSintomas.forEach(d => {
            html += `
                <div class="diagnostico-sintomas" style="
                    background: linear-gradient(135deg, #e74c3c15 0%, #c0392b15 100%);
                    border: 2px solid #e74c3c;
                    border-radius: 10px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                ">
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                        <span style="font-size: 1.5rem;">ü©∫</span>
                        <strong style="color: #e74c3c; font-size: 1rem;">Posible diagn√≥stico y/o tratamiento:</strong>
                        <span style="color: #333; font-size: 1rem; font-weight: 600;">${d.nombre}</span>
                        <span style="
                            background: #e74c3c;
                            color: white;
                            padding: 0.25rem 0.75rem;
                            border-radius: 15px;
                            font-size: 0.85rem;
                            font-weight: 600;
                        ">
                            ${d.coincidencias} de ${d.total_sintomas} s√≠ntomas - ${Math.round(d.porcentaje)}% match
                        </span>
                    </div>
                </div>
            `;
        });
    }
    
    if (diagnosticos.length === 0 && sintomas.length > 0) {
        html = '<p style="color: #666; font-size: 0.9rem;">No se detect√≥ un diagn√≥stico y/o tratamiento espec√≠fico, pero encontramos medicamentos para tus s√≠ntomas y/o indicaciones.</p>';
    }
    
    content.innerHTML = html;
    
    if (sintomas.length > 0) {
        const tituloSintomas = esBusquedaParcial 
            ? 'üí° Posibles s√≠ntomas: ¬øse refiere a alguno de estos? Agregue palabras para refinar su b√∫squeda y as√≠ encontremos los mejores resultados'
            : 'S√≠ntomas y/o indicaciones detectadas:';
        
        sintomasDiv.innerHTML = `
            <strong style="display: block; margin-bottom: 0.5rem; color: #667eea;">${tituloSintomas}</strong>
            ${sintomas.map(s => `<span class="sintoma-tag">‚úì ${s}</span>`).join('')}
        `;
    }
}

        function refinarBusquedaConSintomasFaltantes() {
            const checkboxes = document.querySelectorAll('.sintoma-faltante-check:checked');
            
            if (checkboxes.length === 0) {
                alert('Por favor selecciona al menos un s√≠ntoma y/o indicaci√≥n adicional');
                return;
            }
            
            const busquedaActual = document.getElementById('busqueda_unificada').value;
            const nombresAdicionales = Array.from(checkboxes).map(cb => cb.dataset.sintomaNombre).join(' ');
            const nuevaBusqueda = busquedaActual + ' ' + nombresAdicionales;
            
            document.getElementById('busqueda_unificada').value = nuevaBusqueda;
            autoExpand(document.getElementById('busqueda_unificada'));
            buscarProductos();
            
            const mensaje = document.createElement('div');
            mensaje.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2196F3;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            `;
            mensaje.innerHTML = `
                <strong>‚úÖ B√∫squeda refinada</strong><br>
                <span style="font-size: 0.9rem;">Incluyendo ${checkboxes.length} s√≠ntoma(s) y/o indicaci√≥n(es) adicional(es)</span>
            `;
            document.body.appendChild(mensaje);
            
            setTimeout(() => {
                mensaje.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => mensaje.remove(), 300);
            }, 3000);
        }

        if (!document.getElementById('diagnosticos-animations')) {
            const style = document.createElement('style');
            style.id = 'diagnosticos-animations';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
       
        
        
        function mostrarProductos(productos, data) {  // üÜï Agregamos 'data'
            const container = document.getElementById('productosContainer');
            
            // üÜï DETECTAR si es b√∫squeda por s√≠ntomas/diagn√≥sticos
            const esBusquedaInteligente = (data.sintomas_detectados && data.sintomas_detectados.length > 0) || 
                                        (data.diagnosticos_posibles && data.diagnosticos_posibles.length > 0);
            
            if (productos.length === 0) {
                // üÜï Detectar si es b√∫squeda de producto espec√≠fico o s√≠ntomas
                const busquedaActual = document.getElementById('busqueda_unificada').value.trim();
                const esProducto = esProductoEspecifico(busquedaActual);
                
                let mensaje = '';
                let tipoBusqueda = '';
                
                if (esProducto) {
                    tipoBusqueda = 'producto';
                    mensaje = `
                        <div class="sin-resultados" style="text-align: center; padding: 3rem 1.5rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîÑ</div>
                            <h3 style="color: #667eea; margin-bottom: 1rem;">Actualizando inventario</h3>
                            <p style="color: #666; margin-bottom: 2rem; line-height: 1.6;">
                                Este producto est√° en proceso de ingreso al sistema.<br>
                                <strong>¬øQuieres que verifiquemos disponibilidad inmediata?</strong>
                            </p>
                            <button onclick="abrirModalTelefono('${busquedaActual.replace(/'/g, "\\'")}', '${tipoBusqueda}')" 
                                    style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: white;
                                        border: none;
                                        padding: 1rem 2.5rem;
                                        border-radius: 50px;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        cursor: pointer;
                                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                                        transition: all 0.3s;
                                    "
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">
                                ‚úÖ Verificar disponibilidad ahora
                            </button>
                        </div>
                    `;
                } else {
                    tipoBusqueda = 'sintoma';
                    mensaje = `
                        <div class="sin-resultados" style="text-align: center; padding: 3rem 1.5rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ü©∫</div>
                            <h3 style="color: #667eea; margin-bottom: 1rem;">No encontramos productos exactos</h3>
                            <p style="color: #666; margin-bottom: 2rem; line-height: 1.6;">
                                Para estos s√≠ntomas o necesidades espec√≠ficas,<br>
                                <strong>nuestro equipo puede asesorarte personalmente</strong>
                            </p>
                            <button onclick="abrirModalTelefono('${busquedaActual.replace(/'/g, "\\'")}', '${tipoBusqueda}')"
                                    style="
                                        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                                        color: white;
                                        border: none;
                                        padding: 1rem 2.5rem;
                                        border-radius: 50px;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        cursor: pointer;
                                        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
                                        transition: all 0.3s;
                                    "
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.6)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.4)';">
                                üí¨ Contactar asesor ahora
                            </button>
                        </div>
                    `;
                }
                
                container.innerHTML = mensaje;
                return;
            }
            
            container.classList.add('productos-grid');
            // üÜï MANTENER LA CLASE dos-columnas si est√° activada
            if (localStorage.getItem('productosDosColunas') === 'true') {
                container.classList.add('dos-columnas');
            }
            
            // üÜï FUNCI√ìN HELPER: Validar y limpiar URL de imagen
            function obtenerUrlImagen(imagenOriginal) {
                if (!imagenOriginal) {
                    return 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23eee%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2220%22%3ESin imagen%3C/text%3E%3C/svg%3E';
                }
                
                // Si ya es una URL completa (empieza con http o data:), devolverla tal cual
                if (imagenOriginal.startsWith('http') || imagenOriginal.startsWith('data:')) {
                    return imagenOriginal;
                }
                
                // üî• CR√çTICO: Solo rechazar si es EXTREMADAMENTE larga (>500 caracteres = probablemente base64 corrupto)
                if (imagenOriginal.length > 500) {
                    console.warn('‚ö†Ô∏è URL de imagen muy larga, usando placeholder:', imagenOriginal.substring(0, 50));
                    return 'https://placehold.co/300x300?text=Imagen+no+disponible';
                }
                
                // Si parece un nombre de archivo normal, construir la ruta
                return '/static/uploads/' + imagenOriginal;
            }
            
            container.innerHTML = productos.map(p => `
            
            
                <div class="producto-card" data-producto-id="${p.id}">
                    
                    <img src="${obtenerUrlImagen(p.imagen)}"
                        alt="${p.nombre}"
                        class="producto-imagen"
                        style="cursor: pointer;"
                        onerror="this.src='https://placehold.co/300x300?text=Sin+imagen'"
                        onclick="event.stopPropagation(); abrirModalImagen('${obtenerUrlImagen(p.imagen)}', '${p.nombre}')">
                    <div class="producto-info">
                        <div class="producto-nombre">${p.nombre}</div>
                        <div class="producto-fabricante">${p.fabricante}</div>
                        <div class="producto-presentacion">
                           ${p.concentracion && p.concentracion.toUpperCase() !== 'NONE' ? p.concentracion : ''}
                           ${p.presentacion && p.presentacion.toUpperCase() !== 'NONE' ? p.presentacion : ''}
                        </div>
                        
                        ${p.diagnostico_detectado ? `
                            <div class="producto-diagnostico">
                                ü©∫ Posible diagn√≥stico y/o tratamiento: <strong>${p.diagnostico_detectado}</strong>
                            </div>
                        ` : ''}
                        
                        <div class="producto-precio">$${formatearPrecio(p.precio)}</div>
                        
                        ${p.componente_activo ? `<div style="font-size: 0.85rem; color: #764ba2; font-weight: 500; margin-bottom: 0.5rem;">üíä Principio Activo: ${p.componente_activo}</div>` : ''}
                        
                        ${p.coincidencias > 0 ? `<div style="font-size: 0.85rem; color: #2196F3; font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Trata ${p.coincidencias} de tus s√≠ntomas y/o indicaciones</div>` : ''}
                        
                        ${p.sintomas_filtrados && p.sintomas_filtrados.length > 0 ? `<div style="font-size: 0.85rem; color: #667eea; font-weight: 500; margin-bottom: 0.5rem;">‚úÖ Trata: ${p.sintomas_filtrados.join(', ')}</div>` : ''}
                        
                        <button type="button" id="btn-sintomas-${p.precio_id}" style="font-size: 0.8rem; color: #667eea; background: none; border: none; cursor: pointer; text-decoration: underline; padding: 0; margin-top: 1rem;" onclick="toggleSintomas(${p.precio_id})">
                            ${esBusquedaInteligente ? 'üîº' : 'üîΩ'} ${esBusquedaInteligente ? 'Ocultar' : 'Ver'} s√≠ntomas y/o indicaciones
                        </button>
                        <div id="sintomas-${p.precio_id}" style="display: ${esBusquedaInteligente ? 'block' : 'none'}; font-size: 0.85rem; color: #667eea; font-weight: 500; margin: 0.5rem 0;">
                            ‚úÖ Trata: ${p.sintomas_totales.join(', ')}
                        </div>

                        <div style="margin-bottom: 5.5rem;"></div>
                        <button class="btn-agregar" data-producto='${JSON.stringify(p).replace(/'/g, "&#39;")}' onclick='agregarAlCarritoFromButton(this)'>
                            Comprar
                        </button>
                    </div>
                </div>
            `).join('');

            // Actualizar contador de resultados en filtros
            const contadorResultados = document.getElementById('contador-resultados');
            if (contadorResultados) {
                contadorResultados.textContent = `${productos.length} resultado${productos.length !== 1 ? 's' : ''}`;
            }
        }

        function formatearPrecio(precio) {
            return new Intl.NumberFormat('es-CO').format(precio);
        }
        
        function agregarAlCarritoFromButton(button) {
            try {
                const productoJSON = button.getAttribute('data-producto');
                const producto = JSON.parse(productoJSON);
                agregarAlCarrito(producto);
            } catch (e) {
                console.error('Error al agregar producto:', e);
                alert('Error al agregar el producto. Por favor intenta nuevamente.');
            }
        }

        function agregarAlCarrito(producto) {
            if (!producto.precio || producto.precio <= 0) {
                alert('Este producto no tiene precio disponible');
                return;
            }

            const index = carrito.findIndex(item => item.precio_id === producto.precio_id);

            if (index >= 0) {
                carrito[index].cantidad++;
            } else {
                carrito.push({
                    ...producto,
                    cantidad: 1
                });
            }

            localStorage.setItem('carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();

            alert(`${producto.nombre} (${producto.fabricante}) agregado al carrito`);
        }
        
        function actualizarBadgeCarrito() {
            const total = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            document.getElementById('carritoCount').textContent = total;
        }
        
        // üÜï FUNCIONES DEL PASTILLERO
        async function abrirPastillero() {
            // üÜï Verificar si hay sesi√≥n activa
            let usuarioId = localStorage.getItem('usuario_id');

            // üîÑ Intentar recuperar sesi√≥n del backend ANTES de pedir registro
            try {
                const checkResponse = await fetch('/api/pastillero/count');
                const checkData = await checkResponse.json();

                if (checkData.ok && checkData.count >= 0) {
                    // ‚úÖ Hay sesi√≥n activa en el backend
                    console.log('‚úÖ Sesi√≥n activa en backend, medicamentos:', checkData.count);

                    // Si no tenemos usuario_id en localStorage, intentar recuperarlo
                    if (!usuarioId) {
                        console.log('üîÑ Recuperando datos de usuario del backend...');
                        const recuperada = await recuperarDatosUsuarioDesdeBackend();

                        if (recuperada) {
                            usuarioId = localStorage.getItem('usuario_id');
                        } else {
                            // No se pudo recuperar ‚Üí Mostrar modal de registro
                            console.log('‚ùå No se pudo recuperar usuario, pidiendo registro');
                            mostrarModalRegistro();
                            return;
                        }
                    }
                } else if (checkResponse.status === 401 || !checkData.ok) {
                    // Sesi√≥n expirada o no existe
                    if (usuarioId) {
                        // Intentar restaurar con usuario_id guardado
                        console.log('üîÑ Sesi√≥n expirada, restaurando...');
                        const restaurada = await restaurarSesionAutomatica();

                        if (!restaurada) {
                            console.log('‚ùå No se pudo restaurar sesi√≥n, pidiendo registro');
                            mostrarModalRegistro();
                            return;
                        }
                    } else {
                        // No hay sesi√≥n ni usuario_id ‚Üí Pedir registro
                        console.log('‚ö†Ô∏è No hay sesi√≥n activa, mostrando modal de registro');
                        mostrarModalRegistro();
                        return;
                    }
                }
            } catch (error) {
                console.error('Error al verificar sesi√≥n:', error);
                // Si hay error pero tenemos usuario_id, intentar continuar
                if (!usuarioId) {
                    mostrarModalRegistro();
                    return;
                }
            }

            // ‚úÖ Todo OK ‚Üí Abrir pastillero normalmente
            document.getElementById('modal-pastillero').classList.add('active');

            // üéØ L√ìGICA SIMPLE: Mostrar solo los medicamentos que est√°n tanto en tienda como en pastillero
            if (productosMostradosEnTienda.length > 0) {
                console.log('üìå Abriendo pastillero filtrado por productos mostrados en tienda');
                cargarMedicamentosPastilleroFiltrado();
                modoFiltradoPastillero = true;
            } else {
                console.log('üìã Abriendo pastillero completo (no hay productos en tienda)');
                cargarMedicamentosPastillero();
                modoFiltradoPastillero = false;
            }

            document.getElementById('input-buscar-medicamento').focus();
        }
        
        // üÜï Variable global para el orden actual
        let ordenActualPastillero = 'recientes';
        let modoFiltradoPastillero = false;  // üÜï Para modo filtrado
        
        function cerrarPastillero() {
            document.getElementById('modal-pastillero').classList.remove('active');
            document.getElementById('input-buscar-medicamento').value = '';
            document.getElementById('sugerencias-medicamentos').classList.remove('active');
            modoFiltradoPastillero = false;  // üÜï Reset modo filtrado
        }
        
        function cargarMedicamentosPastillero(orden = null, sintomas = null) {
            // Si no se especifica orden, usar el actual
            if (orden) {
                ordenActualPastillero = orden;
            }
            
            // üÜï Usar POST si hay s√≠ntomas para evitar URL muy larga
            if (sintomas) {
                fetch('/api/pastillero', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orden: ordenActualPastillero,
                        sintomas: sintomas
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        mostrarMedicamentosPastillero(data.medicamentos || [], sintomas);
                    })
                    .catch(err => {
                        console.error('Error al cargar pastillero:', err);
                        document.getElementById('lista-medicamentos-pastillero').innerHTML = `
                            <div class="pastillero-vacio">
                                <div class="pastillero-vacio-icon">‚ö†Ô∏è</div>
                                <p>Error al cargar medicamentos</p>
                            </div>
                        `;
                    });
            } else {
                // Sin s√≠ntomas, usar GET normal
                fetch(`/api/pastillero?orden=${ordenActualPastillero}`)
                    .then(res => res.json())
                    .then(data => {
                        mostrarMedicamentosPastillero(data.medicamentos || [], sintomas);
                    })
                    .catch(err => {
                        console.error('Error al cargar pastillero:', err);
                        document.getElementById('lista-medicamentos-pastillero').innerHTML = `
                            <div class="pastillero-vacio">
                                <div class="pastillero-vacio-icon">‚ö†Ô∏è</div>
                                <p>Error al cargar medicamentos</p>
                            </div>
                        `;
                    });
            }
        }
        
        // üéØ NUEVA FUNCI√ìN SIMPLE: Cargar solo medicamentos que coinciden con la tienda
        function cargarMedicamentosPastilleroFiltrado() {
            console.log('üîç Cargando pastillero filtrado por productos de la tienda');
            
            // 1. Traer TODO el pastillero
            fetch(`/api/pastillero?orden=${ordenActualPastillero}`)
                .then(res => res.json())
                .then(data => {
                    const todosPastillero = data.medicamentos || [];
                    totalMedicamentosPastillero = todosPastillero.length; // üéØ Guardar total
                    console.log('üì¶ Total en pastillero:', todosPastillero.length);
                    console.log('üè™ Total en tienda:', productosMostradosEnTienda.length);
                    
                    // 2. Filtrar solo los que est√°n en la tienda
                    const medicamentosFiltrados = todosPastillero.filter(medicamento => 
                        productosMostradosEnTienda.some(producto => 
                            medicamento.id_medicamento === producto.medicamento_id ||
                            medicamento.medicamento_id === producto.medicamento_id
                        )
                    );
                    
                    console.log('‚úÖ Medicamentos filtrados:', medicamentosFiltrados.length);
                    
                    // 3. Para cada medicamento filtrado, encontrar sus s√≠ntomas desde los productos de la tienda
                    const medicamentosConSintomas = medicamentosFiltrados.map(med => {
                        const productoTienda = productosMostradosEnTienda.find(p => 
                            p.medicamento_id === med.id_medicamento ||
                            p.medicamento_id === med.medicamento_id
                        );
                        
                        return {
                            ...med,
                            sintomas_mostrar: productoTienda ? productoTienda.sintomas_filtrados : []
                        };
                    });
                    
                    // 4. Mostrar con banner verde
                    mostrarMedicamentosPastilleroFiltrado(medicamentosConSintomas);
                })
                .catch(err => {
                    console.error('Error al cargar pastillero filtrado:', err);
                    document.getElementById('lista-medicamentos-pastillero').innerHTML = `
                        <div class="pastillero-vacio">
                            <div class="pastillero-vacio-icon">‚ö†Ô∏è</div>
                            <p>Error al cargar medicamentos</p>
                        </div>
                    `;
                });
        }
        
        function toggleOrdenPastillero() {
            // Alternar entre recientes y alfab√©tico
            const nuevoOrden = ordenActualPastillero === 'recientes' ? 'alfabetico' : 'recientes';
            
            // Actualizar UI del bot√≥n
            const icono = document.getElementById('icono-orden');
            const texto = document.getElementById('texto-orden');
            
            if (nuevoOrden === 'alfabetico') {
                icono.textContent = 'üî§';
                texto.textContent = 'A-Z';
            } else {
                icono.textContent = 'üìÖ';
                texto.textContent = 'Recientes';
            }
            
            // Recargar medicamentos con nuevo orden
            cargarMedicamentosPastillero(nuevoOrden);
        }
        
        function mostrarMedicamentosPastillero(medicamentos, sintomas = null) {
            const lista = document.getElementById('lista-medicamentos-pastillero');
            
            // üÜï Banner de filtro si hay s√≠ntomas
            let bannerFiltro = '';
            if (sintomas) {
                bannerFiltro = `
                    <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #4caf50;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #2e7d32;">üìå Medicamentos para: ${sintomas}</strong>
                                <p style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">${medicamentos.length} coincidencia(s) encontrada(s)</p>
                            </div>
                            <button onclick="verTodosPastillero()" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üìã Ver todos (${totalMedicamentosPastillero || 0})
                            </button>
                        </div>
                    </div>
                `;
            }
            
            if (medicamentos.length === 0) {
                lista.innerHTML = bannerFiltro + `
                    <div class="pastillero-vacio">
                        <div class="pastillero-vacio-icon">üíä</div>
                        <p>${sintomas ? `No tienes medicamentos para "${sintomas}"` : 'Tu pastillero est√° vac√≠o'}</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">${sintomas ? 'Pero puedes buscar en la tienda arriba' : 'Busca un medicamento arriba para agregarlo'}</p>
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = bannerFiltro + medicamentos.map(med => `
                <div class="medicamento-item" data-medicamento-id="${med.id}">
                    <div class="medicamento-header">
                        <div class="medicamento-nombre">${med.nombre}</div>
                        <div class="cantidad-medicamento">${med.cantidad} ${med.unidad}</div>
                    </div>
                    <div class="medicamento-acciones">
                        <button class="btn-medicamento btn-tome" onclick="tomarMedicamento(${med.id})">
                            Tom√© (‚àí1)
                        </button>
                        <button class="btn-medicamento btn-agregar-cantidad" onclick="agregarCantidad(${med.id})">
                            Agregar (+)
                        </button>
                        <button class="btn-medicamento btn-recordatorio ${med.recordatorio_activo ? 'activo' : ''}"
                                onclick="toggleRecordatorio(${med.id}, '${med.nombre.replace(/'/g, "\\'")}', ${med.recordatorio_activo || false})"
                                title="${med.recordatorio_activo ? 'Recordatorio activo' : 'Activar recordatorio'}">
                            ${med.recordatorio_activo ? '‚è∞ ON' : '‚è∞'}
                        </button>
                        ${med.sintomas && med.sintomas.length > 0 && med.sintomas[0] !== '' ? `
                            <button class="btn-medicamento btn-ver-sintomas" onclick="toggleSintomasPastillero(${med.medicamento_id})">
                                ¬øPara qu√© sirve?
                            </button>
                        ` : ''}
                    </div>
                    ${med.sintomas && med.sintomas.length > 0 && med.sintomas[0] !== '' ? `
                        <div id="sintomas-${med.medicamento_id}" class="medicamento-sintomas">
                            <h4>Ayuda con:</h4>
                            <div class="sintomas-lista">
                                ${med.sintomas.map(s => `<span class="sintoma-tag">${s}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // üéØ NUEVA FUNCI√ìN: Mostrar medicamentos filtrados con banner verde y s√≠ntomas
        function mostrarMedicamentosPastilleroFiltrado(medicamentos) {
            const lista = document.getElementById('lista-medicamentos-pastillero');
            
            // Crear lista de s√≠ntomas √∫nicos de todos los productos mostrados en tienda
            const sintomasUnicos = [...new Set(
                productosMostradosEnTienda.flatMap(p => p.sintomas_filtrados || [])
            )].join(', ');
            
            // Banner verde mostrando los s√≠ntomas
            const bannerFiltro = `
                <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #2e7d32;">üìå Medicamentos para: ${sintomasUnicos || 's√≠ntomas detectados'}</strong>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">${medicamentos.length} de los productos mostrados est√°n en tu pastillero</p>
                        </div>
                        <button onclick="verTodosPastillero()" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üìã Ver todos (${totalMedicamentosPastillero || '...'})
                        </button>
                    </div>
                </div>
            `;
            
            if (medicamentos.length === 0) {
                lista.innerHTML = bannerFiltro + `
                    <div class="pastillero-vacio">
                        <div class="pastillero-vacio-icon">üíä</div>
                        <p>Ninguno de los productos mostrados est√° en tu pastillero</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Pero puedes ver todos tus medicamentos haciendo clic en "Ver todos"</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar medicamentos con sus s√≠ntomas espec√≠ficos
            lista.innerHTML = bannerFiltro + medicamentos.map(med => `
                <div class="medicamento-item" data-medicamento-id="${med.id}">
                    <div class="medicamento-header">
                        <div class="medicamento-nombre">${med.nombre}</div>
                        <div class="cantidad-medicamento">${med.cantidad} ${med.unidad}</div>
                    </div>
                    
                    ${med.sintomas_mostrar && med.sintomas_mostrar.length > 0 ? `
                        <div style="background: #f0f8ff; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0; font-size: 0.85rem;">
                            <strong style="color: #667eea;">‚úÖ Sirve para:</strong> ${med.sintomas_mostrar.join(', ')}
                        </div>
                    ` : ''}
                    
                    <div class="medicamento-acciones">
                        <button class="btn-medicamento btn-tome" onclick="tomarMedicamento(${med.id})">
                            Tom√© (‚àí1)
                        </button>
                        <button class="btn-medicamento btn-agregar-cantidad" onclick="agregarCantidad(${med.id})">
                            Agregar (+)
                        </button>
                        <button class="btn-medicamento btn-recordatorio ${med.recordatorio_activo ? 'activo' : ''}"
                                onclick="toggleRecordatorio(${med.id}, '${med.nombre.replace(/'/g, "\\'")}', ${med.recordatorio_activo || false})"
                                title="${med.recordatorio_activo ? 'Recordatorio activo' : 'Activar recordatorio'}">
                            ${med.recordatorio_activo ? '‚è∞ ON' : '‚è∞'}
                        </button>
                        ${med.sintomas && med.sintomas.length > 0 && med.sintomas[0] !== '' ? `
                            <button class="btn-medicamento btn-ver-sintomas" onclick="toggleSintomasPastillero(${med.medicamento_id})">
                                Ver todos los s√≠ntomas
                            </button>
                        ` : ''}
                    </div>
                    ${med.sintomas && med.sintomas.length > 0 && med.sintomas[0] !== '' ? `
                        <div id="sintomas-${med.medicamento_id}" class="medicamento-sintomas">
                            <h4>Todos los s√≠ntomas que trata:</h4>
                            <div class="sintomas-lista">
                                ${med.sintomas.map(s => `<span class="sintoma-tag">${s}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Funci√≥n separada para toggle de s√≠ntomas en pastillero (evitar conflicto con tienda)
        function toggleSintomasPastillero(medicamentoId) {
            const sintomasDiv = document.getElementById(`sintomas-${medicamentoId}`);
            if (sintomasDiv) {
                sintomasDiv.classList.toggle('visible');
            }
        }
        
        // üÜï Variable para guardar el total de medicamentos
        let totalMedicamentosPastillero = 0;
        
        // üÜï Funci√≥n para ver todos los medicamentos (quitar filtro)
        function verTodosPastillero() {
            modoFiltradoPastillero = false;
            cargarMedicamentosPastillero();  // Cargar sin filtro
        }
        
        function toggleSintomas(medicamentoId) {
            const sintomasDiv = document.getElementById(`sintomas-${medicamentoId}`);
            if (sintomasDiv) {
                sintomasDiv.classList.toggle('visible');
            } else {
                console.error(`No se encontr√≥ elemento con ID: sintomas-${medicamentoId}`);
            }
        }
        
        function tomarMedicamento(medicamentoId) {
            fetch(`/api/pastillero/${medicamentoId}/tomar`, {
                method: 'POST'
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    // Actualizar solo la cantidad en el DOM sin reordenar
                    const cantidadElement = document.querySelector(`[data-medicamento-id="${medicamentoId}"] .cantidad-medicamento`);
                    if (cantidadElement && data.nueva_cantidad !== undefined) {
                        cantidadElement.textContent = `${data.nueva_cantidad} ${data.unidad || 'unidades'}`;
                    }
                    actualizarBadgePastillero();
                } else {
                    alert(data.error || 'Error al actualizar');
                }
            })
            .catch(err => console.error('Error:', err));
        }
        
        function agregarCantidad(medicamentoId) {
            const cantidad = prompt('¬øCu√°ntas unidades agregar?', '1');
            if (!cantidad) return;

            fetch(`/api/pastillero/${medicamentoId}/agregar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cantidad: parseInt(cantidad) })
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    // Actualizar solo la cantidad en el DOM sin reordenar
                    const cantidadElement = document.querySelector(`[data-medicamento-id="${medicamentoId}"] .cantidad-medicamento`);
                    if (cantidadElement && data.nueva_cantidad !== undefined) {
                        cantidadElement.textContent = `${data.nueva_cantidad} ${data.unidad || 'unidades'}`;
                    }
                    actualizarBadgePastillero();
                } else {
                    alert(data.error || 'Error al actualizar');
                }
            })
            .catch(err => console.error('Error:', err));
        }
        
        // B√∫squeda y autocompletado
        let timeoutBusqueda;
        let sugerenciaActiva = -1; // √çndice de la sugerencia seleccionada
        
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('input-buscar-medicamento');
            const sugerencias = document.getElementById('sugerencias-medicamentos');
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(timeoutBusqueda);
                sugerenciaActiva = -1; // Reset al escribir
                
                if (query.length < 2) {
                    sugerencias.classList.remove('active');
                    return;
                }
                
                timeoutBusqueda = setTimeout(() => {
                    buscarMedicamentosParaPastillero(query);
                }, 300);
            });
            
            input.addEventListener('keydown', function(e) {
                const items = sugerencias.querySelectorAll('.sugerencia-item');
                const haysugerencias = sugerencias.classList.contains('active') && items.length > 0;
                
                // Flecha ABAJO
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (haysugerencias) {
                        sugerenciaActiva = (sugerenciaActiva + 1) % items.length;
                        resaltarSugerencia(items, sugerenciaActiva);
                    }
                }
                
                // Flecha ARRIBA
                else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (haysugerencias) {
                        sugerenciaActiva = (sugerenciaActiva - 1 + items.length) % items.length;
                        resaltarSugerencia(items, sugerenciaActiva);
                    }
                }
                
                // ENTER
                else if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    if (haysugerencias && sugerenciaActiva >= 0) {
                        // Seleccionar la sugerencia resaltada
                        items[sugerenciaActiva].click();
                    } else {
                        // Crear medicamento nuevo
                        const query = this.value.trim();
                        if (query) {
                            crearMedicamentoNuevo(query);
                        }
                    }
                }
                
                // ESC
                else if (e.key === 'Escape') {
                    sugerencias.classList.remove('active');
                    sugerenciaActiva = -1;
                }
            });
            
            // Cerrar sugerencias al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !sugerencias.contains(e.target)) {
                    sugerencias.classList.remove('active');
                    sugerenciaActiva = -1;
                }
            });
        });
        
        function resaltarSugerencia(items, indice) {
            // Quitar resaltado de todas
            items.forEach(item => item.classList.remove('sugerencia-activa'));
            
            // Resaltar la actual
            if (indice >= 0 && indice < items.length) {
                items[indice].classList.add('sugerencia-activa');
                items[indice].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }
        
        function buscarMedicamentosParaPastillero(query) {
            fetch(`/api/productos/buscar?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    mostrarSugerenciasMedicamentos(data.productos || []);
                })
                .catch(err => console.error('Error al buscar:', err));
        }
        
        function mostrarSugerenciasMedicamentos(productos) {
            const sugerencias = document.getElementById('sugerencias-medicamentos');
            
            if (productos.length === 0) {
                sugerencias.innerHTML = `
                    <div class="sugerencia-item" style="color: #999;">
                        No se encontraron medicamentos. Presiona Enter para crear uno nuevo.
                    </div>
                `;
                sugerencias.classList.add('active');
                return;
            }
            
            sugerencias.innerHTML = productos.slice(0, 5).map(prod => {
                // üÜï Determinar si es medicamento personal (NULL)
                const esPersonal = prod.es_personal || prod.medicamento_id === null;
                const badge = esPersonal ? '<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">üìã Personal</span>' : '';
                
                // Para onclick, si es NULL pasar como string 'null', sino el ID
                const idParam = esPersonal ? 'null' : prod.medicamento_id;
                
                return `
                    <div class="sugerencia-item" onclick="seleccionarMedicamento(${idParam}, '${prod.nombre.replace(/'/g, "\\'")}')">
                        <strong>${prod.nombre}</strong>${badge}
                    </div>
                `;
            }).join('');
            
            sugerencias.classList.add('active');
        }
        
        function seleccionarMedicamento(medicamentoId, nombre) {
            // Convertir 'null' string a null real
            if (medicamentoId === 'null' || medicamentoId === null) {
                medicamentoId = null;
            }
            
            // üÜï Primero verificar si ya existe en el pastillero
            // Para medicamentos personales (null), no verificamos porque ya est√°n en el pastillero
            if (medicamentoId === null) {
                // Es un medicamento personal, preguntar cantidad directamente
                const cantidad = prompt(`Ya tienes "${nombre}" en tu pastillero.\n¬øCu√°ntas M√ÅS quieres agregar?`, '10');
                if (!cantidad) return;
                
                // Agregar al pastillero (sumar√° a lo existente)
                fetch('/api/pastillero/agregar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medicamento_id: null,
                        nombre: nombre,
                        cantidad: parseInt(cantidad),
                        unidad: 'pastillas'  // Usar unidad por defecto
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        document.getElementById('input-buscar-medicamento').value = '';
                        document.getElementById('sugerencias-medicamentos').classList.remove('active');
                        cargarMedicamentosPastillero();
                        actualizarBadgePastillero();
                        document.getElementById('input-buscar-medicamento').focus();
                    } else {
                        alert(data.error || 'Error al agregar');
                    }
                })
                .catch(err => console.error('Error:', err));
                return;
            }
            
            // Para medicamentos oficiales, verificar si existe
            fetch(`/api/pastillero/verificar/${medicamentoId}`)
                .then(res => res.json())
                .then(data => {
                    let mensajeCantidad, mensajeUnidad;
                    
                    if (data.existe) {
                        // Ya existe - mostrar info actual
                        mensajeCantidad = `Ya tienes ${data.cantidad} ${data.unidad} de ${nombre}.\n¬øCu√°ntas M√ÅS quieres agregar?`;
                        mensajeUnidad = data.unidad; // Usar la misma unidad
                    } else {
                        // No existe - mensaje normal
                        mensajeCantidad = `¬øCu√°ntas unidades de ${nombre} tienes?`;
                        mensajeUnidad = null;
                    }
                    
                    const cantidad = prompt(mensajeCantidad, '10');
                    if (!cantidad) return;
                    
                    // Solo pedir unidad si es nuevo medicamento
                    let unidad;
                    if (mensajeUnidad) {
                        unidad = mensajeUnidad;
                    } else {
                        unidad = prompt('Unidad de medida:', 'pastillas');
                        if (!unidad) return;
                    }
                    
                    // Agregar al pastillero
                    fetch('/api/pastillero/agregar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            medicamento_id: medicamentoId,
                            nombre: nombre,  // üÜï Enviar nombre tambi√©n
                            cantidad: parseInt(cantidad),
                            unidad: unidad
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.ok) {
                            document.getElementById('input-buscar-medicamento').value = '';
                            document.getElementById('sugerencias-medicamentos').classList.remove('active');
                            cargarMedicamentosPastillero();
                            actualizarBadgePastillero();
                            // üÜï Volver el foco al input para seguir agregando
                            document.getElementById('input-buscar-medicamento').focus();
                        } else {
                            alert(data.error || 'Error al agregar');
                        }
                    })
                    .catch(err => console.error('Error:', err));
                })
                .catch(err => {
                    console.error('Error al verificar:', err);
                    // Si falla la verificaci√≥n, continuar con flujo normal
                    const cantidad = prompt(`¬øCu√°ntas unidades de ${nombre} tienes?`, '10');
                    if (!cantidad) return;
                    
                    const unidad = prompt('Unidad de medida:', 'pastillas');
                    if (!unidad) return;
                    
                    fetch('/api/pastillero/agregar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            medicamento_id: medicamentoId,
                            nombre: nombre,
                            cantidad: parseInt(cantidad),
                            unidad: unidad
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.ok) {
                            document.getElementById('input-buscar-medicamento').value = '';
                            document.getElementById('sugerencias-medicamentos').classList.remove('active');
                            cargarMedicamentosPastillero();
                            actualizarBadgePastillero();
                            document.getElementById('input-buscar-medicamento').focus();
                        } else {
                            alert(data.error || 'Error al agregar');
                        }
                    })
                    .catch(err => console.error('Error:', err));
                });
        }
        
        function crearMedicamentoNuevo(nombre) {
            const cantidad = prompt(`¬øCu√°ntas unidades de "${nombre}" tienes?`, '10');
            if (!cantidad) return;
            
            const unidad = prompt('Unidad de medida:', 'pastillas');
            if (!unidad) return;
            
            fetch('/api/pastillero/crear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre: nombre,
                    cantidad: parseInt(cantidad),
                    unidad: unidad
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('Medicamento agregado. Se notificar√° al administrador para completar la informaci√≥n.');
                    document.getElementById('input-buscar-medicamento').value = '';
                    document.getElementById('sugerencias-medicamentos').classList.remove('active');
                    cargarMedicamentosPastillero();
                    actualizarBadgePastillero();
                    // üÜï Volver el foco al input para seguir agregando
                    document.getElementById('input-buscar-medicamento').focus();
                } else {
                    alert(data.error || 'Error al crear medicamento');
                }
            })
            .catch(err => console.error('Error:', err));
        }
        
        function actualizarBadgePastillero() {
            fetch('/api/pastillero/count')
                .then(res => res.json())
                .then(data => {
                    const count = data.count || 0;
                    totalMedicamentosPastillero = count;  // üÜï Guardar total global
                    document.getElementById('pastilleroCount').textContent = count;
                })
                .catch(err => console.error('Error al actualizar pastillero:', err));
        }
        
        // Actualizar contador del pastillero al cargar
        document.addEventListener('DOMContentLoaded', function() {
            actualizarBadgePastillero();
        });
        
        // üîç FUNCI√ìN DEBUG: Mostrar JSON de comparaci√≥n tienda vs pastillero
        function mostrarDebugJSON() {
            console.log('üîç Generando JSON de debug...');
            console.log('üîç productosMostradosEnTienda existe?', typeof productosMostradosEnTienda);
            console.log('üîç productosMostradosEnTienda.length:', productosMostradosEnTienda ? productosMostradosEnTienda.length : 'undefined');
            console.log('üîç productosMostradosEnTienda contenido:', productosMostradosEnTienda);
            
            // Si est√° vac√≠o, intentar obtenerlo del DOM
            if (!productosMostradosEnTienda || productosMostradosEnTienda.length === 0) {
                alert('‚ö†Ô∏è No hay productos en tienda. Primero busca algo (ej: "me duele") y luego haz clic en DEBUG.');
                return;
            }
            
            // Primero obtener el pastillero
            fetch('/api/pastillero')
                .then(res => res.json())
                .then(data => {
                    const medicamentosPastillero = data.medicamentos || [];
                    
                    const debugInfo = {
                        fecha_hora: new Date().toLocaleString('es-CO'),
                        productos_en_tienda: productosMostradosEnTienda.length,
                        medicamentos_en_pastillero: medicamentosPastillero.length,
                        
                        // Productos de la tienda con TODOS sus IDs
                        tienda: productosMostradosEnTienda.map(p => ({
                            nombre: p.nombre,
                            id: p.id,
                            precio_id: p.precio_id,
                            medicamento_id: p.medicamento_id,
                            sintomas_filtrados: p.sintomas_filtrados
                        })),
                        
                        // Medicamentos del pastillero con TODOS sus IDs
                        pastillero: medicamentosPastillero.map(m => ({
                            nombre: m.nombre,
                            id: m.id,
                            id_medicamento: m.id_medicamento,
                            medicamento_id: m.medicamento_id,
                            cantidad: m.cantidad,
                            unidad: m.unidad
                        }))
                    };
                    
                    // Crear modal con el JSON
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.9);
                        z-index: 99999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 2rem;
                    `;
                    
                    const jsonStr = JSON.stringify(debugInfo, null, 2);
                    
                    modal.innerHTML = `
                        <div style="
                            background: #1e1e1e;
                            color: #d4d4d4;
                            padding: 2rem;
                            border-radius: 10px;
                            max-width: 90%;
                            max-height: 90%;
                            overflow: auto;
                            font-family: 'Courier New', monospace;
                        ">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <h2 style="color: #e74c3c; margin: 0;">üîç DEBUG - Comparaci√≥n Tienda vs Pastillero</h2>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                        style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">
                                    Cerrar
                                </button>
                            </div>
                            <button onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent); alert('JSON copiado al portapapeles!')"
                                    style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-bottom: 1rem;">
                                üìã Copiar JSON
                            </button>
                            <pre style="
                                background: #2d2d2d;
                                padding: 1.5rem;
                                border-radius: 5px;
                                overflow: auto;
                                max-height: 70vh;
                                font-size: 0.9rem;
                                line-height: 1.5;
                            ">${jsonStr}</pre>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Tambi√©n hacer console.log
                    console.log('üîç DEBUG JSON:', debugInfo);
                })
                .catch(err => {
                    console.error('Error al obtener pastillero:', err);
                    alert('Error al generar DEBUG: ' + err.message);
                });
        }
        
        function verCarrito() {
            window.location.href = '/tienda/carrito';
        }

        function toggleSintomas(precioId) {
            const div = document.getElementById(`sintomas-${precioId}`);
            const btn = document.getElementById(`btn-sintomas-${precioId}`);
            
            // üÜï Validar que los elementos existen antes de manipularlos
            if (!div || !btn) {
                console.warn('‚ö†Ô∏è Elementos no encontrados para precioId:', precioId);
                return;
            }
            
            if (div.style.display === 'none') {
                div.style.display = 'block';
                btn.innerHTML = 'üîº Ocultar s√≠ntomas y/o indicaciones';
            } else {
                div.style.display = 'none';
                btn.innerHTML = 'üîΩ Ver s√≠ntomas y/o indicaciones';
            }
        }

        // üÜï MODAL COMPLETO DEL PRODUCTO

        function abrirModalImagen(imagenSrc, nombreProducto) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
            `;
            
            const contenido = document.createElement('div');
            contenido.style.cssText = `
                position: relative;
                background: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 600px;
                max-height: 80vh;
                overflow: auto;
            `;
            
            contenido.innerHTML = `
                <img src="${imagenSrc}" alt="${nombreProducto}" style="width: 100%; border-radius: 8px;">
                <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px;">‚úï</button>
            `;
            
            modal.appendChild(contenido);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        // üÜï L√ìGICA DEL TOGGLE DE COLUMNAS
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('toggleDosColumnas');
            const container = document.getElementById('productosContainer');
            
            // Cargar preferencia guardada
            const dosColumnasGuardada = localStorage.getItem('productosDosColunas') === 'true';
            toggle.checked = dosColumnasGuardada;
            
            if (dosColumnasGuardada && window.innerWidth < 768) {
                container.classList.add('dos-columnas');
            }
            
            // Manejar cambios
            toggle.addEventListener('change', function() {
                localStorage.setItem('productosDosColunas', this.checked);
                
                if (this.checked) {
                    container.classList.add('dos-columnas');
                } else {
                    container.classList.remove('dos-columnas');
                }
            });
        });
        
        // üÜï BOT√ìN VOLVER ARRIBA FLOTANTE
        const scrollButton = document.createElement('button');
        scrollButton.id = 'scrollToTop';
        scrollButton.innerHTML = '‚¨ÜÔ∏è Arriba';
        scrollButton.style.cssText = `
            position: fixed;
            bottom: 40px;
            left: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.8rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            display: none;
            z-index: 999;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        `;
        
        scrollButton.addEventListener('mouseover', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.6)';
        });
        
        scrollButton.addEventListener('mouseout', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
        });
        
        scrollButton.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        document.body.appendChild(scrollButton);
        
        // Control de visibilidad del carrito y pastillero flotantes seg√∫n header
        const carritoFlotante = document.querySelector('.carrito-flotante');
        const pastilleroFlotante = document.querySelector('.pastillero-flotante');
        const header = document.querySelector('.header');

        window.addEventListener('scroll', function() {
            // Bot√≥n scroll to top
            if (window.scrollY > 300) {
                scrollButton.style.display = 'block';
            } else {
                scrollButton.style.display = 'none';
            }

            // Carrito y Pastillero flotantes: mostrar cuando header desaparece
            if (header) {
                const headerRect = header.getBoundingClientRect();
                // Si el header est√° fuera de la vista (arriba)
                if (headerRect.bottom < 0) {
                    carritoFlotante.classList.add('visible');
                    pastilleroFlotante.classList.add('visible');
                } else {
                    carritoFlotante.classList.remove('visible');
                    pastilleroFlotante.classList.remove('visible');
                }
            }
        });



        // ============================================
        // üÜï FUNCIONES PARA SOLICITUDES ESPECIALES
        // ============================================
        
        function esProductoEspecifico(texto) {
            /**
             * Detecta si la b√∫squeda es un producto espec√≠fico o s√≠ntomas/necesidades
             * Retorna: true = producto, false = s√≠ntomas
             */
            if (!texto || texto.length < 3) return false;
            
            const textoLower = texto.toLowerCase().trim();
            const palabras = textoLower.split(/\s+/);
            
            // Palabras que indican S√çNTOMAS (no producto)
            const indicadoresSintomas = [
                'me', 'tengo', 'siento', 'duele', 'dolor', 'arde', 'ardor',
                'pica', 'picaz√≥n', 'molesta', 'siento', 'estoy', 'sufro',
                'padezco', 'presento', 'ten√≠a', 'sent√≠a'
            ];
            
            // Si tiene palabras de s√≠ntomas = NO es producto
            const tieneSintomas = palabras.some(p => indicadoresSintomas.includes(p));
            if (tieneSintomas) return false;
            
            // Si es muy largo (m√°s de 6 palabras) = probablemente s√≠ntomas
            if (palabras.length > 6) return false;
            
            // Patrones que indican PRODUCTO espec√≠fico
            const patronesProducto = [
                /\d+\s*(mg|ml|g|mcg|ui)/i,  // Tiene dosis: 500mg, 20ml
                /(forte|plus|max|extra|duo|triple)/i,  // Sufijos comerciales
                /(mk|bayer|genfar|tecnoquimicas|lafrancol)/i,  // Laboratorios
                /^[a-z]+(\s+[a-z]+){0,2}$/i  // 1-3 palabras simples
            ];
            
            const esProducto = patronesProducto.some(patron => patron.test(textoLower));
            if (esProducto) return true;
            
            // Por defecto: si es corto (1-3 palabras) = producto
            return palabras.length <= 3;
        }
        
        function abrirModalTelefono(busqueda, tipo) {
            /**
             * Abre modal para capturar tel√©fono del cliente
             * @param {string} busqueda - Lo que busc√≥ el cliente
             * @param {string} tipo - 'producto' o 'sintoma'
             */
            const modal = document.createElement('div');
            modal.id = 'modalSolicitudEspecial';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 1rem;
            `;
            
            const emoji = tipo === 'producto' ? 'üíä' : 'ü©∫';
            const titulo = tipo === 'producto' ? 'Verificar disponibilidad' : 'Asesor√≠a personalizada';
            const colorBoton = tipo === 'producto' ? '#2196F3' : '#2196F3';
            const colorBotonHover = tipo === 'producto' ? '#1976D2' : '#1976D2';
            
            const contenido = document.createElement('div');
            contenido.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 2rem;
                max-width: 450px;
                width: 100%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            contenido.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${emoji}</div>
                    <h2 style="color: #333; margin-bottom: 0.5rem; font-size: 1.5rem;">${titulo}</h2>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.5;">
                        Para confirmar disponibilidad inmediata,<br>necesitamos tu n√∫mero de contacto
                    </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Buscaste:</div>
                    <div style="font-weight: 600; color: #333;">"${busqueda}"</div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 600; color: #555; margin-bottom: 0.5rem;">
                        Tel√©fono celular üì± <span style="color: #e74c3c;">*</span>
                    </label>
                    <input 
                        type="tel" 
                        id="telefonoSolicitud"
                        placeholder="300 123 4567"
                        maxlength="12"
                        style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 1.1rem;
                            text-align: center;
                            letter-spacing: 1px;
                            transition: border-color 0.3s;
                        "
                        oninput="formatearTelefono(this)"
                        onkeypress="if(event.key === 'Enter') enviarSolicitudEspecial('${busqueda}', '${tipo}')"
                    >
                    <div id="errorTelefono" style="color: #e74c3c; font-size: 0.85rem; margin-top: 0.5rem; display: none;"></div>
                    <div style="color: #999; font-size: 0.8rem; margin-top: 0.5rem; text-align: center;">
                        Ejemplo: 300 123 4567 (10 d√≠gitos)
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p style="font-size: 0.85rem; color: #666; line-height: 1.5; text-align: center;">
                        ‚è±Ô∏è Te contactaremos en <strong>menos de 5 minutos</strong> para confirmar disponibilidad y precio
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button 
                        onclick="document.getElementById('modalSolicitudEspecial').remove()"
                        style="
                            flex: 1;
                            padding: 0.9rem;
                            background: #e0e0e0;
                            color: #666;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.3s;
                        "
                        onmouseover="this.style.background='#d0d0d0'"
                        onmouseout="this.style.background='#e0e0e0'">
                        Cancelar
                    </button>
                    <button 
                        onclick="enviarSolicitudEspecial('${busqueda.replace(/'/g, "\\'")}', '${tipo}')"
                        style="
                            flex: 2;
                            padding: 0.9rem;
                            background: ${colorBoton};
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.3s;
                        "
                        onmouseover="this.style.background='${colorBotonHover}'"
                        onmouseout="this.style.background='${colorBoton}'">
                        ‚úÖ Enviar solicitud
                    </button>
                </div>
            `;
            
            modal.appendChild(contenido);
            document.body.appendChild(modal);
            
            // Cerrar con ESC
            document.addEventListener('keydown', function cerrarConEsc(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', cerrarConEsc);
                }
            });
            
            // Cerrar al hacer click fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Focus en el input
            setTimeout(() => {
                document.getElementById('telefonoSolicitud').focus();
            }, 100);
        }
        
        function formatearTelefono(input) {
            /**
             * Formatea el tel√©fono mientras escribe: 300 123 4567
             * Solo permite n√∫meros y auto-formatea con espacios
             */
            let valor = input.value.replace(/\D/g, ''); // Solo n√∫meros
            
            // Limitar a 10 d√≠gitos
            if (valor.length > 10) {
                valor = valor.substring(0, 10);
            }
            
            // Formatear: 300 123 4567
            if (valor.length > 6) {
                valor = valor.substring(0, 3) + ' ' + valor.substring(3, 6) + ' ' + valor.substring(6);
            } else if (valor.length > 3) {
                valor = valor.substring(0, 3) + ' ' + valor.substring(3);
            }
            
            input.value = valor;
            
            // Cambiar borde a azul si est√° completo
            const soloNumeros = valor.replace(/\s/g, '');
            if (soloNumeros.length === 10 && soloNumeros.startsWith('3')) {
                input.style.borderColor = '#2196F3';
            } else {
                input.style.borderColor = '#e0e0e0';
            }
        }
        
        function validarTelefono(telefono) {
            /**
             * Valida que el tel√©fono sea correcto
             * @returns {object} {valido: boolean, error: string}
             */
            const soloNumeros = telefono.replace(/\s/g, '');
            
            if (!soloNumeros) {
                return {valido: false, error: 'El tel√©fono es obligatorio'};
            }
            
            if (soloNumeros.length !== 10) {
                return {valido: false, error: 'Debe tener exactamente 10 d√≠gitos'};
            }
            
            if (!soloNumeros.startsWith('3')) {
                return {valido: false, error: 'Debe ser un celular (iniciar con 3)'};
            }
            
            return {valido: true, error: ''};
        }
        
        function enviarSolicitudEspecial(busqueda, tipo) {
            /**
             * Env√≠a la solicitud especial al backend
             */
            const input = document.getElementById('telefonoSolicitud');
            const errorDiv = document.getElementById('errorTelefono');
            const telefono = input.value;
            
            // Validar
            const validacion = validarTelefono(telefono);
            if (!validacion.valido) {
                errorDiv.textContent = '‚ùå ' + validacion.error;
                errorDiv.style.display = 'block';
                input.style.borderColor = '#e74c3c';
                input.focus();
                return;
            }
            
            // Limpiar error
            errorDiv.style.display = 'none';
            
            // Tel√©fono sin espacios para enviar
            const telefonoLimpio = telefono.replace(/\s/g, '');
            
            // Deshabilitar bot√≥n mientras env√≠a
            const btnEnviar = event.target;
            const textoOriginal = btnEnviar.innerHTML;
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '‚è≥ Enviando...';
            btnEnviar.style.opacity = '0.6';
            
            // Enviar a Flask
            fetch('/tienda/solicitud_especial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    telefono: telefonoLimpio,
                    busqueda: busqueda,
                    tipo: tipo
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    // Cerrar modal
                    document.getElementById('modalSolicitudEspecial').remove();
                    
                    // Mostrar confirmaci√≥n
                    mostrarConfirmacionSolicitud(data.mensaje, tipo);
                } else {
                    errorDiv.textContent = '‚ùå ' + (data.error || 'Error al enviar solicitud');
                    errorDiv.style.display = 'block';
                    btnEnviar.disabled = false;
                    btnEnviar.innerHTML = textoOriginal;
                    btnEnviar.style.opacity = '1';
                }
            })
            .catch(err => {
                console.error('Error:', err);
                errorDiv.textContent = '‚ùå Error de conexi√≥n. Intenta nuevamente';
                errorDiv.style.display = 'block';
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = textoOriginal;
                btnEnviar.style.opacity = '1';
            });
        }
        
        function mostrarConfirmacionSolicitud(mensaje, tipo) {
            /**
             * Muestra confirmaci√≥n visual despu√©s de enviar solicitud
             */
            const emoji = tipo === 'producto' ? 'üíä' : 'ü©∫';
            const color = tipo === 'producto' ? '#2196F3' : '#2196F3';
            
            const confirmacion = document.createElement('div');
            confirmacion.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 2.5rem;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
                max-width: 400px;
                animation: aparecer 0.3s ease-out;
            `;
            
            confirmacion.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 1rem;">${emoji}</div>
                <div style="font-size: 3rem; color: #2196F3; margin-bottom: 1rem;">‚úÖ</div>
                <h3 style="color: ${color}; margin-bottom: 1rem; font-size: 1.4rem;">¬°Solicitud recibida!</h3>
                <p style="color: #666; line-height: 1.6; margin-bottom: 1.5rem;">
                    ${mensaje}
                </p>
                <button 
                    onclick="this.parentElement.remove()"
                    style="
                        padding: 0.9rem 2rem;
                        background: ${color};
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                    ">
                    Entendido
                </button>
            `;
            
            document.body.appendChild(confirmacion);
            
            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                if (confirmacion.parentElement) {
                    confirmacion.remove();
                }
            }, 5000);
        }
        
        // Agregar animaci√≥n
        if (!document.getElementById('animacion-solicitud')) {
            const style = document.createElement('style');
            style.id = 'animacion-solicitud';
            style.textContent = `
                @keyframes aparecer {
                    from { 
                        opacity: 0;
                        transform: translate(-50%, -50%) scale(0.9);
                    }
                    to { 
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1);
                    }
                }
            `;
            document.head.appendChild(style);
        }



        <!-- üîí Sistema de acceso oculto y reporte interno -->
        
        document.addEventListener('DOMContentLoaded', () => {
            // üîç DEBUGGING: Verificar sistema de pastillero
            console.group('üöÄ INICIALIZACI√ìN SISTEMA PASTILLERO');

            const btnPastillero = document.getElementById('pastillero-flotante');
            console.log('üéØ Bot√≥n pastillero encontrado:', btnPastillero);

            if (!btnPastillero) {
                console.error('‚ùå CR√çTICO: Bot√≥n pastillero-flotante NO encontrado');
                console.log('Botones disponibles con "pastillero":',
                    Array.from(document.querySelectorAll('button, div'))
                        .filter(el => el.id && el.id.includes('pastillero'))
                        .map(el => ({ id: el.id, text: el.textContent.trim() }))
                );
            } else {
                console.log('‚úÖ Bot√≥n OK - ID:', btnPastillero.id);
                console.log('‚úÖ Bot√≥n OK - Clases:', btnPastillero.className);
            }
            
            // Verificar funciones disponibles
            console.log('Funciones disponibles:', {
                verificarMedicamentosPastillero: typeof verificarMedicamentosPastillero,
                desactivarAnimacionPastillero: typeof desactivarAnimacionPastillero,
                buscarProductos: typeof buscarProductos
            });
            
            console.groupEnd();

            // 1. A√±adir listener al h1 "MAS QUE MEDICAMENTOS" para activar reporte (solo para administradores)
            const esAdmin = {{ 'true' if es_admin else 'false' }};
            const tituloTienda = document.querySelector('.container h1');
            if (tituloTienda && esAdmin) { // Solo para usuarios con rol Administrador
                let intentos = 0;
                tituloTienda.addEventListener('click', () => {
                    intentos++;
                    if (intentos < 3) return; // Requiere 3 clics r√°pidos
                    intentos = 0;

                    const claveSecreta = prompt("üîê Clave de acceso:");
                    if (claveSecreta === "admin123") {
                        mostrarReporteInterno();
                    }
                });
            }
        });

        function mostrarReporteInterno() {
            // Buscar datos ya cargados (asumiendo que ya se llam√≥ a buscarProductos)
            const productos = window.ultimosProductos || [];
            const data = window.ultimosProductosData || {};

            const total = productos.length;
            const sinSintomas = productos.filter(p =>
                !p.sintomas_totales || p.sintomas_totales.length === 0
            ).length;

            const totalDisponible = data.total_disponible || total;
            const hayLimite = data.hay_limite || false;

            const mensajeLimite = hayLimite
                ? `<p style="color: #e67e22; margin-top: 1rem;"><strong>‚ö†Ô∏è L√≠mite aplicado:</strong> Se limit√≥ a 50 productos de ${totalDisponible} disponibles</p>`
                : totalDisponible > total
                ? `<p style="color: #3498db; margin-top: 1rem;"><strong>‚ÑπÔ∏è Total disponible:</strong> ${totalDisponible} productos (mostrando ${total} por filtros)</p>`
                : '';

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                font-family: monospace;
            `;
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 0 30px rgba(0,0,0,0.6);
                ">
                    <h3 style="color: #e74c3c; margin-bottom: 1.5rem;">üîí Reporte Interno (Solo Admin)</h3>
                    <p><strong>üïó Fecha/hora:</strong> ${new Date().toLocaleString('es-CO')}</p>
                    <p><strong>üì¶ Productos mostrados:</strong> ${total}</p>
                    <p><strong>üìä Total disponibles:</strong> ${totalDisponible}</p>
                    <p><strong>‚ö†Ô∏è Productos sin s√≠ntomas:</strong> ${sinSintomas}</p>
                    ${mensajeLimite}
                    <p style="margin-top: 1.5rem; font-size: 0.85rem; color: #666;">
                        Este reporte se basa en la √∫ltima carga de productos.
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()"
                            style="margin-top: 1.5rem; padding: 0.5rem 1.5rem; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Cerrar
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Guardar productos globalmente para el reporte
        const originalBuscarProductos = window.buscarProductos;
        window.buscarProductos = function() {
            const busquedaUnificada = document.getElementById('busqueda_unificada').value;
            if (busquedaUnificada.trim().length > 0 && busquedaUnificada.trim().length < 3) return;

            const precioMin = document.getElementById('precioMin').value;
            const precioMax = document.getElementById('precioMax').value;
            const params = new URLSearchParams();
            if (busquedaUnificada) {
                params.append('q', busquedaUnificada);
            }
            if (precioMin) params.append('precio_min', precioMin);
            if (precioMax) params.append('precio_max', precioMax);

            document.getElementById('productosContainer').innerHTML = '<div class="loading">Buscando...</div>';
            fetch(`/api/productos?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        window.ultimosProductos = data.productos; // ‚úÖ Guardar para el reporte
                        window.ultimosProductosData = data; // ‚úÖ Guardar data completa con totales
                        productosMostradosEnTienda = data.productos || []; // üéØ CR√çTICO: Guardar aqu√≠ tambi√©n
                        console.log('üíæüíæüíæ PRODUCTOS GUARDADOS (desde funci√≥n sobrescrita):', productosMostradosEnTienda.length);

                        mostrarDiagnosticos(data.sintomas_detectados || [], data.diagnosticos_posibles || [], data.busqueda_parcial || false);
                        mostrarProductos(data.productos, data);
                        
                        // üéØ Verificar pastillero despu√©s de mostrar productos
                        setTimeout(() => {
                            if (productosMostradosEnTienda.length > 0) {
                                verificarMedicamentosPastillero();
                            }
                        }, 100);
                    } else {
                        document.getElementById('productosContainer').innerHTML = 
                            '<div class="sin-resultados">Error al cargar productos</div>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('productosContainer').innerHTML = 
                        '<div class="sin-resultados">Error de conexi√≥n</div>';
                });
        };



        // Cargar y gestionar carousel de promos desde BD
        let promosCarousel = [];
        let currentPromo = 0;

        async function cargarPromos() {
            try {
                const res = await fetch('/api/promos');
                const data = await res.json();

                if (data.ok && data.promos.length > 0) {
                    promosCarousel = data.promos;
                    renderizarPromos();
                    iniciarCarousel();
                } else {
                    // Fallback: mostrar logo por defecto
                    document.getElementById('logoContainer').innerHTML = `
                        <img src="{{ url_for('static', filename='logo1.png') }}"
                             alt="TUC-TUC"
                             class="logo active">
                    `;
                }
            } catch (e) {
                console.error('Error cargando promos:', e);
                // Fallback
                document.getElementById('logoContainer').innerHTML = `
                    <img src="{{ url_for('static', filename='logo1.png') }}"
                         alt="TUC-TUC"
                         class="logo active">
                `;
            }
        }

        function renderizarPromos() {
            const container = document.getElementById('logoContainer');
            container.innerHTML = promosCarousel.map((promo, index) => `
                <img
                    src="${promo.imagen_url.startsWith('http') ? promo.imagen_url : '/static/' + promo.imagen_url}"
                    alt="${promo.titulo}"
                    class="logo state-${index} ${index === 0 ? 'active' : ''}"
                    data-promo-id="${promo.id}"
                    data-medicamento-id="${promo.medicamento_id || ''}"
                    onclick="handlePromoClick(${promo.medicamento_id || 'null'})"
                    style="${promo.medicamento_id ? 'cursor: pointer;' : ''}"
                >
            `).join('');
        }

        function iniciarCarousel() {
            const logos = document.querySelectorAll('.logo');
            if (logos.length === 0) return;

            currentPromo = 0;
            logos[currentPromo].classList.add('active');

            // Funci√≥n para rotar con intervalo individual por promo
            function rotarPromo() {
                const intervaloActual = (promosCarousel[currentPromo]?.intervalo_carousel || 5) * 1000;

                setTimeout(() => {
                    logos[currentPromo].classList.remove('active');
                    currentPromo = (currentPromo + 1) % logos.length;
                    logos[currentPromo].classList.add('active');
                    rotarPromo(); // Llamar recursivamente para la siguiente promo
                }, intervaloActual);
            }

            // Iniciar la rotaci√≥n
            rotarPromo();
        }

        async function handlePromoClick(medicamentoId) {
            if (!medicamentoId) return;

            try {
                // Buscar el producto
                const busqueda = document.getElementById('busqueda_unificada');
                busqueda.value = '';
                await buscarProductos();

                // Esperar a que se carguen los productos
                setTimeout(() => {
                    // Buscar la tarjeta del producto por ID
                    const productCard = document.querySelector(`[data-producto-id="${medicamentoId}"]`);

                    if (productCard) {
                        // Hacer scroll suave al producto
                        productCard.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });

                        // Resaltar el producto brevemente
                        productCard.style.transition = 'all 0.3s';
                        productCard.style.boxShadow = '0 0 20px rgba(33, 150, 243, 0.8)';
                        productCard.style.transform = 'scale(1.05)';

                        setTimeout(() => {
                            productCard.style.boxShadow = '';
                            productCard.style.transform = '';
                        }, 2000);
                    } else {
                        // Si no se encuentra, buscar por ID directamente
                        console.log('Producto no encontrado en vista actual, buscando...');
                        // Aqu√≠ podr√≠amos hacer una b√∫squeda espec√≠fica del medicamento
                    }
                }, 500);
            } catch (e) {
                console.error('Error al navegar al producto:', e);
            }
        }

        // Cargar promos al iniciar
        cargarPromos();


        // ============================================
        // üÜï FUNCIONES DE REGISTRO PARA PASTILLERO
        // ============================================

        function actualizarNombreUsuarioUI(nombre) {
            if (!nombre) return;

            // Extraer primer nombre (antes del primer espacio)
            const primerNombre = nombre.split(' ')[0];

            // Actualizar header principal
            const usuarioHeader = document.getElementById('usuario-header');
            const usuarioNombreHeader = document.getElementById('usuario-nombre-header');

            if (usuarioHeader && usuarioNombreHeader) {
                usuarioNombreHeader.textContent = `Hola, ${primerNombre}`;
                usuarioHeader.style.display = 'block';
            }

            // Actualizar t√≠tulo del modal pastillero
            const tituloPastillero = document.getElementById('titulo-pastillero');
            if (tituloPastillero) {
                tituloPastillero.textContent = `Pastillero de ${primerNombre}`;
            }

            console.log(`‚úÖ UI actualizada con nombre: ${primerNombre}`);
        }

        function mostrarModalRegistro() {
            document.getElementById('modal-registro-pastillero').style.display = 'flex';
            // Auto-focus en el primer campo
            setTimeout(() => {
                document.getElementById('registro-nombre').focus();
            }, 100);
        }

        function cerrarModalRegistro() {
            document.getElementById('modal-registro-pastillero').style.display = 'none';
            // Limpiar campos
            document.getElementById('registro-nombre').value = '';
            document.getElementById('registro-telefono').value = '';
        }

        async function registrarUsuarioPastillero() {
            const nombre = document.getElementById('registro-nombre').value.trim();
            const telefono = document.getElementById('registro-telefono').value.trim();

            // Validaci√≥n
            if (!nombre || !telefono) {
                alert('Por favor completa todos los campos');
                return;
            }

            if (telefono.length < 10) {
                alert('El tel√©fono debe tener al menos 10 d√≠gitos');
                return;
            }

            // Deshabilitar bot√≥n
            const btnRegistrar = document.querySelector('.btn-registrar');
            btnRegistrar.disabled = true;
            btnRegistrar.textContent = 'Creando cuenta...';

            try {
                const response = await fetch('/api/crear-usuario-pastillero', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, telefono })
                });

                const data = await response.json();

                if (data.ok) {
                    // Guardar en localStorage
                    localStorage.setItem('usuario_id', data.usuario_id);
                    localStorage.setItem('nombre_usuario', data.nombre);
                    localStorage.setItem('telefono_usuario', data.telefono);

                    console.log('‚úÖ Usuario creado y guardado en localStorage:', data);

                    // üÜï Actualizar UI con nombre de usuario
                    actualizarNombreUsuarioUI(data.nombre);

                    // Cerrar modal
                    cerrarModalRegistro();

                    // Mostrar mensaje de bienvenida
                    alert(`¬°Bienvenido ${data.nombre.split(' ')[0]}! Ya puedes usar el pastillero`);

                    // Abrir pastillero autom√°ticamente
                    abrirPastillero();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo crear la cuenta'));
                    btnRegistrar.disabled = false;
                    btnRegistrar.textContent = 'Crear cuenta';
                }
            } catch (error) {
                console.error('Error al registrar usuario:', error);
                alert('Error al crear la cuenta. Intenta de nuevo.');
                btnRegistrar.disabled = false;
                btnRegistrar.textContent = 'Crear cuenta';
            }
        }

        // ============================================
        // üÜï RESTAURACI√ìN AUTOM√ÅTICA DE SESI√ìN
        // ============================================

        async function restaurarSesionAutomatica() {
            const usuarioId = localStorage.getItem('usuario_id');

            if (!usuarioId) {
                console.log('‚ÑπÔ∏è No hay usuario_id en localStorage');
                return false;
            }

            try {
                const response = await fetch('/api/restaurar-sesion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuario_id: usuarioId })
                });

                const data = await response.json();

                if (data.ok) {
                    console.log('üîÑ Sesi√≥n restaurada autom√°ticamente:', data);

                    // üÜï Actualizar UI con nombre de usuario
                    actualizarNombreUsuarioUI(data.nombre);

                    return true;
                } else {
                    console.log('‚ö†Ô∏è No se pudo restaurar sesi√≥n:', data.error);
                    // Limpiar localStorage si el usuario ya no existe
                    localStorage.removeItem('usuario_id');
                    localStorage.removeItem('nombre_usuario');
                    localStorage.removeItem('telefono_usuario');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error al restaurar sesi√≥n:', error);
                return false;
            }
        }

        // ============================================
        // üÜï RECUPERAR DATOS DE USUARIO DESDE BACKEND
        // ============================================

        async function recuperarDatosUsuarioDesdeBackend() {
            try {
                const response = await fetch('/api/obtener-datos-usuario-sesion', {
                    method: 'GET'
                });

                const data = await response.json();

                if (data.ok && data.usuario_id) {
                    // Guardar en localStorage
                    localStorage.setItem('usuario_id', data.usuario_id);
                    localStorage.setItem('nombre_usuario', data.nombre || '');
                    localStorage.setItem('telefono_usuario', data.telefono || '');

                    console.log('‚úÖ Datos de usuario recuperados del backend:', data);

                    // Actualizar UI
                    if (data.nombre) {
                        actualizarNombreUsuarioUI(data.nombre);
                    }

                    return true;
                } else {
                    console.log('‚ö†Ô∏è No se pudieron recuperar datos del backend');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error al recuperar datos del backend:', error);
                return false;
            }
        }

        // ============================================
        // VINCULACI√ìN CON C√ìDIGO QR
        // ============================================

        async function generarQRVinculacion() {
            try {
                // Generar token en el backend
                const response = await fetch('/api/generar-token-vinculacion', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.ok) {
                    // Mostrar modal
                    document.getElementById('modal-qr-vinculacion').style.display = 'flex';

                    // Generar c√≥digo QR usando qrcode.js
                    const qrContainer = document.getElementById('qr-code-container');
                    qrContainer.innerHTML = ''; // Limpiar

                    // Crear c√≥digo QR
                    new QRCode(qrContainer, {
                        text: data.url,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    // Mostrar URL tambi√©n
                    document.getElementById('url-vinculacion-text').textContent = data.url;

                    console.log('‚úÖ QR generado:', data.url);
                } else {
                    alert('Error al generar c√≥digo QR: ' + (data.error || 'Desconocido'));
                }
            } catch (error) {
                console.error('Error al generar QR:', error);
                alert('Error al generar c√≥digo QR. Intenta de nuevo.');
            }
        }

        function cerrarModalQR() {
            document.getElementById('modal-qr-vinculacion').style.display = 'none';
        }

        async function copiarURLVinculacion() {
            const urlText = document.getElementById('url-vinculacion-text').textContent;

            try {
                await navigator.clipboard.writeText(urlText);

                // Cambiar temporalmente el texto del bot√≥n
                const btn = event.target;
                const textoOriginal = btn.innerHTML;
                btn.innerHTML = '‚úÖ ¬°Copiado!';
                btn.style.background = '#2196F3';

                setTimeout(() => {
                    btn.innerHTML = textoOriginal;
                    btn.style.background = '#4CAF50';
                }, 2000);

                console.log('‚úÖ URL copiada al portapapeles');
            } catch (error) {
                console.error('Error al copiar:', error);
                // Fallback para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = urlText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Enlace copiado al portapapeles');
                } catch (err) {
                    alert('No se pudo copiar. Por favor copia manualmente la URL.');
                }
                document.body.removeChild(textArea);
            }
        }

        // Detectar si se abri√≥ con un token de vinculaci√≥n
        (async function() {
            const pathParts = window.location.pathname.split('/');
            if (pathParts[1] === 'vincular' && pathParts[2]) {
                const token = pathParts[2];
                console.log('üîó Detectado token de vinculaci√≥n:', token);

                try {
                    const response = await fetch(`/api/validar-token-vinculacion/${token}`, {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.ok) {
                        // Guardar en localStorage
                        localStorage.setItem('usuario_id', data.usuario_id);
                        localStorage.setItem('nombre_usuario', data.nombre);
                        localStorage.setItem('telefono_usuario', data.telefono);

                        console.log('‚úÖ Dispositivo vinculado exitosamente:', data);

                        // Mostrar mensaje de bienvenida
                        alert(`¬°Dispositivo vinculado exitosamente!\n\nBienvenido ${data.nombre.split(' ')[0]}`);

                        // Redirigir a la p√°gina principal
                        window.location.href = '/';
                    } else {
                        alert('Error al vincular dispositivo: ' + data.error);
                        window.location.href = '/';
                    }
                } catch (error) {
                    console.error('Error al validar token:', error);
                    alert('Error al vincular dispositivo. Intenta de nuevo.');
                    window.location.href = '/';
                }
            }
        })();

        // Ejecutar restauraci√≥n al cargar la p√°gina
        restaurarSesionAutomatica();

        // üÜï Actualizar UI si ya hay nombre guardado en localStorage
        const nombreGuardado = localStorage.getItem('nombre_usuario');
        if (nombreGuardado) {
            actualizarNombreUsuarioUI(nombreGuardado);
        }

        // Enter en campos del modal de registro (esperar a que DOM est√© listo)
        document.addEventListener('DOMContentLoaded', function() {
            const registroNombre = document.getElementById('registro-nombre');
            const registroTelefono = document.getElementById('registro-telefono');

            if (registroNombre) {
                registroNombre.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('registro-telefono').focus();
                    }
                });
            }

            if (registroTelefono) {
                registroTelefono.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        registrarUsuarioPastillero();
                    }
                });
            }
        });


        // ============================================
        // FUNCIONES DE RECORDATORIOS
        // ============================================

        let recordatorioData = {
            medicamento_id: null,
            nombre: '',
            horas_seleccionadas: null
        };

        function toggleRecordatorio(medicamentoId, nombreMedicamento, recordatorioActivo) {
            if (recordatorioActivo) {
                // Desactivar recordatorio
                if (confirm(`¬øDesactivar recordatorio para ${nombreMedicamento}?`)) {
                    desactivarRecordatorio(medicamentoId);
                }
            } else {
                // Activar recordatorio
                mostrarModalRecordatorio(medicamentoId, nombreMedicamento);
            }
        }

        function mostrarModalRecordatorio(medicamentoId, nombreMedicamento) {
            recordatorioData.medicamento_id = medicamentoId;
            recordatorioData.nombre = nombreMedicamento;
            recordatorioData.horas_seleccionadas = null;

            // Actualizar t√≠tulo del modal
            document.getElementById('recordatorio-medicamento-nombre').textContent = nombreMedicamento;

            // Limpiar selecci√≥n de horas
            document.querySelectorAll('.btn-hora').forEach(btn => btn.classList.remove('selected'));

            // Configurar fecha/hora actual + 8 horas por defecto
            const ahora = new Date();
            ahora.setHours(ahora.getHours() + 8);
            const fechaLocal = ahora.toISOString().slice(0, 16);
            document.getElementById('proxima-toma').value = fechaLocal;

            // Mostrar alerta de Telegram si no est√° vinculado
            const telefono = localStorage.getItem('telefono_usuario');
            document.getElementById('telefono-usuario').textContent = telefono || '(tu tel√©fono)';

            // TODO: Verificar si tiene Telegram vinculado
            // Por ahora siempre mostramos la alerta
            document.getElementById('alerta-vincular-telegram').style.display = 'block';

            // Mostrar modal
            document.getElementById('modal-recordatorio').style.display = 'flex';
        }

        function cerrarModalRecordatorio() {
            document.getElementById('modal-recordatorio').style.display = 'none';
            recordatorioData = { medicamento_id: null, nombre: '', horas_seleccionadas: null };
        }

        function seleccionarHoras(horas) {
            recordatorioData.horas_seleccionadas = horas;

            // Actualizar UI
            document.querySelectorAll('.btn-hora').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        async function guardarRecordatorio() {
            const { medicamento_id, horas_seleccionadas } = recordatorioData;
            const proximaToma = document.getElementById('proxima-toma').value;

            // Validar
            if (!horas_seleccionadas) {
                alert('Por favor selecciona cada cu√°ntas horas tomas el medicamento');
                return;
            }

            if (!proximaToma) {
                alert('Por favor selecciona cu√°ndo es tu pr√≥xima toma');
                return;
            }

            try {
                const response = await fetch(`/api/pastillero/${medicamento_id}/activar-recordatorio`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        horas_entre_tomas: horas_seleccionadas,
                        proxima_toma: proximaToma
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    alert('Recordatorio activado correctamente');
                    cerrarModalRecordatorio();
                    // Recargar pastillero para mostrar bot√≥n actualizado
                    cargarMedicamentosPastillero();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo activar el recordatorio'));
                }
            } catch (error) {
                console.error('Error al activar recordatorio:', error);
                alert('Error al activar recordatorio. Intenta de nuevo.');
            }
        }

        async function desactivarRecordatorio(medicamentoId) {
            try {
                const response = await fetch(`/api/pastillero/${medicamentoId}/desactivar-recordatorio`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.ok) {
                    alert('Recordatorio desactivado');
                    // Recargar pastillero para mostrar bot√≥n actualizado
                    cargarMedicamentosPastillero();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo desactivar'));
                }
            } catch (error) {
                console.error('Error al desactivar recordatorio:', error);
                alert('Error al desactivar recordatorio');
            }
        }


        // ============================================
        // FUNCIONES DE CONTACTOS ADICIONALES
        // ============================================

        async function abrirModalContactos() {
            document.getElementById('modal-contactos').style.display = 'flex';
            // Cargar contactos existentes
            await cargarContactosAdicionales();
        }

        function cerrarModalContactos() {
            document.getElementById('modal-contactos').style.display = 'none';
            // Limpiar formulario
            document.getElementById('contacto-nombre').value = '';
            document.getElementById('contacto-telefono').value = '';
        }

        async function cargarContactosAdicionales() {
            try {
                const response = await fetch('/api/pastillero/contactos');
                const data = await response.json();

                const lista = document.getElementById('lista-contactos-adicionales');

                if (!data.ok) {
                    lista.innerHTML = '<p style="color: #999; text-align: center;">Error al cargar contactos</p>';
                    return;
                }

                if (data.contactos.length === 0) {
                    lista.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">No hay contactos agregados a√∫n</p>';
                    return;
                }

                // Renderizar lista de contactos
                lista.innerHTML = data.contactos.map(contacto => `
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; font-size: 1rem;">${contacto.nombre}</div>
                            <div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">
                                ${contacto.telefono}
                                ${contacto.telegram_vinculado
                                    ? '<span style="color: #27ae60; margin-left: 0.5rem;">‚úì Telegram vinculado</span>'
                                    : '<span style="color: #e67e22; margin-left: 0.5rem;">‚ö† Telegram no vinculado</span>'
                                }
                            </div>
                        </div>
                        <button onclick="eliminarContactoAdicional(${contacto.id})" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Eliminar
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error al cargar contactos:', error);
                document.getElementById('lista-contactos-adicionales').innerHTML =
                    '<p style="color: #e74c3c; text-align: center;">Error al cargar contactos</p>';
            }
        }

        async function agregarContactoAdicional() {
            const nombre = document.getElementById('contacto-nombre').value.trim();
            const telefono = document.getElementById('contacto-telefono').value.trim();

            if (!nombre || !telefono) {
                alert('Por favor completa nombre y tel√©fono');
                return;
            }

            try {
                const response = await fetch('/api/pastillero/contactos/agregar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, telefono })
                });

                const data = await response.json();

                if (data.ok) {
                    alert('Contacto agregado correctamente');
                    // Limpiar formulario
                    document.getElementById('contacto-nombre').value = '';
                    document.getElementById('contacto-telefono').value = '';
                    // Recargar lista
                    await cargarContactosAdicionales();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo agregar el contacto'));
                }
            } catch (error) {
                console.error('Error al agregar contacto:', error);
                alert('Error al agregar contacto. Intenta de nuevo.');
            }
        }

        async function eliminarContactoAdicional(contactoId) {
            if (!confirm('¬øEliminar este contacto? Dejar√° de recibir recordatorios.')) {
                return;
            }

            try {
                const response = await fetch(`/api/pastillero/contactos/${contactoId}/eliminar`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.ok) {
                    alert('Contacto eliminado');
                    // Recargar lista
                    await cargarContactosAdicionales();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (error) {
                console.error('Error al eliminar contacto:', error);
                alert('Error al eliminar contacto');
            }
        }


    </script>

    <!-- üÜï MODAL DEL PASTILLERO -->
    <div id="modal-pastillero" class="modal-pastillero">
        <div class="modal-pastillero-content">
            <div class="modal-pastillero-header">
                <h2><span>üíä</span> <span id="titulo-pastillero">Mi Pastillero</span></h2>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn-contactos-pastillero" onclick="generarQRVinculacion()" title="Vincular otro dispositivo con c√≥digo QR">
                        <span>üì±</span> Vincular
                    </button>
                    <button class="btn-contactos-pastillero" onclick="abrirModalContactos()" title="Gestionar contactos para recordatorios">
                        <span>üë•</span> Contactos
                    </button>
                    <button id="btn-ordenar-pastillero" class="btn-ordenar-pastillero" onclick="toggleOrdenPastillero()">
                        <span id="icono-orden">üìÖ</span> <span id="texto-orden">Recientes</span>
                    </button>
                    <button class="btn-cerrar-modal" onclick="cerrarPastillero()">√ó</button>
                </div>
            </div>            <div class="modal-pastillero-body">
                <!-- B√∫squeda de medicamentos -->
                <div class="pastillero-busqueda">
                    <input 
                        type="text" 
                        id="input-buscar-medicamento" 
                        placeholder="Buscar medicamento para agregar (Enter para crear)"
                        autocomplete="off"
                    >
                    <div id="sugerencias-medicamentos" class="pastillero-sugerencias"></div>
                </div>
                
                <!-- Lista de medicamentos -->
                <div id="lista-medicamentos-pastillero">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- üÜï MODAL DE REGISTRO PARA PASTILLERO -->
    <div id="modal-registro-pastillero" class="modal-registro" style="display: none;">
        <div class="modal-registro-content">
            <div class="modal-registro-header">
                <h2>Crear cuenta para usar el Pastillero</h2>
                <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Solo necesitamos 2 datos para empezar</p>
            </div>
            <div class="modal-registro-body">
                <div class="form-group">
                    <label for="registro-nombre">Nombre completo</label>
                    <input type="text" id="registro-nombre" placeholder="Ej: Juan P√©rez" required>
                </div>
                <div class="form-group">
                    <label for="registro-telefono">Tel√©fono</label>
                    <input type="tel" id="registro-telefono" placeholder="Ej: 3001234567" required>
                    <p class="nota">Lo usaremos para recordar tus datos en futuras compras</p>
                </div>
            </div>
            <div class="modal-registro-footer">
                <button class="btn-registrar" onclick="registrarUsuarioPastillero()">Crear cuenta</button>
                <button class="btn-cancelar-registro" onclick="cerrarModalRegistro()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE RECORDATORIO -->
    <div id="modal-recordatorio" class="modal-registro" style="display: none;">
        <div class="modal-registro-content">
            <div class="modal-registro-header">
                <h2>Configurar Recordatorio</h2>
                <p id="recordatorio-medicamento-nombre" style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;"></p>
            </div>
            <div class="modal-registro-body">
                <div class="form-group">
                    <label>¬øCada cu√°ntas horas tomas este medicamento?</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                        <button class="btn-hora" data-horas="4" onclick="seleccionarHoras(4)">4h</button>
                        <button class="btn-hora" data-horas="6" onclick="seleccionarHoras(6)">6h</button>
                        <button class="btn-hora" data-horas="8" onclick="seleccionarHoras(8)">8h</button>
                        <button class="btn-hora" data-horas="12" onclick="seleccionarHoras(12)">12h</button>
                        <button class="btn-hora" data-horas="24" onclick="seleccionarHoras(24)">24h</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="proxima-toma">¬øCu√°ndo es tu pr√≥xima toma?</label>
                    <input type="datetime-local" id="proxima-toma" required>
                </div>
                <div id="alerta-vincular-telegram" style="display: none; background: #fff3cd; padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; font-weight: 600; color: #856404;">Para recibir recordatorios, conecta tu Telegram</p>
                    <ol style="margin: 0.5rem 0 0 1.2rem; font-size: 0.9rem; color: #856404;">
                        <li>Abre Telegram</li>
                        <li>Busca: <strong>@tuctuc_notif_bot</strong></li>
                        <li>Env√≠a: <strong>/vincular <span id="telefono-usuario"></span></strong></li>
                    </ol>
                    <a href="https://t.me/tuctuc_notif_bot" target="_blank" style="display: inline-block; margin-top: 0.5rem; padding: 0.5rem 1rem; background: #0088cc; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                        Abrir Telegram
                    </a>
                </div>
            </div>
            <div class="modal-registro-footer">
                <button class="btn-registrar" onclick="guardarRecordatorio()">Activar Recordatorio</button>
                <button class="btn-cancelar-registro" onclick="cerrarModalRecordatorio()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE VINCULACI√ìN QR -->
    <div id="modal-qr-vinculacion" class="modal-registro" style="display: none;">
        <div class="modal-registro-content" style="max-width: 400px;">
            <div class="modal-registro-header">
                <h2>Vincular otro dispositivo</h2>
            </div>
            <div class="modal-registro-body" style="text-align: center;">
                <p style="margin-bottom: 1rem; color: #555;">Escanea este c√≥digo QR desde tu otro dispositivo para vincular tu cuenta</p>

                <div id="qr-code-container" style="display: flex; justify-content: center; margin: 1rem 0;">
                    <!-- El QR se generar√° aqu√≠ -->
                </div>

                <p style="font-size: 0.85rem; color: #888; margin-top: 1rem;">
                    El c√≥digo expira en <strong>5 minutos</strong>
                </p>

                <div id="url-vinculacion-text" style="margin-top: 1rem; padding: 0.75rem; background: #f5f5f5; border-radius: 6px; word-break: break-all; font-size: 0.8rem; color: #666;">
                    <!-- URL se mostrar√° aqu√≠ -->
                </div>

                <button onclick="copiarURLVinculacion()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                    üìã Copiar enlace
                </button>
            </div>
            <div class="modal-registro-footer">
                <button class="btn-cancelar-registro" onclick="cerrarModalQR()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONTACTOS ADICIONALES -->
    <div id="modal-contactos" class="modal-registro" style="display: none;">
        <div class="modal-registro-content">
            <div class="modal-registro-header">
                <h2>üë• Contactos para Recordatorios</h2>
                <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                    Agrega familiares o cuidadores que tambi√©n recibir√°n recordatorios de tus medicamentos
                </p>
            </div>
            <div class="modal-registro-body">
                <!-- Formulario para agregar contacto -->
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">Agregar nuevo contacto</h3>
                    <div class="form-group">
                        <label for="contacto-nombre">Nombre</label>
                        <input type="text" id="contacto-nombre" placeholder="Ej: Juan P√©rez (hijo)" required>
                    </div>
                    <div class="form-group">
                        <label for="contacto-telefono">Tel√©fono</label>
                        <input type="tel" id="contacto-telefono" placeholder="Ej: 3001234567" required>
                    </div>
                    <button class="btn-registrar" onclick="agregarContactoAdicional()" style="width: 100%;">
                        + Agregar Contacto
                    </button>
                </div>

                <!-- Lista de contactos existentes -->
                <div>
                    <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">Contactos agregados</h3>
                    <div id="lista-contactos-adicionales">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #2196F3;">
                    <p style="margin: 0; font-size: 0.9rem; color: #0d47a1;">
                        <strong>üí° C√≥mo funciona:</strong><br>
                        Cada contacto recibir√° recordatorios en Telegram cuando sea hora de tomar tus medicamentos.
                        Para recibir los recordatorios, deben enviar <strong>/vincular TELEFONO</strong> a @tuctuc_notif_bot
                    </p>
                </div>
            </div>
            <div class="modal-registro-footer">
                <button class="btn-cancelar-registro" onclick="cerrarModalContactos()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante de WhatsApp -->
    <a href="https://wa.me/573166686397?text=Hola%2C%20tengo%20una%20consulta%20sobre%20medicamentos"
       class="whatsapp-float"
       target="_blank"
       rel="noopener noreferrer"
       aria-label="Contactar por WhatsApp">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="35" height="35">
            <path fill="white" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/>
        </svg>
        <span class="whatsapp-tooltip">¬øNecesitas ayuda?<br>Escr√≠benos</span>
    </a>

    <style>
        .whatsapp-float {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 20px;
            right: 20px;
            background-color: #25D366;
            color: #FFF;
            border-radius: 50px;
            text-align: center;
            font-size: 30px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .whatsapp-float:hover {
            transform: scale(1.1);
            box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.4);
        }

        .whatsapp-tooltip {
            position: absolute;
            right: 70px;
            background: #fff;
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            line-height: 1.4;
            text-align: center;
        }

        .whatsapp-float:hover .whatsapp-tooltip {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .whatsapp-float {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }

            .whatsapp-tooltip {
                display: none;
            }
        }
    </style>

</body>
</html>