<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Actualizar Precios</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 620px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        h1 { color: #007b5e; font-size: 1.4em; }
        /* Panel de configuraci√≥n */
        .panel-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .panel-config h2 {
            margin-top: 0;
            font-size: 1.1em;
            color: #495057;
            margin-bottom: 12px;
        }
        .config-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .config-item {
            flex: 1;
            min-width: 140px;
        }
        .config-item label {
            display: block;
            font-size: 0.82em;
            color: #555;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .config-item input,
        .config-item select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.92em;
            box-sizing: border-box;
        }
        .config-feedback {
            font-size: 0.85em;
            color: #28a745;
            margin-left: 8px;
            min-width: 90px;
            align-self: flex-end;
            padding-bottom: 6px;
        }
        /* Medicamento */
        .medicamento-card { 
            background: #f9f9f9; 
            padding: 15px; 
            margin: 0; 
            border-radius: 8px; 
            border-left: 4px solid #007b5e;
        }
        input[type="text"], input[type="number"], select { 
            padding: 6px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .input-ancho {
            flex: 1 !important;
            min-width: 0 !important;
            width: auto !important;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .btn { 
            padding: 6px 12px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.9em; 
            white-space: nowrap;
        }
        .btn-buscar { background: #007b5e; color: white; padding: 4px 8px; font-size: 0.8em; }
        .btn-guardar { background: #28a745; color: white; }
        .btn-agregar { background: #17a2b8; color: white; }
        .btn-siguiente { background: #ffc107; color: black; }
        .btn-escaso {
            padding: 4px 10px;
            font-size: 0.85em;
            border-radius: 4px;
            margin-left: 8px;
        }
        .btn-escaso.normal { background: #6c757d; color: white; }
        .btn-escaso.escaso { background: #fd7e14; color: white; }
        .btn-nuevo-fab { 
            background: #6c757d; 
            color: white; 
            padding: 4px 10px; 
            font-size: 0.85em;
            border-radius: 4px;
            margin-left: 8px;
            white-space: nowrap;
        }
        .precio-sugerido-input {
            width: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1em;
        }
        .guardado-ok { 
            color: #28a745; 
            font-size: 0.9em; 
            margin-left: 10px; 
        }
        .imagen-preview {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        .imagen-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .sin-medicamentos {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 1.1em;
        }
        .imagen-activa {
            border-color: #28a745 !important;
            background: #e8f5e9;
        }
        .campo-validado {
            background-color: #e8f5e9 !important;
            border-color: #28a745 !important;
        }

        .opcion-oculta {
            display: none !important;           
        } 
            
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Actualizar Precios con Competencia</h1>
        <div class="panel-config">
            <h2>‚öôÔ∏è Reglas de precios (se guardan autom√°ticamente)</h2>
            <div class="config-row">
                <div class="config-item">
                    <label>Descuento vs. competencia ($)</label>
                    <input type="number" id="cfg_descuento" value="{{ config.descuento_competencia or 200 }}" min="0" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Redondeo superior ($)</label>
                    <input type="number" id="cfg_redondeo" value="{{ config.redondeo_superior or 100 }}" min="10" step="10" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Recargo para escasos (%)</label>
                    <input type="number" id="cfg_recargo" value="{{ config.recargo_escaso or 30 }}" min="0" max="100" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Ganancia m√≠nima escaso ($)</label>
                    <input type="number" id="cfg_ganancia_min" value="{{ config.ganancia_min_escaso or 2000 }}" min="0" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Ganancia m√°xima escaso ($)</label>
                    <input type="number" id="cfg_ganancia_max" value="{{ config.ganancia_max_escaso or 10000 }}" min="0" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Base para c√°lculo en modo escaso</label>
                    <select id="cfg_base_escaso" onchange="guardarConfiguracionSimple()">
                        <option value="minimo" {% if config.base_escaso == 'minimo' %}selected{% endif %}>M√≠nimo de competencia</option>
                        <option value="maximo" {% if config.base_escaso == 'maximo' %}selected{% endif %}>M√°ximo de competencia</option>
                    </select>
                </div>
                <div class="config-feedback" id="cfg_feedback"></div>
            </div>
        </div>
        {% if medicamentos and medicamentos|length > 0 %}
            {% set med = medicamentos[0] %}
            <div class="medicamento-card" 
                 data-med-id="{{ med[0] }}" 
                 data-precio-id="{{ med[5] }}"
                 data-nombre-original="{{ med[1] }}"
                 data-pasos-validados='{"nombre":false,"fabricante":false,"precios":false,"imagen":false}'>
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 1; min-width: 0; width: 0;">
                        <div style="margin-bottom: 15px;margin-top: auto;">
                            <div style="margin-bottom: -15px;">
                                <label style="font-size: 0.9em; color: #666;">Medicamento:</label>                             
                                <button class="btn btn-buscar" 
                                        style="padding: 4px 8px; font-size: 0.85em; margin-left: 6px; background: #007b5e;"
                                        onclick="abrirCruzVerdeYFarmatodo({{ med[0] }})"
                                        title="Abrir Cruz Verde y Farmatodo en nuevas pesta√±as">
                                    üîé CV + FT
                                </button>                             
                             

                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="text"
                                        id="nombre_{{ med[0] }}"
                                        value="{{ med[1] }}"
                                        placeholder="Nombre del medicamento"
                                        onblur="actualizarNombre({{ med[0] }})"
                                        style="width: 100% !important; min-width: 400px !important; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; box-sizing: border-box;">
                                    <button class="btn btn-escaso normal" id="btn_escaso_{{ med[0] }}" onclick="toggleEscaso({{ med[0] }})">
                                        Normal
                                    </button>
                                    <button class="btn btn-nuevo-fab" 
                                            style="background: #28a745; padding: 4px 8px; font-size: 0.85em; margin-left: 8px;"
                                            onclick="crearNuevoMedicamentoDesdeNombre({{ med[0] }})">
                                        ‚ûï Crear nuevo medicamento
                                    </button>

                                </div>
                                <span id="guardado_nombre_{{ med[0] }}" class="guardado-ok" style="margin-left: 10px;"></span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <button class="btn" style="margin-left: 350px; background: #dc3545; color: white;" onclick="eliminarMedicamento({{ med[0] }})">
                                    üóëÔ∏è Eliminar
                                </button>



                            </div>
                            <div>
                                <label style="font-size: 0.9em; color: #666;">Fabricante:</label>
                                <input type="text"
                                    id="busqueda_fab_{{ med[0] }}"
                                    placeholder="Escribe para filtrar o crear... (‚Üì para navegar)"
                                    style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; margin-bottom: 4px; position: relative; z-index: 10;"
                                    oninput="filtrarFabricantes({{ med[0] }})"
                                    onkeydown="navegarSugerenciasFabricante({{ med[0] }}, event); if(event.key === 'Enter' && indiceSeleccionado === -1) confirmarCrearFabricante({{ med[0] }})"
                                    autocomplete="off">
                                <div id="sugerencias_fab_{{ med[0] }}" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; border-top: none; background: white; z-index: 9; position: absolute; width: 100%; display: none;"></div>
                                <!-- Campo oculto para mantener compatibilidad con el backend -->
                                <input type="hidden" id="fabricante_{{ med[0] }}" value="{{ med[2] or '' }}">
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            {% for comp in competidores %}
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="min-width: 100px; font-size: 0.9em; font-weight: bold; color: #666;">
                                    {{ comp[1] }}
                                </label>
                                <div style="display: flex; align-items: center; gap: 0; flex: 1;">
                                    <span style="font-size: 0.9em; padding: 6px 4px;">$</span>
                                    <input type="number" 
                                        class="precio-competidor" 
                                        data-comp-id="{{ comp[0] }}"
                                        data-med-id="{{ med[0] }}"
                                        data-comp-nombre="{{ comp[1] }}"
                                        placeholder="0"
                                        oninput="calcularSugerido({{ med[0] }})"
                                        onblur="marcarPrecioValidado({{ med[0] }}, {{ comp[0] }})"
                                        style="width: 115px; padding: 6px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; font-size: 0.85em;">
                                    <button class="btn btn-buscar" 
                                            onclick="buscarEnFarmacia('{{ comp[1] }}', {{ med[0] }}, {{ comp[0] }})"
                                            style="padding: 6px 10px; font-size: 0.9em; background: #007b5e; color: white; border-radius: 0 4px 4px 0; border: 1px solid #007b5e; margin-left: -1px;">
                                        üîç
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; align-self: flex-end;">
                        <div class="imagen-preview" 
                             id="imagen-contenedor_{{ med[0] }}"
                             data-precio-id="{{ med[5] }}"
                             data-med-id="{{ med[0] }}"
                             title="Clic para pegar o cambiar imagen"
                             onclick="gestionarImagenClick({{ med[0] }})">
                            <img id="imagen_{{ med[0] }}"
                                src="{% if med[6] %}/static/uploads/{{ med[6] }}{% else %}data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Crect fill='%23f0f0f0' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' fill='%23999' font-size='14' text-anchor='middle' dominant-baseline='middle'%3E+%3C/text%3E%3C/svg%3E{% endif %}"
                                alt="Imagen producto"
                                style="cursor: pointer;">
                        </div>
                        <small style="color: #666; font-size: 0.8em; text-align: center;">
                            Imagen del producto (para la tienda)
                        </small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin: 15px 0;">
                    <label style="font-weight: bold; color: #666;">üí∞ Precio sugerido:</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="font-size: 0.9em;">$</span>
                        <input type="number" 
                            id="sugerido_{{ med[0] }}" 
                            class="precio-sugerido-input"
                            data-med-id="{{ med[0] }}"
                            placeholder="0"
                            value="{{ med[3] or 0 }}"
                            oninput="guardarSugeridoManual({{ med[0] }})">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-guardar" onclick="guardarPrecios({{ med[0] }}, this.closest('[data-med-id]').dataset.precioId || null)">
                        üíæ Guardar
                    </button>
                    <button class="btn btn-agregar" onclick="agregarFabricante({{ med[0] }})">
                        ‚ûï Otro fabricante
                    </button>
                    <button class="btn btn-siguiente" onclick="manualSiguienteMedicamento({{ med[0] }})">
                        ‚è≠Ô∏è Siguiente medicamento
                    </button>
                    <span id="guardado_precio_{{ med[0] }}" class="guardado-ok"></span>
                </div>
            </div>
        {% else %}
            <div class="sin-medicamentos">
                ‚úÖ ¬°Todos los medicamentos ya tienen precio asignado!<br>
                <small>No hay medicamentos pendientes por actualizar.</small>
            </div>
        {% endif %}
    </div>
    <script>
        let reglas = {
            descuento: parseInt(document.getElementById('cfg_descuento').value) || 200,
            recargo: parseInt(document.getElementById('cfg_recargo').value) || 30,
            redondeo: parseInt(document.getElementById('cfg_redondeo').value) || 100,
            gananciaMin: parseInt(document.getElementById('cfg_ganancia_min').value) || 2000,
            gananciaMax: parseInt(document.getElementById('cfg_ganancia_max').value) || 10000,
            baseEscaso: document.getElementById('cfg_base_escaso').value || 'minimo'
        };
        function guardarConfiguracionSimple() {
            const payload = {
                descuento_competencia: parseInt(document.getElementById('cfg_descuento').value) || 200,
                recargo_escaso: parseInt(document.getElementById('cfg_recargo').value) || 30,
                redondeo_superior: parseInt(document.getElementById('cfg_redondeo').value) || 100,
                ganancia_min_escaso: parseInt(document.getElementById('cfg_ganancia_min').value) || 2000,
                ganancia_max_escaso: parseInt(document.getElementById('cfg_ganancia_max').value) || 10000,
                base_escaso: document.getElementById('cfg_base_escaso').value || 'minimo'
            };
            reglas = {
                descuento: payload.descuento_competencia,
                recargo: payload.recargo_escaso,
                redondeo: payload.redondeo_superior,
                gananciaMin: payload.ganancia_min_escaso,
                gananciaMax: payload.ganancia_max_escaso,
                baseEscaso: payload.base_escaso
            };
            fetch('/admin/guardar-configuracion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    const feedback = document.getElementById('cfg_feedback');
                    feedback.textContent = '‚úÖ Actualizado';
                    setTimeout(() => { feedback.textContent = ''; }, 2000);
                }
            })
            .catch(err => {
                console.error('Error al guardar configuraci√≥n:', err);
                alert('‚ùå Error al guardar: ' + err.message);
            });
        }
        function redondearArriba(valor, base) {
            return Math.ceil(valor / base) * base;
        }

        // === ‚úÖ NUEVO: Auto-guardado del precio sugerido ===
        let timeoutAutoGuardado = {};
        let indiceSeleccionado = -1; // Para navegar con flechas

        function autoGuardarPrecioSugerido(medId, precioSugerido) {
            const fabricanteId = document.getElementById(`fabricante_${medId}`).value;
            if (!fabricanteId || precioSugerido <= 0) return;
            const precioId = document.querySelector(`[data-med-id="${medId}"]`).dataset.precioId || null;
            fetch('/admin/precios/guardar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: precioId,
                    medicamento_id: medId,
                    fabricante_id: fabricanteId,
                    precio: precioSugerido
                })
            }).catch(err => console.error('Error en auto-guardado:', err));
        }

        function calcularSugerido(medId) {
            const esEscaso = document.getElementById(`btn_escaso_${medId}`).classList.contains('escaso');
            const precios = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
            const valores = Array.from(precios)
                .map(input => parseFloat(input.value) || 0)
                .filter(val => val > 0);
            let sugerido = 0;
            if (valores.length === 0) {
                sugerido = 0;
            } else if (esEscaso || valores.length === 1) {
                let precioBase;
                if (valores.length === 1) {
                    precioBase = valores[0];
                } else {
                    if (reglas.baseEscaso === 'maximo') {
                        precioBase = Math.max(...valores);
                    } else {
                        precioBase = Math.min(...valores);
                    }
                }
                const recargoPorcentual = precioBase * (reglas.recargo / 100);
                const ganancia = Math.max(
                    reglas.gananciaMin,
                    Math.min(reglas.gananciaMax, recargoPorcentual)
                );
                sugerido = precioBase + ganancia;
            } else {
                const maxCompetencia = Math.max(...valores);
                sugerido = Math.max(0, maxCompetencia - reglas.descuento);
            }
            if (sugerido > 0) {
                sugerido = redondearArriba(sugerido, reglas.redondeo);
            }
            const valorRedondeado = Math.round(sugerido);
            document.getElementById(`sugerido_${medId}`).value = valorRedondeado;

            // ‚úÖ Guardar autom√°ticamente si hay al menos un precio de competencia
            if (valores.length > 0 && valorRedondeado > 0) {
                if (timeoutAutoGuardado[medId]) {
                    clearTimeout(timeoutAutoGuardado[medId]);
                }
                timeoutAutoGuardado[medId] = setTimeout(() => {
                    autoGuardarPrecioSugerido(medId, valorRedondeado);
                }, 800);
            }
        }

        function guardarSugeridoManual(medId) {}
        function toggleEscaso(medId) {
            const btn = document.getElementById(`btn_escaso_${medId}`);
            if (btn.classList.contains('normal')) {
                btn.classList.replace('normal', 'escaso');
                btn.textContent = 'Escaso';
            } else {
                btn.classList.replace('escaso', 'normal');
                btn.textContent = 'Normal';
            }
            calcularSugerido(medId);
        }
        function marcarPasoValidado(medId, paso) {
            const card = document.querySelector(`[data-med-id="${medId}"]`);
            const pasos = JSON.parse(card.dataset.pasosValidados);
            pasos[paso] = true;
            card.dataset.pasosValidados = JSON.stringify(pasos);
        }
        function validarPasosCompletos(medId) {
            const card = document.querySelector(`[data-med-id="${medId}"]`);
            const pasos = JSON.parse(card.dataset.pasosValidados);
            return pasos.nombre && pasos.fabricante && pasos.precios && pasos.imagen;
        }
        function mostrarDialogoSiguiente(medId) {
            if (validarPasosCompletos(medId)) {
                // Retraso de 300ms para asegurar que la imagen se muestre antes del confirm
                setTimeout(() => {
                    if (confirm('‚úÖ Todos los pasos est√°n completos.\n¬øDeseas pasar al siguiente medicamento?')) {
                        location.reload();
                    }
                }, 300);
            }
        }
        // ‚úÖ NOMBRE
        function actualizarNombre(medId) {
            const input = document.getElementById(`nombre_${medId}`);
            const nombreOriginal = document.querySelector(`[data-med-id="${medId}"]`).dataset.nombreOriginal;
            const nuevoNombre = input.value.trim();
            if (nuevoNombre === nombreOriginal) return;
            const formData = new FormData();
            formData.append('accion', 'actualizar_nombre');
            formData.append('medicamento_id', medId);
            formData.append('nuevo_nombre', nuevoNombre);
            fetch('/admin/actualizar_precios', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    input.classList.add('campo-validado');
                    marcarPasoValidado(medId, 'nombre');
                    document.querySelector(`[data-med-id="${medId}"]`).dataset.nombreOriginal = nuevoNombre;
                }
            });
        }

        // Seguimiento de interacci√≥n real con el select de fabricante

        function marcarFabricanteValidado(medId) {
            console.log("‚úÖ Validando fabricante para medId:", medId);
            const inputOculto = document.getElementById(`fabricante_${medId}`);
            const inputVisible = document.getElementById(`busqueda_fab_${medId}`);
            
            if (inputOculto.value) {
                inputVisible.classList.add('campo-validado');
                marcarPasoValidado(medId, 'fabricante');
                
                const primerPrecio = document.querySelector(`.precio-competidor[data-med-id="${medId}"]`);
                if (primerPrecio) {
                    primerPrecio.focus();
                    setTimeout(() => {
                        buscarEnFarmacia(primerPrecio.dataset.compNombre, medId, primerPrecio.dataset.compId);
                    }, 200);
                }
            }
        }

        function marcarPrecioValidado(medId, compId) {
            const input = document.querySelector(`.precio-competidor[data-med-id="${medId}"][data-comp-id="${compId}"]`);
            const valor = parseFloat(input?.value) || 0;

            if (valor > 0) {
                input.classList.add('campo-validado');

                // Obtener el fabricante_id del input oculto
                const fabricanteId = document.getElementById(`fabricante_${medId}`)?.value;

                if (!fabricanteId) {
                    console.warn('‚ö†Ô∏è No hay fabricante seleccionado. No se puede guardar el precio de competencia.');
                    return;
                }

                // Obtener la URL si fue guardada al abrir la farmacia
                const url = input.dataset.urlCotizacion || null;

                console.log('üíæ Guardando precio competencia:', { medicamento_id: medId, fabricante_id: fabricanteId, competidor_id: compId, precio: valor, url: url });

                const payload = {
                    medicamento_id: medId,
                    fabricante_id: fabricanteId,
                    competidor_id: compId,
                    precio: valor
                };

                // Solo agregar URL si existe
                if (url) {
                    payload.url = url;
                }

                fetch('/admin/precios/guardar-precio-competencia', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    console.log('üì° Respuesta HTTP:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ Respuesta del servidor:', data);
                    if (!data.ok) {
                        console.error('‚ö†Ô∏è El servidor respondi√≥ con error:', data.error);
                    }
                })
                .catch(err => {
                    console.error('‚ùå Error guardando precio competencia:', err);
                    alert('Error al guardar precio: ' + err.message);
                });
                
                const precios = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
                const hayValido = Array.from(precios).some(p => parseFloat(p.value) > 0);
                if (hayValido) {
                    marcarPasoValidado(medId, 'precios');
                }
                const todosPrecios = Array.from(precios);
                const currentIndex = todosPrecios.indexOf(input);
                const siguientePrecio = todosPrecios[currentIndex + 1];
                if (siguientePrecio) {
                    setTimeout(() => {
                        siguientePrecio.focus();
                        buscarEnFarmacia(siguientePrecio.dataset.compNombre, medId, siguientePrecio.dataset.compId);
                    }, 200);
                } else {
                    mostrarDialogoSiguiente(medId);
                }
            }
        }

        // ‚úÖ BOT√ìN MANUAL
        function abrirCruzVerdeYFarmatodo(medId) {
            const nombre = document.getElementById(`nombre_${medId}`).value;
            if (!nombre?.trim()) {
                alert("‚ö†Ô∏è Primero ingresa el nombre del medicamento.");
                return;
            }
            // Usar la funci√≥n completa
            const comp1 = document.querySelector(`.precio-competidor[data-med-id="${medId}"]`);
            if (comp1) {
                buscarEnFarmacia('Cruz Verde', medId, comp1.dataset.compId);
                setTimeout(() => {
                    const comp2 = comp1.nextElementSibling?.nextElementSibling?.querySelector('.precio-competidor');
                    if (comp2) buscarEnFarmacia('Farmatodo', medId, comp2.dataset.compId);
                }, 300);
            }
        }
        // ‚úÖ FUNCI√ìN CLAVE: abre farmacia Y pega al volver
        function buscarEnFarmacia(nombreFarmacia, medId, compId) {
            const inputActivo = document.querySelector(
                `.precio-competidor[data-med-id="${medId}"][data-comp-id="${compId}"]`
            );
            const nombre = document.getElementById(`nombre_${medId}`).value;
            const medLimpio = limpiarNombreMedicamento(nombre);
            const medEncodificado = encodeURIComponent(medLimpio);
            let url;
            if (nombreFarmacia === 'Cruz Verde') {
                url = `https://www.cruzverde.com.co/search?query=${medEncodificado}`;
            } else if (nombreFarmacia === 'Farmatodo') {
                url = `https://www.farmatodo.com.co/buscar?product=${medEncodificado}&departamento=Todos&filtros=`;
            } else if (nombreFarmacia === 'Locatel') {
                url = `https://www.locatelcolombia.com/search?q=${medEncodificado}`;
            } else if (nombreFarmacia === 'La Rebaja') {
                url = `https://www.larebajavirtual.com/search?query=${medEncodificado}`;
            }

            // Guardar la URL en el atributo data del input para usarla al guardar
            if (inputActivo) {
                inputActivo.dataset.urlCotizacion = url;
            }

            window.open(url, '_blank');
            window.addEventListener('focus', () => {
                if (inputActivo) {
                    setTimeout(() => {
                        inputActivo.focus();
                        navigator.clipboard.readText().then(texto => {
                            const limpio = texto.trim();
                            if (!limpio) return;

                            // ‚úÖ Primero LIMPIAR todo (quitar $, comas, puntos, espacios)
                            const soloDigitos = limpio.replace(/[$.,\s]/g, '');

                            // ‚úÖ Luego verificar si lo que qued√≥ son SOLO d√≠gitos
                            const esNumero = /^\d+$/.test(soloDigitos);

                            if (esNumero && soloDigitos !== '') {
                                inputActivo.value = soloDigitos;
                                calcularSugerido(inputActivo.dataset.medId);
                                marcarPrecioValidado(medId, compId);
                            }
                        }).catch(() => {});
                    }, 100);
                }
            }, { once: true });
        }
        // ‚úÖ GESTI√ìN DE IMAGEN CON CLIQUEO (y pegado autom√°tico)
        async function gestionarImagenClick(medId) {
            const contenedor = document.getElementById(`imagen-contenedor_${medId}`);
            const precioId = contenedor.dataset.precioId;
            const medIdReal = medId;
            if (!precioId) {
                alert("‚ö†Ô∏è Primero guarda al menos un precio de competencia para poder asociar la imagen.");
                return;
            }
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            await procesarImagenDesdeBlob(blob, precioId, contenedor, medIdReal);
                            return;
                        }
                    }
                }
                // Si no hay imagen, activar modo pegado manual
                contenedor.classList.add('imagen-activa');
                setTimeout(() => contenedor.classList.remove('imagen-activa'), 30000);
            } catch (err) {
                console.warn('No se pudo acceder al portapapeles. Activando modo pegado manual.');
                contenedor.classList.add('imagen-activa');
                setTimeout(() => contenedor.classList.remove('imagen-activa'), 30000);
            }
        }
        // Listener de pegado manual (fallback)
        document.addEventListener('paste', function(e) {
            const contenedorActivo = document.querySelector('.imagen-preview.imagen-activa');
            if (!contenedorActivo) return;
            const precioId = contenedorActivo.dataset.precioId;
            const medId = contenedorActivo.dataset.medId;
            const items = e.clipboardData?.items;
            if (!items) return;
            for (let item of items) {
                if (item.type.indexOf('image') === -1) continue;
                e.preventDefault();
                const blob = item.getAsFile();
                if (blob && precioId) {
                    procesarImagenDesdeBlob(blob, precioId, contenedorActivo, medId);
                }
                break;
            }
            contenedorActivo.classList.remove('imagen-activa');
        });
        async function procesarImagenDesdeBlob(blob, precioId, contenedor, medId) {
            const formData = new FormData();
            formData.append('imagen', blob, 'imagen.jpg');
            contenedor.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#e8f5e9;">‚è≥</div>';
            try {
                const res = await fetch(`/admin/precios/${precioId}/imagen`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.ok && data.imagen) {
                    contenedor.innerHTML = `
                        <img id="imagen_${medId}"
                            src="/static/uploads/${data.imagen}?t=${Date.now()}"
                            alt="Imagen producto"
                            style="cursor: pointer;">
                    `;
                    marcarPasoValidado(medId, 'imagen');
                    contenedor.style.borderColor = '#28a745';
                    contenedor.style.backgroundColor = '#e8f5e9';
                    mostrarDialogoSiguiente(medId);
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (err) {
                console.error('Error en procesarImagenDesdeBlob:', err);
                alert('‚ùå Error guardando imagen');
                contenedor.innerHTML = `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Crect fill='%23f0f0f0' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' fill='%23999' font-size='14' text-anchor='middle' dominant-baseline='middle'%3E+%3C/text%3E%3C/svg%3E" style="cursor: pointer;">`;
            }
        }


                // === FILTRADO INTELIGENTE DE FABRICANTES ===
        // Almacena la lista de fabricantes en una variable global al cargar
        const listaFabricantes = {{ fabricantes | tojson }};

        function filtrarFabricantes(medId) {
            const input = document.getElementById(`busqueda_fab_${medId}`);
            const contenedor = document.getElementById(`sugerencias_fab_${medId}`);
            const texto = input.value.toLowerCase().trim();
            
            indiceSeleccionado = -1; // Reset al filtrar
            
            if (!texto) {
                contenedor.style.display = 'none';
                return;
            }

            const coincidencias = listaFabricantes.filter(fab => 
                fab[1].toLowerCase().includes(texto)
            );

            if (coincidencias.length > 0) {
                contenedor.innerHTML = coincidencias.map((fab, idx) => 
                    `<div class="sugerencia-fab" 
                        data-fab-id="${fab[0]}" 
                        data-fab-nombre="${fab[1].replace(/"/g, '&quot;')}"
                        data-index="${idx}"
                        onclick="seleccionarFabricante(${medId}, ${fab[0]}, '${fab[1].replace(/'/g, "\\'")}')"
                        style="padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #eee;">
                        ${fab[1]}
                    </div>`
                ).join('');
                contenedor.style.display = 'block';
            } else {
                contenedor.innerHTML = `<div style="padding: 6px 8px; color: #999;">‚Äì Presiona Enter para crear "${input.value}" ‚Äì</div>`;
                contenedor.style.display = 'block';
            }
        }

        function seleccionarFabricante(medId, fabId, fabNombre) {
            document.getElementById(`busqueda_fab_${medId}`).value = fabNombre;
            document.getElementById(`fabricante_${medId}`).value = fabId;
            document.getElementById(`sugerencias_fab_${medId}`).style.display = 'none';
            marcarFabricanteValidado(medId);
        }

        // === CREAR O SELECCIONAR AL PRESIONAR ENTER ===
        function confirmarCrearFabricante(medId) {
            const input = document.getElementById(`busqueda_fab_${medId}`);
            const nombreEscrito = input.value.trim();

            if (!nombreEscrito) return;

            // Buscar coincidencia EXACTA en la lista global
            const fabricanteExistente = listaFabricantes.find(fab => 
                fab[1].toLowerCase() === nombreEscrito.toLowerCase()
            );

            if (fabricanteExistente) {
                // ‚úÖ Existe: seleccionar autom√°ticamente
                seleccionarFabricante(medId, fabricanteExistente[0], fabricanteExistente[1]);
            } else {
                // ‚úÖ NO existe: crear autom√°ticamente sin confirmaci√≥n
                fetch('/admin/fabricantes/by_name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: nombreEscrito })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.ok && data.fabricante) {
                        const fab = data.fabricante;
                        // Agregar a la lista global
                        listaFabricantes.push([fab.id, fab.nombre]);
                        // Seleccionar autom√°ticamente
                        seleccionarFabricante(medId, fab.id, fab.nombre);
                    } else {
                        alert('‚ùå Error al crear el fabricante');
                    }
                })
                .catch(err => {
                    alert('‚ùå Error de red: ' + err.message);
                });
            }
        }



        // === FUNCIONES EXISTENTES ===
        function crearFabricante(medId) {
            const nombreNuevo = prompt("Ingresa el nombre del nuevo fabricante:");
            if (!nombreNuevo || nombreNuevo.trim() === '') return;
            fetch('/admin/fabricantes/by_name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: nombreNuevo.trim() })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok && data.fabricante) {
                    const select = document.getElementById(`fabricante_${medId}`);
                    const fab = data.fabricante;
                    if (!select.querySelector(`option[value="${fab.id}"]`)) {
                        const option = document.createElement('option');
                        option.value = fab.id;
                        option.textContent = fab.nombre;
                        select.appendChild(option);
                    }
                    select.value = fab.id;
                    select.classList.add('campo-validado');
                    marcarPasoValidado(medId, 'fabricante');
                    const primerPrecio = document.querySelector(`.precio-competidor[data-med-id="${medId}"]`);
                    if (primerPrecio) primerPrecio.focus();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'No se pudo procesar la solicitud'));
                }
            })
            .catch(err => {
                alert('‚ùå Error de red: ' + err.message);
            });
        }
        function limpiarNombreMedicamento(nombre) {
            const presentaciones = [
                'tableta', 'tablet', 'capsula', 'c√°psula', 'jarabe', 'soluci√≥n',
                'inyecci√≥n', 'inyeccion', 'spray', 'crema', 'ung√ºento', 'polvo',
                'gotas', 'gota', 'comprimido', 'c√°psula', 'ampolla', 'vial',
                'suspensi√≥n', 'emulsi√≥n', 'loci√≥n', 'pasta', 'pomada', 'gel'
            ];
            let resultado = nombre;
            resultado = resultado.replace(/\b(caja|display|blister|tubo|frasco)\s+[x|por]\s*\d+\b/gi, '');
            resultado = resultado.replace(/\bx\s*\d+\b/gi, '');
            resultado = resultado.replace(/\bpor\s*\d+\b/gi, '');
            let resultadoLower = resultado.toLowerCase();
            for (let palabra of presentaciones) {
                const index = resultadoLower.indexOf(palabra);
                if (index !== -1) {
                    resultado = resultado.substring(0, index).trim();
                    resultadoLower = resultado.toLowerCase();
                    break;
                }
            }
            resultado = resultado.replace(/\s+/g, ' ').trim();
            return resultado || nombre;
        }
        function guardarPrecios(medId, precioId) {
            const fabricanteId = document.getElementById(`fabricante_${medId}`).value;
            if (!fabricanteId) {
                alert('Selecciona un fabricante');
                return;
            }
            const precios = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
            const valores = Array.from(precios)
                .map(input => parseFloat(input.value) || 0)
                .filter(val => val > 0);
            const precioSugeridoInput = document.getElementById(`sugerido_${medId}`);
            const precioSugerido = parseFloat(precioSugeridoInput.value) || 0;
            if (precioSugerido <= 0) {
                alert('Ingresa precios v√°lidos de las farmacias');
                return;
            }
            const esEscaso = document.getElementById(`btn_escaso_${medId}`).classList.contains('escaso');
            const usarMinimo = esEscaso || valores.length === 1;
            let advertencia = false;
            let mensaje = "";
            if (valores.length > 0) {
                if (usarMinimo) {
                    const minCompetencia = Math.min(...valores);
                    if (precioSugerido < minCompetencia) {
                        advertencia = true;
                        mensaje = `Tu precio ($${precioSugerido}) est√° DEBAJO del √∫nico precio de competencia ($${minCompetencia})`;
                    }
                } else {
                    const maxCompetencia = Math.max(...valores);
                    if (precioSugerido > maxCompetencia) {
                        advertencia = true;
                        mensaje = `Tu precio ($${precioSugerido}) est√° ARRIBA del m√°ximo de competencia ($${maxCompetencia})`;
                    }
                }
            }
            if (advertencia) {
                const confirmar = confirm(`‚ö†Ô∏è ADVERTENCIA\n\n${mensaje}\n\n¬øDeseas continuar?`);
                if (!confirmar) return;
            }
            fetch('/admin/precios/guardar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: precioId || null,
                    medicamento_id: medId,
                    fabricante_id: fabricanteId,
                    precio: precioSugerido
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    if (!precioId && data.precio_id) {
                        const card = document.querySelector(`[data-med-id="${medId}"]`);
                        card.dataset.precioId = data.precio_id;
                        const contenedorImg = document.getElementById(`imagen-contenedor_${medId}`);
                        if (contenedorImg) contenedorImg.dataset.precioId = data.precio_id;
                        const preciosInputs = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
                        preciosInputs.forEach(p => {
                            if (parseFloat(p.value) > 0) p.classList.add('campo-validado');
                        });
                    }
                    const aviso = document.getElementById(`guardado_precio_${medId}`);
                    aviso.textContent = '‚úÖ Guardado';
                    setTimeout(() => { aviso.textContent = ''; }, 2000);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'desconocido'));
                }
            })
            .catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        }
        
        function agregarFabricante(medId) {
            const precios = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
            precios.forEach(input => {
                input.value = '';
                input.classList.remove('campo-validado');
            });
            
            document.getElementById(`sugerido_${medId}`).value = '';
            document.getElementById(`busqueda_fab_${medId}`).value = '';
            document.getElementById(`busqueda_fab_${medId}`).classList.remove('campo-validado');
            document.getElementById(`fabricante_${medId}`).value = '';
            document.getElementById(`sugerencias_fab_${medId}`).style.display = 'none';
            
            const card = document.querySelector(`[data-med-id="${medId}"]`);
            card.dataset.precioId = '';
            
            const pasos = JSON.parse(card.dataset.pasosValidados);
            pasos.fabricante = false;
            pasos.precios = false;
            pasos.imagen = false;
            card.dataset.pasosValidados = JSON.stringify(pasos);
            
            const contenedorImg = document.getElementById(`imagen-contenedor_${medId}`);
            if (contenedorImg) {
                contenedorImg.dataset.precioId = '';
                contenedorImg.style.borderColor = '';
                contenedorImg.style.backgroundColor = '';
                const img = contenedorImg.querySelector('img');
                img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Crect fill='%23f0f0f0' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' fill='%23999' font-size='14' text-anchor='middle' dominant-baseline='middle'%3E+%3C/text%3E%3C/svg%3E";
            }
            
            document.getElementById(`busqueda_fab_${medId}`).focus();
            card.scrollIntoView({ behavior: 'smooth' });
        }
        
        function crearNuevoMedicamentoDesdeNombre(medId) {
            const nombre = document.getElementById(`nombre_${medId}`).value.trim();
            if (!nombre) {
                alert('Ingresa un nombre v√°lido para el medicamento.');
                return;
            }
            if (!confirm(`¬øCrear un nuevo medicamente con el nombre:\n"${nombre}"?`)) {
                return;
            }
            fetch('/crear_medicamento_rapido', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: nombre })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    alert(`‚úÖ ${data.exists ? 'Ya exist√≠a' : 'Nuevo'} medicamento: "${data.nombre}"\n\nAhora est√°s editando este registro.`);
                    window.location.href = window.location.pathname + '?med_id=' + data.id;
                } else {
                    alert('‚ùå Error: ' + (data.error || 'No se pudo crear el medicamento'));
                }
            })
            .catch(err => {
                alert('‚ùå Error de red: ' + err.message);
            });
        }
        function eliminarMedicamento(medId) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar este medicamento y todos sus datos asociados?')) return;
            fetch(`/medicamentos/eliminar/${medId}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    alert('‚úÖ ' + data.mensaje);
                    location.reload();
                } else {
                    alert('‚ùå ' + data.error);
                }
            })
            .catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        }
        function manualSiguienteMedicamento(medId) {
            location.reload();
        }


        function navegarSugerenciasFabricante(medId, event) {
            const contenedor = document.getElementById(`sugerencias_fab_${medId}`);
            const sugerencias = contenedor.querySelectorAll('.sugerencia-fab');
            
            if (sugerencias.length === 0) return;
            
            // Flecha abajo
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                indiceSeleccionado = Math.min(indiceSeleccionado + 1, sugerencias.length - 1);
                actualizarSeleccionVisual(sugerencias);
            }
            
            // Flecha arriba
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                indiceSeleccionado = Math.max(indiceSeleccionado - 1, -1);
                actualizarSeleccionVisual(sugerencias);
            }
            
            // Enter con elemento seleccionado
            if (event.key === 'Enter' && indiceSeleccionado >= 0) {
                event.preventDefault();
                const seleccionada = sugerencias[indiceSeleccionado];
                const fabId = parseInt(seleccionada.dataset.fabId);
                const fabNombre = seleccionada.dataset.fabNombre;
                seleccionarFabricante(medId, fabId, fabNombre);
            }
            
            // Escape: cerrar lista
            if (event.key === 'Escape') {
                contenedor.style.display = 'none';
                indiceSeleccionado = -1;
            }
        }

        function actualizarSeleccionVisual(sugerencias) {
            sugerencias.forEach((sug, idx) => {
                if (idx === indiceSeleccionado) {
                    sug.style.background = '#e8f5e9';
                    sug.style.fontWeight = 'bold';
                    sug.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    sug.style.background = 'white';
                    sug.style.fontWeight = 'normal';
                }
            });
        }


        document.addEventListener('DOMContentLoaded', function() {
            const medicamentos = document.querySelectorAll('.medicamento-card');
            if (medicamentos.length > 0) {
                const medId = medicamentos[0].dataset.medId;
                const inputNombre = document.getElementById(`nombre_${medId}`);
                if (inputNombre) {
                    inputNombre.focus();
                }
            }
        });
    </script>
</body>
</html>