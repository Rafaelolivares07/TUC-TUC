<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugerir S√≠ntomas - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sticky buttons en mobile */
        @media (max-width: 768px) {
            .sticky-buttons {
                position: sticky;
                bottom: 0;
                z-index: 40;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-6xl pb-32 md:pb-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">
                ü©∫ Sugerir S√≠ntomas a Medicamentos
            </h1>

            {% if total_pendientes %}
            <div class="text-sm text-gray-600">
                Medicamentos pendientes: <span class="font-bold text-blue-600">{{ total_pendientes }}</span>
            </div>
            {% endif %}
        </div>

        {% if not medicamento %}
        <!-- No hay medicamentos pendientes -->
        <div class="bg-green-50 border border-green-300 rounded-lg p-8 text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h2 class="text-xl font-bold text-green-800">{{ mensaje }}</h2>
            <a href="/admin" class="mt-4 inline-block px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                Volver al Admin
            </a>
        </div>
        {% else %}

        <!-- FILTROS (Colapsables, arriba del selector) -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <button id="toggleFiltros" class="w-full flex justify-between items-center text-left font-semibold text-gray-700 hover:bg-gray-50 p-3 rounded-lg transition-colors border-2 border-dashed border-gray-300">
                <span>üîç Filtros <span id="contadorFiltros" class="text-blue-600 font-bold"></span></span>
                <span id="iconoFiltros" class="transform transition-transform text-xl">‚ñº</span>
            </button>

            <div id="panelFiltros" class="hidden mt-4 space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de medicamento:</label>
                    <select id="filtroTipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="todos">Todos</option>
                        <option value="genericos">Solo Gen√©ricos</option>
                        <option value="comerciales">Solo Comerciales</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Precio:</label>
                    <select id="filtroPrecio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="todos">Todos</option>
                        <option value="con">Con precio</option>
                        <option value="sin">Sin precio</option>
                    </select>
                </div>

                <!-- Contador detallado -->
                <div id="detalleContadores" class="mt-3 p-3 bg-gray-50 rounded-lg text-sm">
                    <p class="text-gray-600">Cargando contadores...</p>
                </div>
            </div>
        </div>

        <!-- SELECTOR DE MEDICAMENTO -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Medicamento actual:</label>
            <select id="selectorMedicamento" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                {% for med in medicamentos_list %}
                <option value="{{ med.id }}" {% if med.id == medicamento.id %}selected{% endif %}>
                    {{ med.nombre }}
                    {% if med.componente_activo_id is none %}[Gen√©rico]{% endif %}
                    {% if med.tiene_precio == 0 %}[Sin precio]{% endif %}
                </option>
                {% endfor %}
            </select>

            <!-- COMPONENTE ACTIVO - Display y gesti√≥n -->
            <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <!-- Display del componente activo actual -->
                {% if medicamento.componente_activo_nombre %}
                <div class="flex items-center text-sm mb-2">
                    <span class="text-green-600 font-semibold">‚úÖ Componente activo:</span>
                    <span id="componenteActivoDisplay" class="ml-2 font-medium text-gray-800">{{ medicamento.componente_activo_nombre }}</span>
                </div>
                {% else %}
                <div class="flex items-center text-sm mb-2">
                    <span class="text-amber-600 font-semibold">‚ö†Ô∏è Este producto NO tiene componente activo asignado</span>
                </div>
                {% endif %}

                <!-- Bot√≥n para buscar/cambiar componente activo -->
                {% if medicamento.componente_activo_nombre %}
                <button id="btnBuscarComponente" class="w-full px-3 py-2 bg-amber-500 text-white text-sm rounded-lg hover:bg-amber-600 transition">
                    üîÑ Cambiar componente activo
                </button>
                {% else %}
                <button id="btnBuscarComponente" class="w-full px-3 py-2 bg-amber-500 text-white text-sm rounded-lg hover:bg-amber-600 transition">
                    üîç ¬øCu√°l es el componente activo de "{{ medicamento.nombre }}"?
                </button>
                {% endif %}

                <!-- Panel colapsado para asignar/cambiar componente activo -->
                <div id="panelComponenteActivo" class="hidden mt-3 space-y-2">
                    <!-- Input de b√∫squeda -->
                    <div class="relative">
                        <input
                            type="text"
                            id="inputComponenteActivo"
                            placeholder="Escribe el nombre del componente activo..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            autocomplete="off"
                        />
                        <!-- Indicador de b√∫squeda -->
                        <div id="searchingIndicator" class="hidden absolute right-3 top-2.5">
                            <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        </div>
                    </div>

                    <!-- Dropdown de sugerencias -->
                    <div id="dropdownComponentes" class="hidden max-h-48 overflow-y-auto border border-gray-300 rounded-lg bg-white shadow-lg">
                        <!-- Se llenar√° din√°micamente con JavaScript -->
                    </div>

                    <!-- Mensajes de feedback -->
                    <div id="feedbackComponente" class="hidden text-sm"></div>

                    <!-- Bot√≥n para colapsar el panel -->
                    <button id="btnColapsarPanel" class="w-full px-2 py-1 text-xs text-gray-600 hover:text-gray-800">
                        ‚ñ≤ Cerrar panel
                    </button>
                </div>
            </div>

            <!-- Bot√≥n Google Search (existente, modificado) -->
            <button id="btnGoogleSearch" class="mt-3 w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                {% if medicamento.componente_activo_nombre %}
                üîç Para qu√© sirve "{{ medicamento.componente_activo_nombre }}"
                {% else %}
                üîç Para qu√© sirve "{{ medicamento.nombre }}"
                {% endif %}
            </button>
        </div>

        <!-- Data del medicamento actual para JS -->
        <script>
            window.medicamentoActual = {
                id: {{ medicamento.id }},
                nombre: "{{ medicamento.nombre }}",
                componente_activo: "{{ medicamento.componente_activo_nombre or '' }}",
                componente_activo_id: {{ medicamento.componente_activo_id or 'null' }}
            };
        </script>

        <!-- √ÅREA DE PEGADO Y PROCESAMIENTO -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-semibold text-gray-700 mb-3">üìã Procesar texto del medicamento</h3>

            <textarea id="textoPegar" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3"
                placeholder="Pega aqu√≠ el texto del medicamento (min. 20 caracteres) y presiona 'Procesar'..."></textarea>

            <button id="btnProcesarTexto" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                ‚ñ∂ Procesar Texto
            </button>

            <div id="mensajeProcesando" class="hidden mt-3 text-center text-gray-600">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <p class="mt-2">Procesando texto...</p>
            </div>
        </div>

        <!-- VALIDACI√ìN DEL TEXTO (se muestra despu√©s de procesar) -->
        <div id="panelValidacion" class="hidden bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-semibold text-gray-700 mb-2">Validaci√≥n del texto:</h3>
            <div id="resultadoValidacion"></div>
        </div>

        <!-- TEXTAREA COLAPSABLE -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <button id="toggleTextarea" class="w-full flex justify-between items-center text-left font-semibold text-gray-700 hover:bg-gray-50 p-3 rounded-lg transition-colors">
                <span>üìÑ Ver/Editar Texto Procesado (click para expandir)</span>
                <span id="iconoTextarea" class="transform transition-transform text-xl">‚ñ∂</span>
            </button>

            <div id="panelTextarea" class="hidden mt-4">
                <textarea id="textoPegado" rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="El texto procesado aparecer√° aqu√≠..."></textarea>
            </div>
        </div>

        <!-- DIAGN√ìSTICOS DETECTADOS -->
        <div id="panelDiagnosticos" class="hidden bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-semibold text-gray-700 mb-3">üè• Diagn√≥sticos Detectados:</h3>
            <div id="listaDiagnosticos" class="space-y-2"></div>
        </div>

        <!-- S√çNTOMAS DETECTADOS -->
        <div id="panelSintomas" class="hidden bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-semibold text-gray-700 mb-3">üíä S√≠ntomas Detectados:</h3>
            <div id="listaSintomas" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
        </div>

        <!-- BOTONES DE ACCI√ìN (Sticky en mobile) -->
        <div class="sticky-buttons bg-white rounded-lg shadow-lg p-4 space-y-3">
            <button id="btnGuardar" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
                üíæ Guardar y Continuar
            </button>

            <div class="flex gap-2">
                <button id="btnOmitir" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                    ‚è≠Ô∏è Omitir
                </button>
                <a href="/admin" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-center">
                    üö™ Salir
                </a>
            </div>
        </div>

        {% endif %}
    </div>

    <script>
        // Estado global
        let diagnosticosSeleccionados = new Set();
        let sintomasSeleccionados = new Set();
        let diagnosticosData = [];
        let sintomasData = [];

        // Elementos DOM
        const btnProcesarTexto = document.getElementById('btnProcesarTexto');
        const btnGuardar = document.getElementById('btnGuardar');
        const btnGoogleSearch = document.getElementById('btnGoogleSearch');
        const selectorMedicamento = document.getElementById('selectorMedicamento');
        const filtroTipo = document.getElementById('filtroTipo');
        const filtroPrecio = document.getElementById('filtroPrecio');
        const textoPegar = document.getElementById('textoPegar');
        const textoPegado = document.getElementById('textoPegado');
        const mensajeProcesando = document.getElementById('mensajeProcesando');
        const panelValidacion = document.getElementById('panelValidacion');
        const resultadoValidacion = document.getElementById('resultadoValidacion');
        const panelDiagnosticos = document.getElementById('panelDiagnosticos');
        const panelSintomas = document.getElementById('panelSintomas');
        const listaDiagnosticos = document.getElementById('listaDiagnosticos');
        const listaSintomas = document.getElementById('listaSintomas');

        // Colapsables
        const toggleFiltros = document.getElementById('toggleFiltros');
        const panelFiltros = document.getElementById('panelFiltros');
        const iconoFiltros = document.getElementById('iconoFiltros');
        const toggleTextarea = document.getElementById('toggleTextarea');
        const panelTextarea = document.getElementById('panelTextarea');
        const iconoTextarea = document.getElementById('iconoTextarea');

        // Elementos del componente activo
        const btnBuscarComponente = document.getElementById('btnBuscarComponente');
        const panelComponenteActivo = document.getElementById('panelComponenteActivo');
        const inputComponenteActivo = document.getElementById('inputComponenteActivo');
        const dropdownComponentes = document.getElementById('dropdownComponentes');
        const searchingIndicator = document.getElementById('searchingIndicator');
        const feedbackComponente = document.getElementById('feedbackComponente');
        const btnColapsarPanel = document.getElementById('btnColapsarPanel');
        const componenteActivoDisplay = document.getElementById('componenteActivoDisplay');

        // Estado del componente activo
        let componentesActivos = [];
        let selectedIndex = -1;
        let searchTimeout = null;

        // ============================================================
        // L√ìGICA DEL COMPONENTE ACTIVO
        // ============================================================

        // Bot√≥n buscar/cambiar componente activo
        btnBuscarComponente?.addEventListener('click', () => {
            // Abrir Google
            const query = `cu√°l es el componente activo de ${window.medicamentoActual.nombre}`;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');

            // Desplegar panel
            panelComponenteActivo.classList.remove('hidden');
            inputComponenteActivo.focus();
        });

        // Colapsar panel
        btnColapsarPanel?.addEventListener('click', () => {
            panelComponenteActivo.classList.add('hidden');
            inputComponenteActivo.value = '';
            dropdownComponentes.classList.add('hidden');
            feedbackComponente.classList.add('hidden');
        });

        // Input de b√∫squeda con autocompletado
        inputComponenteActivo?.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            // Limpiar timeout anterior
            if (searchTimeout) clearTimeout(searchTimeout);

            if (query.length < 2) {
                dropdownComponentes.classList.add('hidden');
                feedbackComponente.classList.add('hidden');
                return;
            }

            // Mostrar indicador de b√∫squeda
            searchingIndicator.classList.remove('hidden');

            // Debounce de 300ms
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/admin/buscar-componentes-activos?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    searchingIndicator.classList.add('hidden');

                    if (data.ok) {
                        componentesActivos = data.componentes;
                        mostrarSugerencias(componentesActivos, query);
                    }
                } catch (error) {
                    console.error('Error buscando componentes:', error);
                    searchingIndicator.classList.add('hidden');
                }
            }, 300);
        });

        // Navegaci√≥n con teclado en el input
        inputComponenteActivo?.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (!dropdownComponentes.classList.contains('hidden')) {
                    selectedIndex = 0;
                    actualizarSeleccion();
                    dropdownComponentes.querySelector('.dropdown-item')?.focus();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const query = inputComponenteActivo.value.trim();
                if (query.length >= 2) {
                    crearNuevoComponenteActivo(query);
                }
            }
        });

        // Mostrar sugerencias en el dropdown
        function mostrarSugerencias(componentes, query) {
            if (componentes.length === 0) {
                dropdownComponentes.classList.add('hidden');
                feedbackComponente.classList.remove('hidden');
                feedbackComponente.className = 'text-sm text-amber-600 p-2 bg-amber-50 rounded border border-amber-200';
                feedbackComponente.textContent = `No existe "${query}" como componente activo. Presiona Enter para crear uno nuevo.`;
                return;
            }

            feedbackComponente.classList.add('hidden');
            dropdownComponentes.classList.remove('hidden');
            dropdownComponentes.innerHTML = componentes.map((comp, index) => `
                <div class="dropdown-item px-3 py-2 hover:bg-blue-50 cursor-pointer focus:bg-blue-100 focus:outline-none"
                     tabindex="0"
                     data-index="${index}"
                     data-id="${comp.id}"
                     data-nombre="${comp.nombre}">
                    <div class="font-medium text-gray-800">${comp.nombre}</div>
                    ${comp.usado_en ? `<div class="text-xs text-gray-500">Usado en: ${comp.usado_en}</div>` : ''}
                </div>
            `).join('');

            // Event listeners para items del dropdown
            dropdownComponentes.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    asignarComponenteActivo(item.dataset.id, item.dataset.nombre);
                });

                item.addEventListener('keydown', (e) => {
                    const currentIndex = parseInt(item.dataset.index);

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const nextItem = dropdownComponentes.querySelector(`[data-index="${currentIndex + 1}"]`);
                        if (nextItem) nextItem.focus();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (currentIndex === 0) {
                            inputComponenteActivo.focus();
                        } else {
                            const prevItem = dropdownComponentes.querySelector(`[data-index="${currentIndex - 1}"]`);
                            if (prevItem) prevItem.focus();
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        asignarComponenteActivo(item.dataset.id, item.dataset.nombre);
                    }
                });
            });
        }

        function actualizarSeleccion() {
            dropdownComponentes.querySelectorAll('.dropdown-item').forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('bg-blue-100');
                } else {
                    item.classList.remove('bg-blue-100');
                }
            });
        }

        // Asignar componente activo existente
        async function asignarComponenteActivo(componenteId, componenteNombre) {
            try {
                const response = await fetch('/admin/asignar-componente-activo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        medicamento_id: window.medicamentoActual.id,
                        componente_activo_id: componenteId
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    // Actualizar UI
                    window.medicamentoActual.componente_activo = componenteNombre;
                    window.medicamentoActual.componente_activo_id = componenteId;

                    feedbackComponente.classList.remove('hidden');
                    feedbackComponente.className = 'text-sm text-green-600 p-2 bg-green-50 rounded border border-green-200';
                    feedbackComponente.textContent = `‚úÖ Componente activo asignado: ${componenteNombre}`;

                    // Recargar p√°gina para actualizar todo el contexto
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Error al asignar componente activo: ' + data.error);
                }
            } catch (error) {
                console.error('Error asignando componente:', error);
                alert('Error al asignar componente activo');
            }
        }

        // Crear nuevo componente activo
        async function crearNuevoComponenteActivo(nombre) {
            // Normalizar nombre
            const nombreNormalizado = nombre.trim().toLowerCase();

            // Verificar si ya existe con normalizaci√≥n
            const existe = componentesActivos.some(c =>
                c.nombre.toLowerCase() === nombreNormalizado
            );

            if (existe) {
                feedbackComponente.classList.remove('hidden');
                feedbackComponente.className = 'text-sm text-red-600 p-2 bg-red-50 rounded border border-red-200';
                feedbackComponente.textContent = `‚ùå Ya existe un componente activo con ese nombre`;
                return;
            }

            // Confirmar creaci√≥n
            if (!confirm(`¬øCrear nuevo componente activo "${nombre}" y asignarlo a este medicamento?`)) {
                return;
            }

            try {
                const response = await fetch('/admin/crear-componente-activo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre: nombre,
                        medicamento_id: window.medicamentoActual.id
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    feedbackComponente.classList.remove('hidden');
                    feedbackComponente.className = 'text-sm text-green-600 p-2 bg-green-50 rounded border border-green-200';
                    feedbackComponente.textContent = `‚úÖ Componente activo "${nombre}" creado y asignado`;

                    // Recargar p√°gina
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Error al crear componente activo: ' + data.error);
                }
            } catch (error) {
                console.error('Error creando componente:', error);
                alert('Error al crear componente activo');
            }
        }

        // ============================================================
        // FIN L√ìGICA DEL COMPONENTE ACTIVO
        // ============================================================

        // Toggle filtros
        toggleFiltros?.addEventListener('click', () => {
            panelFiltros.classList.toggle('hidden');
            iconoFiltros.classList.toggle('rotate-180');
        });

        // Toggle textarea
        toggleTextarea?.addEventListener('click', () => {
            panelTextarea.classList.toggle('hidden');
            iconoTextarea.classList.toggle('rotate-90');
        });

        // Google Search
        btnGoogleSearch?.addEventListener('click', () => {
            // Usar componente activo si existe, sino el nombre
            const termino = window.medicamentoActual.componente_activo || window.medicamentoActual.nombre;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(termino)}`, '_blank');
        });

        // Auto-cargar al cambiar medicamento
        selectorMedicamento?.addEventListener('change', (e) => {
            const medId = e.target.value;
            if (medId) {
                // Agregar timestamp para forzar recarga y evitar cach√©
                window.location.href = `/admin/sugerir-sintomas/${medId}?t=${Date.now()}`;
            }
        });

        // Filtros - aplicar al cambiar
        filtroTipo?.addEventListener('change', aplicarFiltros);
        filtroPrecio?.addEventListener('change', aplicarFiltros);

        async function aplicarFiltros() {
            const tipo = filtroTipo.value;
            const precio = filtroPrecio.value;

            try {
                const response = await fetch(`/admin/sugerir-sintomas/filtrar?tipo=${tipo}&precio=${precio}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.ok) {
                    const total = data.medicamentos.length;

                    // Contar por tipo y precio
                    const genericos = data.medicamentos.filter(m => m.es_generico).length;
                    const comerciales = total - genericos;
                    const conPrecio = data.medicamentos.filter(m => m.tiene_precio).length;
                    const sinPrecio = total - conPrecio;

                    // Actualizar contador principal (en bot√≥n de filtros)
                    document.getElementById('contadorFiltros').textContent = `(${total} encontrados)`;

                    // Actualizar contador detallado
                    document.getElementById('detalleContadores').innerHTML = `
                        <p class="font-semibold text-gray-700 mb-2">Resultados: <span class="text-blue-600">${total} medicamentos</span></p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-white p-2 rounded">
                                <span class="text-gray-600">Gen√©ricos:</span>
                                <span class="font-bold text-green-600">${genericos}</span>
                            </div>
                            <div class="bg-white p-2 rounded">
                                <span class="text-gray-600">Comerciales:</span>
                                <span class="font-bold text-blue-600">${comerciales}</span>
                            </div>
                            <div class="bg-white p-2 rounded">
                                <span class="text-gray-600">Con precio:</span>
                                <span class="font-bold text-green-600">${conPrecio}</span>
                            </div>
                            <div class="bg-white p-2 rounded">
                                <span class="text-gray-600">Sin precio:</span>
                                <span class="font-bold text-orange-600">${sinPrecio}</span>
                            </div>
                        </div>
                    `;

                    // Actualizar selector
                    selectorMedicamento.innerHTML = data.medicamentos.map(m =>
                        `<option value="${m.id}" ${m.id === {{ medicamento.id }} ? 'selected' : ''}>
                            ${m.nombre}
                            ${!m.es_generico ? '' : '[Gen√©rico]'}
                            ${m.tiene_precio ? '' : '[Sin precio]'}
                        </option>`
                    ).join('');

                    // Actualizar componente activo del primer medicamento seleccionado
                    if (data.medicamentos.length > 0) {
                        const primerMedicamento = data.medicamentos.find(m => m.id === {{ medicamento.id }}) || data.medicamentos[0];
                        if (componenteActivoDisplay && primerMedicamento.componente_activo_nombre) {
                            componenteActivoDisplay.textContent = primerMedicamento.componente_activo_nombre;
                        }
                    }
                }
            } catch (error) {
                console.error('Error aplicando filtros:', error);
                alert('Error al filtrar medicamentos');
            }
        }

        // Cargar contadores iniciales al abrir la p√°gina
        if (filtroTipo && filtroPrecio) {
            aplicarFiltros();
        }

        // Procesar texto pegado manualmente
        btnProcesarTexto?.addEventListener('click', async () => {
            try {
                const texto = textoPegar.value.trim();

                if (!texto || texto.length < 20) {
                    alert('El texto es muy corto (m√≠nimo 20 caracteres)');
                    return;
                }

                // Guardar en el textarea de solo lectura tambi√©n
                textoPegado.value = texto;
                mensajeProcesando.classList.remove('hidden');
                btnProcesarTexto.disabled = true;

                // Enviar a procesar
                const response = await fetch('/admin/sugerir-sintomas/procesar-texto/{{ medicamento.id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ texto })
                });

                const data = await response.json();
                mensajeProcesando.classList.add('hidden');
                btnProcesarTexto.disabled = false;

                if (!data.ok) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Limpiar el textarea de entrada para el siguiente
                textoPegar.value = '';

                // Mostrar validaci√≥n
                mostrarValidacion(data.validacion);

                // Mostrar diagn√≥sticos
                diagnosticosData = data.diagnosticos || [];
                mostrarDiagnosticos(diagnosticosData);

                // Mostrar s√≠ntomas
                sintomasData = data.sintomas || [];
                mostrarSintomas(sintomasData);

                // Habilitar bot√≥n guardar
                btnGuardar.disabled = false;

                // Guardar el texto fuente completo en la BD
                try {
                    await fetch('/admin/sugerir-sintomas/guardar-texto-fuente/{{ medicamento.id }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ texto_fuente: texto })
                    });
                    console.log('‚úÖ Texto fuente guardado en BD');
                } catch (errorTexto) {
                    console.warn('‚ö†Ô∏è No se pudo guardar texto fuente:', errorTexto);
                    // No mostramos error al usuario porque es secundario
                }

            } catch (error) {
                console.error('Error:', error);
                mensajeProcesando.classList.add('hidden');
                btnProcesarTexto.disabled = false;
                alert('Error al procesar texto: ' + error.message);
            }
        });

        function mostrarValidacion(validacion) {
            panelValidacion.classList.remove('hidden');

            if (validacion.coincide) {
                resultadoValidacion.innerHTML = `
                    <div class="flex items-center text-green-700 bg-green-50 p-3 rounded-lg">
                        <span class="text-2xl mr-3">‚úÖ</span>
                        <div>
                            <div class="font-semibold">Texto validado correctamente</div>
                            <div class="text-sm">${validacion.mensaje}</div>
                        </div>
                    </div>
                `;
            } else {
                resultadoValidacion.innerHTML = `
                    <div class="flex items-center text-orange-700 bg-orange-50 p-3 rounded-lg">
                        <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                        <div>
                            <div class="font-semibold">Posible discrepancia</div>
                            <div class="text-sm">${validacion.mensaje}</div>
                            <div class="text-sm mt-1">Puedes continuar si est√°s seguro</div>
                        </div>
                    </div>
                `;
            }
        }

        function mostrarDiagnosticos(diagnosticos) {
            if (diagnosticos.length === 0) {
                panelDiagnosticos.classList.add('hidden');
                return;
            }

            panelDiagnosticos.classList.remove('hidden');

            // Inicializar todos como seleccionados
            diagnosticosSeleccionados.clear();
            diagnosticos.forEach((d, idx) => {
                diagnosticosSeleccionados.add(idx);
            });

            listaDiagnosticos.innerHTML = diagnosticos.map((diag, idx) => `
                <div class="diagnostico-item cursor-pointer p-3 rounded-lg border-2 transition-all bg-green-50 border-green-500"
                     data-idx="${idx}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <span class="checkmark text-2xl mr-3">‚úì</span>
                            <span class="font-semibold">${diag.nombre}</span>
                            ${diag.nuevo ? '<span class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded">NUEVO</span>' : ''}
                        </div>
                    </div>
                    ${diag.sintomas && diag.sintomas.length > 0 ? `
                        <div class="ml-10 mt-2 text-sm text-gray-600">
                            S√≠ntomas: ${diag.sintomas.join(', ')}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Event listeners para toggle
            document.querySelectorAll('.diagnostico-item').forEach(item => {
                item.addEventListener('click', () => {
                    const idx = parseInt(item.dataset.idx);
                    toggleDiagnostico(idx, item);
                });
            });
        }

        function mostrarSintomas(sintomas) {
            if (sintomas.length === 0) {
                panelSintomas.classList.add('hidden');
                return;
            }

            panelSintomas.classList.remove('hidden');

            // Inicializar todos como seleccionados
            sintomasSeleccionados.clear();
            sintomas.forEach((s, idx) => {
                sintomasSeleccionados.add(idx);
            });

            listaSintomas.innerHTML = sintomas.map((sintoma, idx) => `
                <div class="sintoma-item cursor-pointer p-3 rounded-lg border-2 transition-all bg-green-50 border-green-500"
                     data-idx="${idx}">
                    <div class="flex items-center">
                        <span class="checkmark text-xl mr-2">‚úì</span>
                        <span class="font-medium">${sintoma.label}</span>
                        ${sintoma.nuevo ? '<span class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded">NUEVO</span>' : ''}
                    </div>
                </div>
            `).join('');

            // Event listeners para toggle
            document.querySelectorAll('.sintoma-item').forEach(item => {
                item.addEventListener('click', () => {
                    const idx = parseInt(item.dataset.idx);
                    toggleSintoma(idx, item);
                });
            });
        }

        function toggleDiagnostico(idx, element) {
            if (diagnosticosSeleccionados.has(idx)) {
                // Deseleccionar
                diagnosticosSeleccionados.delete(idx);
                element.classList.remove('bg-green-50', 'border-green-500');
                element.classList.add('bg-gray-50', 'border-gray-300');
                element.querySelector('.checkmark').textContent = '‚óã';
            } else {
                // Seleccionar
                diagnosticosSeleccionados.add(idx);
                element.classList.remove('bg-gray-50', 'border-gray-300');
                element.classList.add('bg-green-50', 'border-green-500');
                element.querySelector('.checkmark').textContent = '‚úì';
            }
        }

        function toggleSintoma(idx, element) {
            if (sintomasSeleccionados.has(idx)) {
                // Deseleccionar
                sintomasSeleccionados.delete(idx);
                element.classList.remove('bg-green-50', 'border-green-500');
                element.classList.add('bg-gray-50', 'border-gray-300');
                element.querySelector('.checkmark').textContent = '‚óã';
            } else {
                // Seleccionar
                sintomasSeleccionados.add(idx);
                element.classList.remove('bg-gray-50', 'border-gray-300');
                element.classList.add('bg-green-50', 'border-green-500');
                element.querySelector('.checkmark').textContent = '‚úì';
            }
        }

        // Guardar
        btnGuardar?.addEventListener('click', async () => {
            // Preparar datos
            const sintomasIds = [];
            const diagnosticosIds = [];
            const nuevosSintomas = [];
            const nuevosDiagnosticos = [];

            // Procesar diagn√≥sticos seleccionados
            diagnosticosSeleccionados.forEach(idx => {
                const diag = diagnosticosData[idx];
                if (diag.nuevo) {
                    nuevosDiagnosticos.push({
                        nombre: diag.nombre,
                        sintomas: diag.sintomas || []
                    });
                } else {
                    diagnosticosIds.push(diag.id);
                }
            });

            // Procesar s√≠ntomas seleccionados
            sintomasSeleccionados.forEach(idx => {
                const sintoma = sintomasData[idx];
                if (sintoma.nuevo) {
                    nuevosSintomas.push(sintoma.label);
                } else {
                    sintomasIds.push(sintoma.id);
                }
            });

            if (sintomasIds.length === 0 && nuevosSintomas.length === 0) {
                alert('Debes seleccionar al menos un s√≠ntoma');
                return;
            }

            btnGuardar.disabled = true;
            btnGuardar.textContent = 'Guardando...';

            try {
                const response = await fetch('/admin/sugerir-sintomas/guardar/{{ medicamento.id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        sintomas: sintomasIds,
                        diagnosticos: diagnosticosIds,
                        nuevos_sintomas: nuevosSintomas,
                        nuevos_diagnosticos: nuevosDiagnosticos
                    })
                });

                const data = await response.json();

                if (!data.ok) {
                    alert('Error: ' + data.error);
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'üíæ Guardar y Continuar';
                    return;
                }

                // Ir al siguiente medicamento
                if (data.siguiente_id) {
                    window.location.href = `/admin/sugerir-sintomas/${data.siguiente_id}?t=${Date.now()}`;
                } else {
                    window.location.href = `/admin/sugerir-sintomas?t=${Date.now()}`;
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar: ' + error.message);
                btnGuardar.disabled = false;
                btnGuardar.textContent = 'üíæ Guardar y Continuar';
            }
        });

        // Omitir (ir al siguiente sin guardar)
        document.getElementById('btnOmitir')?.addEventListener('click', async () => {
            if (!confirm('¬øOmitir este medicamento sin guardar s√≠ntomas?')) {
                return;
            }

            // Guardar vac√≠o para marcar como procesado y obtener siguiente
            try {
                const response = await fetch('/admin/sugerir-sintomas/guardar/{{ medicamento.id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        sintomas: [],
                        diagnosticos: [],
                        nuevos_sintomas: [],
                        nuevos_diagnosticos: []
                    })
                });

                const data = await response.json();

                if (data.ok && data.siguiente_id) {
                    window.location.href = `/admin/sugerir-sintomas/${data.siguiente_id}?t=${Date.now()}`;
                } else {
                    window.location.href = `/admin/sugerir-sintomas?t=${Date.now()}`;
                }
            } catch (error) {
                console.error('Error:', error);
                window.location.href = `/admin/sugerir-sintomas?t=${Date.now()}`;
            }
        });

        // Deshabilitar guardar hasta procesar texto
        if (btnGuardar) {
            btnGuardar.disabled = true;
        }
    </script>
</body>
</html>
