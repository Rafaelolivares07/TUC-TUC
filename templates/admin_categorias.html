<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Categorías</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Gestión de Categorías</h1>
                <p class="text-gray-600 mt-1">Organiza tus productos en categorías personalizadas</p>
            </div>
            <div class="flex gap-3">
                <button onclick="abrirModalNuevaCategoria()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                    + Nueva Categoría
                </button>
                <a href="{{ url_for('admin_menu') }}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                    ← Volver
                </a>
            </div>
        </div>

        <!-- Lista de Categorías -->
        <div id="categorias-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Se llenará dinámicamente -->
        </div>
    </div>

    <!-- Modal Nueva/Editar Categoría -->
    <div id="modal-categoria" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h2 id="modal-titulo" class="text-2xl font-bold mb-4">Nueva Categoría</h2>

            <form id="form-categoria" class="space-y-4">
                <input type="hidden" id="categoria-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                    <input type="text" id="categoria-nombre" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Medicamentos">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea id="categoria-descripcion" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Descripción breve"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL de Imagen</label>
                    <input type="url" id="categoria-imagen" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="https://...">
                    <p class="text-xs text-gray-500 mt-1">Sube la imagen a Cloudinary y pega la URL aquí</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Orden</label>
                        <input type="number" id="categoria-orden" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div class="flex items-center pt-6">
                        <input type="checkbox" id="categoria-activo" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="categoria-activo" class="ml-2 text-sm text-gray-700">Activo</label>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="categoria-destacada" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="categoria-destacada" class="ml-2 text-sm text-gray-700">Marcar como destacada (se muestra por defecto)</label>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">
                        Guardar
                    </button>
                    <button type="button" onclick="cerrarModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestionar Productos -->
    <div id="modal-productos" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h2 id="modal-productos-titulo" class="text-2xl font-bold mb-4">Productos de la Categoría</h2>

            <!-- Agregar producto -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Agregar Producto</h3>
                <div class="flex gap-2">
                    <input type="text" id="buscar-medicamento" placeholder="Buscar medicamento..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2" onkeyup="buscarMedicamentos(event)" onkeydown="navegarResultados(event)">
                    <button onclick="agregarProductoSeleccionado()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        Agregar
                    </button>
                </div>
                <div id="resultados-busqueda" class="mt-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg"></div>
            </div>

            <!-- Lista de productos -->
            <div id="productos-categoria-list" class="space-y-2">
                <!-- Se llenará dinámicamente -->
            </div>

            <div class="mt-6">
                <button onclick="cerrarModalProductos()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        let categorias = [];
        let categoriaActualProductos = null;
        let medicamentoSeleccionado = null;

        // Cargar categorías al iniciar
        document.addEventListener('DOMContentLoaded', cargarCategorias);

        async function cargarCategorias() {
            try {
                const res = await fetch('/api/admin/categorias');
                const data = await res.json();

                if (data.ok) {
                    categorias = data.categorias;
                    renderizarCategorias();
                }
            } catch (error) {
                console.error('Error cargando categorías:', error);
                alert('Error al cargar categorías');
            }
        }

        function renderizarCategorias() {
            const container = document.getElementById('categorias-list');

            if (categorias.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12">No hay categorías. Crea una nueva.</div>';
                return;
            }

            container.innerHTML = categorias.map(cat => `
                <div class="bg-white rounded-lg shadow p-6 border ${cat.es_destacada ? 'border-indigo-500 border-2' : 'border-gray-200'}">
                    ${cat.es_destacada ? '<span class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded mb-2">DESTACADA</span>' : ''}
                    ${cat.imagen ? `<img src="${cat.imagen}" alt="${cat.nombre}" class="w-16 h-16 object-cover rounded-full mb-3">` : ''}

                    <h3 class="text-xl font-bold text-gray-900">${cat.nombre}</h3>
                    <p class="text-sm text-gray-600 mt-1">${cat.descripcion || 'Sin descripción'}</p>

                    <div class="mt-3 flex items-center gap-2 text-sm text-gray-500">
                        <span class="bg-gray-100 px-2 py-1 rounded">${cat.num_productos || 0} productos</span>
                        <span class="bg-gray-100 px-2 py-1 rounded">Orden: ${cat.orden}</span>
                        ${cat.activo ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded">Activo</span>' : '<span class="bg-red-100 text-red-800 px-2 py-1 rounded">Inactivo</span>'}
                    </div>

                    <div class="mt-4 flex gap-2">
                        <button onclick="editarCategoria(${cat.id})" class="flex-1 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg hover:bg-indigo-100 text-sm font-medium">
                            Editar
                        </button>
                        <button onclick="gestionarProductos(${cat.id})" class="flex-1 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-100 text-sm font-medium">
                            Productos
                        </button>
                        <button onclick="eliminarCategoria(${cat.id})" class="bg-red-50 text-red-700 px-3 py-2 rounded-lg hover:bg-red-100 text-sm font-medium">
                            ✕
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function abrirModalNuevaCategoria() {
            document.getElementById('modal-titulo').textContent = 'Nueva Categoría';
            document.getElementById('form-categoria').reset();
            document.getElementById('categoria-id').value = '';
            document.getElementById('categoria-activo').checked = true;
            document.getElementById('modal-categoria').classList.remove('hidden');
            document.getElementById('modal-categoria').classList.add('flex');
        }

        function editarCategoria(id) {
            const cat = categorias.find(c => c.id === id);
            if (!cat) return;

            document.getElementById('modal-titulo').textContent = 'Editar Categoría';
            document.getElementById('categoria-id').value = cat.id;
            document.getElementById('categoria-nombre').value = cat.nombre;
            document.getElementById('categoria-descripcion').value = cat.descripcion || '';
            document.getElementById('categoria-imagen').value = cat.imagen || '';
            document.getElementById('categoria-orden').value = cat.orden;
            document.getElementById('categoria-activo').checked = cat.activo;
            document.getElementById('categoria-destacada').checked = cat.es_destacada;

            document.getElementById('modal-categoria').classList.remove('hidden');
            document.getElementById('modal-categoria').classList.add('flex');
        }

        function cerrarModal() {
            document.getElementById('modal-categoria').classList.add('hidden');
            document.getElementById('modal-categoria').classList.remove('flex');
        }

        document.getElementById('form-categoria').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('categoria-id').value;
            const data = {
                nombre: document.getElementById('categoria-nombre').value,
                descripcion: document.getElementById('categoria-descripcion').value,
                imagen: document.getElementById('categoria-imagen').value,
                orden: parseInt(document.getElementById('categoria-orden').value),
                activo: document.getElementById('categoria-activo').checked,
                es_destacada: document.getElementById('categoria-destacada').checked
            };

            try {
                const url = id ? `/api/admin/categorias/${id}` : '/api/admin/categorias';
                const method = id ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.ok) {
                    alert(result.message);
                    cerrarModal();
                    cargarCategorias();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error guardando categoría:', error);
                alert('Error al guardar categoría');
            }
        });

        async function eliminarCategoria(id) {
            if (!confirm('¿Estás seguro de eliminar esta categoría?')) return;

            try {
                const res = await fetch(`/api/admin/categorias/${id}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.ok) {
                    alert(data.message);
                    cargarCategorias();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error eliminando categoría:', error);
                alert('Error al eliminar categoría');
            }
        }

        async function gestionarProductos(categoriaId) {
            categoriaActualProductos = categoriaId;
            const cat = categorias.find(c => c.id === categoriaId);

            document.getElementById('modal-productos-titulo').textContent = `Productos de "${cat.nombre}"`;
            document.getElementById('modal-productos').classList.remove('hidden');
            document.getElementById('modal-productos').classList.add('flex');

            cargarProductosCategoria(categoriaId);
        }

        function cerrarModalProductos() {
            document.getElementById('modal-productos').classList.add('hidden');
            document.getElementById('modal-productos').classList.remove('flex');
            categoriaActualProductos = null;
            medicamentoSeleccionado = null;
        }

        async function cargarProductosCategoria(categoriaId) {
            try {
                const res = await fetch(`/api/admin/categorias/${categoriaId}/productos`);
                const data = await res.json();

                if (data.ok) {
                    const container = document.getElementById('productos-categoria-list');

                    if (data.productos.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay productos en esta categoría</p>';
                        return;
                    }

                    container.innerHTML = data.productos.map(p => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium">${p.nombre}</span>
                            <button onclick="eliminarProductoCategoria(${categoriaId}, ${p.id})" class="text-red-600 hover:text-red-800 text-sm">
                                Eliminar
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }

        let timeoutBusqueda;
        let indiceBusqueda = -1;
        let resultadosBusqueda = [];

        async function buscarMedicamentos(event) {
            // Si es flecha arriba/abajo o Enter, no buscar
            if (event && [38, 40, 13].includes(event.keyCode)) {
                return;
            }

            clearTimeout(timeoutBusqueda);
            const query = document.getElementById('buscar-medicamento').value.trim();
            indiceBusqueda = -1;

            if (query.length < 2) {
                document.getElementById('resultados-busqueda').innerHTML = '';
                resultadosBusqueda = [];
                return;
            }

            timeoutBusqueda = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/medicamentos/buscar?q=${encodeURIComponent(query)}`);
                    const data = await res.json();

                    if (data.ok && data.medicamentos) {
                        resultadosBusqueda = data.medicamentos;
                        renderizarResultadosBusqueda();
                    }
                } catch (error) {
                    console.error('Error buscando medicamentos:', error);
                }
            }, 300);
        }

        function renderizarResultadosBusqueda() {
            const container = document.getElementById('resultados-busqueda');

            if (resultadosBusqueda.length === 0) {
                container.innerHTML = '<p class="p-2 text-gray-500 text-sm">No se encontraron medicamentos</p>';
                return;
            }

            container.innerHTML = resultadosBusqueda.map((m, idx) => `
                <div onclick="seleccionarMedicamento(${m.id}, '${m.nombre.replace(/'/g, "\\'")}')"
                     data-index="${idx}"
                     class="resultado-item p-2 hover:bg-indigo-50 cursor-pointer border-b border-gray-200 ${idx === indiceBusqueda ? 'bg-indigo-100' : ''}">
                    ${m.nombre}
                </div>
            `).join('');
        }

        function navegarResultados(event) {
            const resultados = resultadosBusqueda;

            if (resultados.length === 0) return;

            // Flecha abajo (40)
            if (event.keyCode === 40) {
                event.preventDefault();
                indiceBusqueda = Math.min(indiceBusqueda + 1, resultados.length - 1);
                renderizarResultadosBusqueda();
                scrollToSelected();
            }
            // Flecha arriba (38)
            else if (event.keyCode === 38) {
                event.preventDefault();
                indiceBusqueda = Math.max(indiceBusqueda - 1, 0);
                renderizarResultadosBusqueda();
                scrollToSelected();
            }
            // Enter (13)
            else if (event.keyCode === 13) {
                event.preventDefault();
                if (indiceBusqueda >= 0 && indiceBusqueda < resultados.length) {
                    const medicamento = resultados[indiceBusqueda];
                    seleccionarMedicamento(medicamento.id, medicamento.nombre);
                }
            }
        }

        function scrollToSelected() {
            const container = document.getElementById('resultados-busqueda');
            const selected = container.querySelector(`[data-index="${indiceBusqueda}"]`);

            if (selected) {
                selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }

        function seleccionarMedicamento(id, nombre) {
            medicamentoSeleccionado = id;
            document.getElementById('buscar-medicamento').value = nombre;
            document.getElementById('resultados-busqueda').innerHTML = '';
            resultadosBusqueda = [];
            indiceBusqueda = -1;
        }

        async function agregarProductoSeleccionado() {
            if (!medicamentoSeleccionado) {
                alert('Selecciona un medicamento primero');
                return;
            }

            try {
                const res = await fetch(`/api/admin/categorias/${categoriaActualProductos}/productos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ medicamento_id: medicamentoSeleccionado })
                });

                const data = await res.json();

                if (data.ok) {
                    document.getElementById('buscar-medicamento').value = '';
                    medicamentoSeleccionado = null;
                    cargarProductosCategoria(categoriaActualProductos);
                    cargarCategorias(); // Actualizar contador
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error agregando producto:', error);
                alert('Error al agregar producto');
            }
        }

        async function eliminarProductoCategoria(categoriaId, medicamentoId) {
            if (!confirm('¿Eliminar este producto de la categoría?')) return;

            try {
                const res = await fetch(`/api/admin/categorias/${categoriaId}/productos/${medicamentoId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();

                if (data.ok) {
                    cargarProductosCategoria(categoriaId);
                    cargarCategorias(); // Actualizar contador
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error eliminando producto:', error);
                alert('Error al eliminar producto');
            }
        }
    </script>
</body>
</html>
