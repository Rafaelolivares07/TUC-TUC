<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de S√≠ntomas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div class="max-w-5xl mx-auto bg-white p-6 sm:p-12 rounded-2xl shadow-2xl border-t-8 border-yellow-500">
        <!-- Header -->
        <div class="flex justify-between items-start mb-8 flex-col sm:flex-row">
            <div class="mb-4 sm:mb-0">
                <h1 class="text-4xl font-extrabold text-yellow-700 mb-2">ü§í Gesti√≥n de S√≠ntomas</h1>
                <p class="text-gray-600">Crea y administra el cat√°logo de s√≠ntomas del sistema</p>
            </div>
            <a href="{{ url_for('admin_menu') }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition">
                ‚Üê Volver al Men√∫
            </a>
        </div>
        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="p-4 mb-6 text-sm rounded-lg shadow-md 
                    {% if category == 'success' %}bg-green-100 text-green-800 border border-green-300
                    {% elif category == 'danger' %}bg-red-100 text-red-800 border border-red-300
                    {% elif category == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-300
                    {% else %}bg-blue-100 text-blue-800 border border-blue-300
                    {% endif %}" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <!-- FORMULARIO PARA CREAR/EDITAR S√çNTOMA -->
        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 id="tituloFormulario" class="text-2xl font-bold text-yellow-800">‚ûï Crear Nuevo S√≠ntoma</h2>
                <button id="btnCancelarEdicion" 
                        class="hidden px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white text-sm rounded-lg transition"
                        onclick="cancelarEdicion()">
                    ‚úñÔ∏è Cancelar
                </button>
            </div>
            <form id="formSintoma" class="space-y-4">
                <input type="hidden" id="sintomaId" value="">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Nombre del S√≠ntoma *
                    </label>
                    <input type="text" 
                           id="nombreSintoma" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" 
                           placeholder="Ej: Dolor de cabeza"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Sin√≥nimos / Descripci√≥n (opcional)
                    </label>
                    <textarea id="descripcionSintoma" 
                              rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" 
                              placeholder="Ej: cefalea, migra√±a, jaqueca"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Palabras alternativas para identificar este s√≠ntoma</p>
                </div>
                <button type="submit" 
                        id="btnSubmit"
                        class="w-full sm:w-auto px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg shadow-md transition">
                    Crear S√≠ntoma
                </button>
            </form>
            <!-- Mensaje de resultado -->
            <div id="mensajeResultado" class="mt-4 hidden"></div>
        </div>
        <!-- SECCI√ìN DE FUSI√ìN DE S√çNTOMAS -->
        <div id="seccionFusion" class="bg-orange-50 border-2 border-orange-300 rounded-xl p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-orange-800">üîÄ Fusionar S√≠ntomas Duplicados</h2>
            </div>
            <!-- PASO 1: Buscar y seleccionar s√≠ntomas -->
            <div id="paso1Fusion">
                <p class="text-sm text-gray-600 mb-4">
                    Busca s√≠ntomas similares y selecciona los que deseas fusionar en uno solo
                </p>
                <div class="mb-4">
                    <input type="text" 
                           id="buscarSintomasFusion" 
                           placeholder="üîç Buscar s√≠ntomas similares (ej: dolor, fiebre, tos)..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                           oninput="filtrarSintomasParaFusion()">
                </div>
                <!-- Resultados filtrados -->
                <div id="resultadosFusion" class="hidden">
                    <div class="bg-white rounded-lg border border-orange-200 p-4 mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm font-semibold text-gray-700">
                                Resultados: <span id="contadorResultados">0</span>
                            </span>
                            <span class="text-sm text-orange-600">
                                Seleccionados: <span id="contadorSeleccionados">0</span>
                            </span>
                        </div>
                        <div id="listaSintomasFusion" class="space-y-2 max-h-80 overflow-y-auto">
                            <!-- Se llenar√°n din√°micamente -->
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button id="btnContinuarFusion" 
                                onclick="continuarASeleccionPrincipal()"
                                disabled
                                class="px-6 py-3 bg-orange-600 text-white font-semibold rounded-lg shadow-md transition disabled:bg-gray-400 disabled:cursor-not-allowed hover:enabled:bg-orange-700">
                            Continuar con <span id="btnContadorSeleccionados">0</span> seleccionados
                        </button>
                        <button onclick="cancelarFusion()" 
                                class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-semibold rounded-lg shadow-md transition">
                            Cancelar
                        </button>
                    </div>
                </div>
                <div id="sinResultadosFusion" class="hidden text-gray-500 text-sm italic bg-orange-50 p-4 rounded-lg border border-orange-200">
                    Escribe en el buscador para encontrar s√≠ntomas similares
                </div>
            </div>
            <!-- PASO 2: Seleccionar s√≠ntoma principal -->
            <div id="paso2Fusion" class="hidden">
                <div class="bg-white rounded-lg border-2 border-orange-300 p-6 mb-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Selecciona el s√≠ntoma que quedar√°:</h3>
                    <p class="text-sm text-gray-600 mb-4">Los dem√°s s√≠ntomas se eliminar√°n y sus medicamentos se migrar√°n al principal</p>
                    <div id="listaSeleccionPrincipal" class="space-y-3 mb-6">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                    <!-- Resumen -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-2">üìä Resumen de la fusi√≥n:</h4>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚úÖ S√≠ntoma principal: <span id="resumenPrincipal" class="font-semibold">-</span></li>
                            <li>üì¶ Total medicamentos √∫nicos: <span id="resumenTotalMedicamentos" class="font-semibold">-</span></li>
                            <li>üóëÔ∏è S√≠ntomas a eliminar: <span id="resumenAEliminar" class="font-semibold">-</span></li>
                        </ul>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="ejecutarFusion()" 
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition">
                        ‚úÖ Ejecutar Fusi√≥n
                    </button>
                    <button onclick="volverAPaso1()" 
                            class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-semibold rounded-lg shadow-md transition">
                        ‚Üê Volver
                    </button>
                </div>
            </div>
        </div>
        <!-- SECCI√ìN DE MEDICAMENTOS (solo visible en modo edici√≥n) -->
        <div id="seccionMedicamentos" class="hidden bg-blue-50 border-2 border-blue-300 rounded-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-blue-800 mb-4">üíä Medicamentos de este S√≠ntoma</h2>
            <!-- Medicamentos asociados -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Medicamentos asociados:</h3>
                <div id="medicamentosAsociados" class="space-y-2">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
                <div id="sinMedicamentosAsociados" class="hidden text-gray-500 text-sm">
                    No hay medicamentos asociados a este s√≠ntoma
                </div>
            </div>
            <!-- SUGERENCIAS AUTOM√ÅTICAS -->
            <div id="seccionSugerencias" class="mb-6 border-t border-blue-200 pt-6">
                <!-- BLOQUE 1: Mismo componente activo -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-purple-700 mb-2">üí° Sugerencias: Medicamentos con el mismo componente activo</h3>
                    <p class="text-sm text-gray-600 mb-3">Medicamentos que comparten el mismo componente activo:</p>
                    <div id="listaSugerencias" class="space-y-2">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                    <div id="sinSugerencias" class="hidden text-gray-500 text-sm italic bg-purple-50 p-3 rounded-lg border border-purple-200">
                        No hay sugerencias de este tipo. Aparecen cuando los medicamentos asociados tienen un componente activo definido.
                    </div>
                </div>
                <!-- BLOQUE 2: Medicamentos que usan estos como componente -->
                <div>
                    <h3 class="text-lg font-semibold text-green-700 mb-2">üîó Sugerencias: Medicamentos que usan estos como componente activo</h3>
                    <p class="text-sm text-gray-600 mb-3">Medicamentos que utilizan alg√∫n medicamento asociado como su componente:</p>
                    <div id="listaSugerenciasComponente" class="space-y-2">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                    <div id="sinSugerenciasComponente" class="hidden text-gray-500 text-sm italic bg-green-50 p-3 rounded-lg border border-green-200">
                        No hay sugerencias de este tipo. Aparecen cuando alg√∫n medicamento asociado es usado como componente activo por otros.
                    </div>
                </div>
            </div>
            <!-- Agregar nuevo medicamento -->
            <div class="border-t border-blue-200 pt-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">‚ûï Asociar nuevo medicamento:</h3>
                <div class="flex gap-2">
                    <input type="text" 
                           id="buscarMedicamento" 
                           placeholder="Buscar medicamento..."
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button onclick="buscarMedicamentos()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                        üîç Buscar
                    </button>
                </div>
                <!-- Resultados de b√∫squeda -->
                <div id="resultadosBusqueda" class="mt-4 hidden">
                    <div class="max-h-60 overflow-y-auto space-y-2" id="listaMedicamentosDisponibles">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
        <!-- LISTA DE S√çNTOMAS -->
        <div class="bg-gray-50 border-2 border-gray-300 rounded-xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Lista de S√≠ntomas</h2>
            <!-- Loading -->
            <div id="loadingSintomas" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-600"></div>
                <p class="text-gray-600 mt-2">Cargando s√≠ntomas...</p>
            </div>
            <!-- Lista -->
            <div id="listaSintomas" class="hidden">
                <div class="mb-4 text-sm text-gray-600">
                    Total: <span id="totalSintomas" class="font-bold">0</span> s√≠ntomas
                </div>
                <div id="contenedorSintomas" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Los s√≠ntomas se cargar√°n aqu√≠ din√°micamente -->
                </div>
            </div>
            <!-- Sin datos -->
            <div id="sinSintomas" class="hidden text-center py-8 text-gray-500">
                No hay s√≠ntomas registrados a√∫n
            </div>
        </div>
    </div>
    <!-- JAVASCRIPT -->
    <script>
        let modoEdicion = false;
        let sintomaActual = null;
        let todosMedicamentos = []; // Cache de todos los medicamentos
        let todosSintomas = []; // Cache de todos los s√≠ntomas
        // Variables para fusi√≥n
        let sintomasSeleccionadosFusion = [];
        let sintomaPrincipalSeleccionado = null;
        // ==========================================
        // CARGAR S√çNTOMAS AL INICIAR
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            cargarSintomas();
            cargarTodosMedicamentos(); // Cargar medicamentos al inicio
        });


        function normalizarTexto(texto) {
            return texto
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();
        }


        // ==========================================
        // FUNCI√ìN: CARGAR TODOS LOS MEDICAMENTOS (CACHE)
        // ==========================================
        function cargarTodosMedicamentos() {
            fetch('/admin/medicamentos/lista_json')
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        todosMedicamentos = data.medicamentos;
                        console.log(`‚úÖ ${todosMedicamentos.length} medicamentos cargados en cache`);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar medicamentos:', error);
                });
        }
        // ==========================================
        // FUNCI√ìN: CARGAR LISTA DE S√çNTOMAS
        // ==========================================
        function cargarSintomas() {
            console.log('üîÑ INICIANDO cargarSintomas()');
            fetch('/admin/sintomas/completo/json')
                .then(response => {
                    console.log('üì• Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìã Data recibida:', data);
                    console.log('üìä Total de s√≠ntomas:', data.sintomas ? data.sintomas.length : 0);
                    // Guardar en cache
                    todosSintomas = data.sintomas || [];
                    document.getElementById('loadingSintomas').classList.add('hidden');
                    if (data.ok && data.sintomas.length > 0) {
                        document.getElementById('listaSintomas').classList.remove('hidden');
                        document.getElementById('sinSintomas').classList.add('hidden');
                        document.getElementById('totalSintomas').textContent = data.sintomas.length;
                        const contenedor = document.getElementById('contenedorSintomas');
                        contenedor.innerHTML = '';
                        // ORDENAR ALFAB√âTICAMENTE (sin importar may√∫sculas)
                        data.sintomas.sort((a, b) => {
                            return a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase());
                        });
                        data.sintomas.forEach(sintoma => {
                            const div = document.createElement('div');
                            div.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition';
                            // Lista de medicamentos
                            let medicamentosHTML = '';
                            if (sintoma.medicamentos && sintoma.medicamentos.length > 0) {
                                medicamentosHTML = `
                                    <div class="mt-3 pt-3 border-t border-gray-200">
                                        <p class="text-xs font-semibold text-gray-600 mb-2">üíä Medicamentos asociados (${sintoma.medicamentos.length}):</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${sintoma.medicamentos.map(med => `
                                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full" title="${med.presentacion || 'Sin presentaci√≥n'}">
                                                    ${med.nombre}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                            // Lista de diagn√≥sticos
                            let diagnosticosHTML = '';
                            if (sintoma.diagnosticos && sintoma.diagnosticos.length > 0) {
                                diagnosticosHTML = `
                                    <div class="mt-3 pt-3 border-t border-gray-200">
                                        <p class="text-xs font-semibold text-gray-600 mb-2">ü©∫ Diagn√≥sticos asociados (${sintoma.diagnosticos.length}):</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${sintoma.diagnosticos.map(diag => `
                                                <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                                                    ${diag.nombre}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                            div.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-gray-800">${sintoma.nombre}</h3>
                                        ${sintoma.sinonimos ? `<p class="text-sm text-gray-500 mt-1">Sin√≥nimos: ${sintoma.sinonimos}</p>` : ''}
                                        ${medicamentosHTML}
                                        ${diagnosticosHTML}
                                    </div>
                                    <div class="flex flex-col items-end space-y-2 ml-4">
                                        <span class="text-xs text-gray-400">ID: ${sintoma.id}</span>
                                        <button onclick='editarSintoma(${JSON.stringify(sintoma)})' 
                                                class="w-28 px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm rounded-lg transition">
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button onclick="eliminarSintoma(${sintoma.id}, '${sintoma.nombre.replace(/'/g, "\\'")}', ${sintoma.medicamentos.length})" 
                                                class="w-28 px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition">
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                </div>
                            `;
                            contenedor.appendChild(div);
                        });
                    } else {
                        document.getElementById('listaSintomas').classList.add('hidden');
                        document.getElementById('sinSintomas').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingSintomas').classList.add('hidden');
                    mostrarMensaje('Error al cargar los s√≠ntomas', 'error');
                });
        }
        // ==========================================
        // FUSI√ìN DE S√çNTOMAS - PASO 1: FILTRAR Y SELECCIONAR
        // ==========================================
        function filtrarSintomasParaFusion() {
            const termino = document.getElementById('buscarSintomasFusion').value.trim();
            const resultadosDiv = document.getElementById('resultadosFusion');
            const terminoNormalizado = normalizarTexto(termino);

            if (terminoNormalizado.length < 2) {
                resultadosDiv.classList.add('hidden');
                document.getElementById('contadorResultados').textContent = "0";
                const listaDiv = document.getElementById('listaSintomasFusion');
                listaDiv.innerHTML = '';
                return;
            }

            const sintomasFiltrados = todosSintomas.filter(s => {
                const nombreNorm = normalizarTexto(s.nombre);
                const sinonimosNorm = s.sinonimos ? normalizarTexto(s.sinonimos) : "";
                return (
                    nombreNorm.includes(terminoNormalizado) ||
                    sinonimosNorm.includes(terminoNormalizado)
                );
            });

            if (sintomasFiltrados.length === 0) {
                resultadosDiv.classList.add('hidden');
                document.getElementById('contadorResultados').textContent = "0";
                const listaDiv = document.getElementById('listaSintomasFusion');
                listaDiv.innerHTML = '';
                return;
            }

            resultadosDiv.classList.remove('hidden');
            document.getElementById('contadorResultados').textContent = sintomasFiltrados.length;

            const listaDiv = document.getElementById('listaSintomasFusion');
            listaDiv.innerHTML = '';

            sintomasFiltrados.forEach(sintoma => {
                const estaSeleccionado = sintomasSeleccionadosFusion.some(s => s.id === sintoma.id);
                const div = document.createElement('div');
                div.className = `flex items-center gap-3 p-3 rounded-lg border transition ${
                    estaSeleccionado ? 'bg-orange-50 border-orange-300' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                }`;
                
                const totalMeds = sintoma.medicamentos ? sintoma.medicamentos.length : 0;
                const nombreEscapado = sintoma.nombre.replace(/'/g, "\\'");
                
                div.innerHTML = `
                    <input type="checkbox"
                           id="checkbox-${sintoma.id}"
                           ${estaSeleccionado ? 'checked' : ''}
                           onchange="toggleSeleccionFusion(${sintoma.id}, '${nombreEscapado}', ${totalMeds})"
                           class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500">
                    <label for="checkbox-${sintoma.id}" class="flex-1 cursor-pointer">
                        <span class="font-semibold text-gray-800">${sintoma.nombre}</span>
                        <span class="text-sm text-gray-500 ml-2">(${totalMeds} medicamentos)</span>
                        ${sintoma.sinonimos ? `<div class="text-xs text-gray-400 mt-1">Sin√≥nimos: ${sintoma.sinonimos}</div>` : ''}
                    </label>
                `;
                listaDiv.appendChild(div);
            });
            actualizarContadorSeleccionados();
        }



        function toggleSeleccionFusion(id, nombre, totalMedicamentos) {
            const index = sintomasSeleccionadosFusion.findIndex(s => s.id === id);
            if (index >= 0) {
                // Deseleccionar
                sintomasSeleccionadosFusion.splice(index, 1);
            } else {
                // Seleccionar
                const sintoma = todosSintomas.find(s => s.id === id);
                sintomasSeleccionadosFusion.push(sintoma);
            }
            actualizarContadorSeleccionados();
            filtrarSintomasParaFusion(); // Volver a renderizar para actualizar estilos
        }
        function actualizarContadorSeleccionados() {
            const total = sintomasSeleccionadosFusion.length;
            document.getElementById('contadorSeleccionados').textContent = total;
            document.getElementById('btnContadorSeleccionados').textContent = total;
            const btnContinuar = document.getElementById('btnContinuarFusion');
            if (total >= 2) {
                btnContinuar.disabled = false;
            } else {
                btnContinuar.disabled = true;
            }
        }
        // ==========================================
        // FUSI√ìN DE S√çNTOMAS - PASO 2: SELECCIONAR PRINCIPAL
        // ==========================================
        function continuarASeleccionPrincipal() {
            if (sintomasSeleccionadosFusion.length < 2) {
                alert('Debes seleccionar al menos 2 s√≠ntomas para fusionar');
                return;
            }
            // Ocultar paso 1, mostrar paso 2
            document.getElementById('paso1Fusion').classList.add('hidden');
            document.getElementById('paso2Fusion').classList.remove('hidden');
            // Renderizar opciones
            const listaDiv = document.getElementById('listaSeleccionPrincipal');
            listaDiv.innerHTML = '';
            sintomasSeleccionadosFusion.forEach((sintoma, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-3 p-4 rounded-lg border border-gray-300 hover:bg-gray-50 transition';
                div.innerHTML = `
                    <input type="radio" 
                           name="sintomaPrincipal" 
                           id="radio-${sintoma.id}"
                           value="${sintoma.id}"
                           ${index === 0 ? 'checked' : ''}
                           onchange="seleccionarSintomaPrincipal(${sintoma.id})"
                           class="w-5 h-5 text-orange-600 mt-1 focus:ring-orange-500">
                    <label for="radio-${sintoma.id}" class="flex-1 cursor-pointer">
                        <span class="font-semibold text-gray-800 text-lg">${sintoma.nombre}</span>
                        <span class="text-sm text-gray-500 ml-2">(${sintoma.medicamentos.length} medicamentos)</span>
                        ${sintoma.sinonimos ? `<p class="text-xs text-gray-500 mt-1">Sin√≥nimos: ${sintoma.sinonimos}</p>` : ''}
                    </label>
                `;
                listaDiv.appendChild(div);
            });
            // Seleccionar el primero por defecto
            seleccionarSintomaPrincipal(sintomasSeleccionadosFusion[0].id);
        }
        function seleccionarSintomaPrincipal(id) {
            sintomaPrincipalSeleccionado = sintomasSeleccionadosFusion.find(s => s.id === id);
            actualizarResumenFusion();
        }
        function actualizarResumenFusion() {
            if (!sintomaPrincipalSeleccionado) return;
            document.getElementById('resumenPrincipal').textContent = sintomaPrincipalSeleccionado.nombre;
            // Calcular medicamentos √∫nicos
            const todosMedicamentosIds = new Set();
            sintomasSeleccionadosFusion.forEach(sintoma => {
                sintoma.medicamentos.forEach(med => {
                    todosMedicamentosIds.add(med.id);
                });
            });
            document.getElementById('resumenTotalMedicamentos').textContent = todosMedicamentosIds.size;
            document.getElementById('resumenAEliminar').textContent = sintomasSeleccionadosFusion.length - 1;
        }
        function volverAPaso1() {
            document.getElementById('paso2Fusion').classList.add('hidden');
            document.getElementById('paso1Fusion').classList.remove('hidden');
            sintomaPrincipalSeleccionado = null;
        }
        // ==========================================
        // FUSI√ìN DE S√çNTOMAS - EJECUTAR
        // ==========================================
        function ejecutarFusion() {
            if (!sintomaPrincipalSeleccionado) {
                alert('Debes seleccionar un s√≠ntoma principal');
                return;
            }
            const sintomasSecundariosIds = sintomasSeleccionadosFusion
                .filter(s => s.id !== sintomaPrincipalSeleccionado.id)
                .map(s => s.id);
            const mensaje = `¬øEst√°s seguro de fusionar estos s√≠ntomas?
` +
                `‚úÖ Se mantendr√°: ${sintomaPrincipalSeleccionado.nombre}
` +
                `üóëÔ∏è Se eliminar√°n: ${sintomasSecundariosIds.length} s√≠ntomas
` +
                `üì¶ Total de medicamentos √∫nicos: ${document.getElementById('resumenTotalMedicamentos').textContent}`;
            if (!confirm(mensaje)) return;
            fetch('/admin/sintomas/fusionar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sintoma_principal_id: sintomaPrincipalSeleccionado.id,
                    sintomas_secundarios_ids: sintomasSecundariosIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    mostrarMensaje(data.mensaje, 'success');
                    cancelarFusion();
                    cargarSintomas();
                } else {
                    mostrarMensaje(data.error || 'Error al fusionar s√≠ntomas', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error de conexi√≥n al fusionar s√≠ntomas', 'error');
            });
        }
        function cancelarFusion() {
            // Resetear estado
            sintomasSeleccionadosFusion = [];
            sintomaPrincipalSeleccionado = null;
            // Resetear UI
            document.getElementById('buscarSintomasFusion').value = '';
            document.getElementById('resultadosFusion').classList.add('hidden');
            document.getElementById('sinResultadosFusion').classList.remove('hidden');
            document.getElementById('sinResultadosFusion').textContent = 'Escribe en el buscador para encontrar s√≠ntomas similares';
            document.getElementById('paso1Fusion').classList.remove('hidden');
            document.getElementById('paso2Fusion').classList.add('hidden');
            actualizarContadorSeleccionados();
        }
        // ==========================================
        // FUNCI√ìN: EDITAR S√çNTOMA
        // ==========================================
        function editarSintoma(sintoma) {
            modoEdicion = true;
            sintomaActual = sintoma;
            // Cambiar t√≠tulo y bot√≥n
            document.getElementById('tituloFormulario').innerHTML = '‚úèÔ∏è Editar S√≠ntoma';
            document.getElementById('btnSubmit').textContent = 'Actualizar S√≠ntoma';
            document.getElementById('btnCancelarEdicion').classList.remove('hidden');
            // Llenar formulario
            document.getElementById('sintomaId').value = sintoma.id;
            document.getElementById('nombreSintoma').value = sintoma.nombre;
            document.getElementById('descripcionSintoma').value = sintoma.sinonimos || '';
            // Mostrar secci√≥n de medicamentos
            document.getElementById('seccionMedicamentos').classList.remove('hidden');
            cargarMedicamentosAsociados(sintoma.medicamentos);
            cargarSugerenciasAutomaticas();
            // Scroll al formulario
            document.getElementById('formSintoma').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        // ==========================================
        // FUNCI√ìN: CARGAR MEDICAMENTOS ASOCIADOS
        // ==========================================
        function cargarMedicamentosAsociados(medicamentos) {
            const contenedor = document.getElementById('medicamentosAsociados');
            const sinMedicamentos = document.getElementById('sinMedicamentosAsociados');
            contenedor.innerHTML = '';
            if (medicamentos && medicamentos.length > 0) {
                contenedor.classList.remove('hidden');
                sinMedicamentos.classList.add('hidden');
                medicamentos.forEach(med => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-white p-3 rounded-lg border border-blue-200';
                    div.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${med.nombre}</span>
                            ${med.presentacion ? `<span class="text-sm text-gray-500 ml-2">(${med.presentacion})</span>` : ''}
                        </div>
                        <button onclick="desasociarMedicamento(${med.id})" 
                                class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition">
                            ‚ùå Desasociar
                        </button>
                    `;
                    contenedor.appendChild(div);
                });
            } else {
                contenedor.classList.add('hidden');
                sinMedicamentos.classList.remove('hidden');
            }
        }
        // ==========================================
        // FUNCI√ìN: CARGAR SUGERENCIAS AUTOM√ÅTICAS
        // ==========================================
        function cargarSugerenciasAutomaticas() {
            const contenedor1 = document.getElementById('listaSugerencias');
            const sinSugerencias1 = document.getElementById('sinSugerencias');
            const contenedor2 = document.getElementById('listaSugerenciasComponente');
            const sinSugerencias2 = document.getElementById('sinSugerenciasComponente');
            // Limpiar todos los contenedores
            contenedor1.innerHTML = '';
            contenedor1.classList.add('hidden');
            sinSugerencias1.classList.add('hidden');
            contenedor2.innerHTML = '';
            contenedor2.classList.add('hidden');
            sinSugerencias2.classList.add('hidden');
            if (!sintomaActual || !sintomaActual.medicamentos || sintomaActual.medicamentos.length === 0) {
                sinSugerencias1.classList.remove('hidden');
                sinSugerencias2.classList.remove('hidden');
                return;
            }
            // Obtener IDs de medicamentos ya asociados
            const idsAsociados = sintomaActual.medicamentos.map(m => m.id);
            // ==========================================
            // BLOQUE 1: Medicamentos con el mismo componente activo
            // ==========================================
            const componentesActivos = new Set();
            sintomaActual.medicamentos.forEach(med => {
                const medCompleto = todosMedicamentos.find(m => m.id === med.id);
                if (medCompleto && medCompleto.componente_activo_id) {
                    componentesActivos.add(medCompleto.componente_activo_id);
                }
            });
            let sugerencias1 = [];
            if (componentesActivos.size > 0) {
                sugerencias1 = todosMedicamentos.filter(med => {
                    if (idsAsociados.includes(med.id)) return false;
                    if (!med.componente_activo_id) return false;
                    return componentesActivos.has(med.componente_activo_id);
                });
            }
            if (sugerencias1.length > 0) {
                contenedor1.classList.remove('hidden');
                sugerencias1.forEach(med => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-purple-50 p-3 rounded-lg border border-purple-200';
                    div.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${med.nombre}</span>
                            ${med.presentacion ? `<span class="text-sm text-gray-500 ml-2">(${med.presentacion})</span>` : ''}
                            <span class="text-xs text-purple-600 ml-2">‚≠ê Mismo componente activo</span>
                        </div>
                        <button onclick="asociarMedicamento(${med.id}, '${med.nombre.replace(/'/g, "\\'")}')" 
                                class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-sm rounded-lg transition">
                            ‚ö° Asociar
                        </button>
                    `;
                    contenedor1.appendChild(div);
                });
            } else {
                sinSugerencias1.classList.remove('hidden');
            }
            // ==========================================
            // BLOQUE 2: Medicamentos que usan estos como componente activo
            // ==========================================
            const sugerencias2 = todosMedicamentos.filter(med => {
                if (idsAsociados.includes(med.id)) return false;
                if (!med.componente_activo_id) return false;
                return idsAsociados.includes(med.componente_activo_id);
            });
            if (sugerencias2.length > 0) {
                contenedor2.classList.remove('hidden');
                sugerencias2.forEach(med => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-green-50 p-3 rounded-lg border border-green-200';
                    div.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${med.nombre}</span>
                            ${med.presentacion ? `<span class="text-sm text-gray-500 ml-2">(${med.presentacion})</span>` : ''}
                            <span class="text-xs text-green-600 ml-2">üîó Usa un medicamento asociado como componente</span>
                        </div>
                        <button onclick="asociarMedicamento(${med.id}, '${med.nombre.replace(/'/g, "\\'")}')" 
                                class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition">
                            ‚ö° Asociar
                        </button>
                    `;
                    contenedor2.appendChild(div);
                });
            } else {
                sinSugerencias2.classList.remove('hidden');
            }
        }
        // ==========================================
        // FUNCI√ìN: BUSCAR MEDICAMENTOS
        // ==========================================
        function buscarMedicamentos() {
            const termino = document.getElementById('buscarMedicamento').value.trim();
            if (termino.length < 2) {
                alert('Por favor ingresa al menos 2 caracteres para buscar');
                return;
            }
            fetch(`/admin/medicamentos/lista_json?buscar=${encodeURIComponent(termino)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        mostrarResultadosBusqueda(data.medicamentos);
                    } else {
                        alert('Error al buscar medicamentos');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexi√≥n al buscar medicamentos');
                });
        }
        // ==========================================
        // FUNCI√ìN: MOSTRAR RESULTADOS DE B√öSQUEDA
        // ==========================================
        function mostrarResultadosBusqueda(medicamentos) {
            const contenedor = document.getElementById('listaMedicamentosDisponibles');
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            contenedor.innerHTML = '';
            if (medicamentos.length === 0) {
                resultadosDiv.classList.remove('hidden');
                contenedor.innerHTML = '<p class="text-gray-500 text-sm">No se encontraron medicamentos</p>';
                return;
            }
            // Identificar IDs que son componentes activos
            const idsComponentesActivos = new Set();
            medicamentos.forEach(med => {
                if (med.componente_activo_id) {
                    idsComponentesActivos.add(med.componente_activo_id);
                }
            });
            // Filtrar medicamentos ya asociados
            const idsAsociados = sintomaActual.medicamentos.map(m => m.id);
            // Filtrar medicamentos que son componentes activos Y que no est√°n asociados
            const medicamentosDisponibles = medicamentos.filter(m => {
                if (idsAsociados.includes(m.id)) return false;
                if (idsComponentesActivos.has(m.id)) return false;
                return true;
            });
            resultadosDiv.classList.remove('hidden');
            if (medicamentosDisponibles.length === 0) {
                contenedor.innerHTML = '<p class="text-gray-500 text-sm">No hay medicamentos disponibles para asociar</p>';
                return;
            }
            medicamentosDisponibles.forEach(med => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200 hover:bg-gray-50';
                div.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-800">${med.nombre}</span>
                        ${med.presentacion ? `<span class="text-sm text-gray-500 ml-2">(${med.presentacion})</span>` : ''}
                    </div>
                    <button onclick="asociarMedicamento(${med.id}, '${med.nombre.replace(/'/g, "\\'")}')" 
                            class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition">
                            ‚ûï Asociar
                    </button>
                `;
                contenedor.appendChild(div);
            });
        }
        // ==========================================
        // FUNCI√ìN: ASOCIAR MEDICAMENTO
        // ==========================================
        function asociarMedicamento(medicamentoId, nombreMedicamento) {
            if (!sintomaActual) return;
            fetch(`/admin/sintomas/${sintomaActual.id}/asociar-medicamento`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    medicamento_id: medicamentoId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    mostrarMensaje(data.mensaje, 'success');
                    recargarSintomaActual();
                } else {
                    mostrarMensaje(data.error || 'Error al asociar medicamento', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error de conexi√≥n al asociar medicamento', 'error');
            });
        }
        // ==========================================
        // FUNCI√ìN: DESASOCIAR MEDICAMENTO
        // ==========================================
        function desasociarMedicamento(medicamentoId) {
            if (!sintomaActual) return;
            if (!confirm('¬øEst√°s seguro de desasociar este medicamento del s√≠ntoma?')) {
                return;
            }
            fetch(`/admin/sintomas/${sintomaActual.id}/desasociar-medicamento`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    medicamento_id: medicamentoId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    mostrarMensaje(data.mensaje, 'success');
                    recargarSintomaActual();
                } else {
                    mostrarMensaje(data.error || 'Error al desasociar medicamento', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error de conexi√≥n al desasociar medicamento', 'error');
            });
        }
        // ==========================================
        // FUNCI√ìN: RECARGAR S√çNTOMA ACTUAL
        // ==========================================
        function recargarSintomaActual() {
            fetch('/admin/sintomas/completo/json')
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        const sintomaActualizado = data.sintomas.find(s => s.id === sintomaActual.id);
                        if (sintomaActualizado) {
                            sintomaActual = sintomaActualizado;
                            cargarMedicamentosAsociados(sintomaActual.medicamentos);
                            cargarSugerenciasAutomaticas();
                        }
                        cargarSintomas();
                    }
                });
        }
        // ==========================================
        // FUNCI√ìN: CANCELAR EDICI√ìN
        // ==========================================
        function cancelarEdicion() {
            modoEdicion = false;
            sintomaActual = null;
            document.getElementById('tituloFormulario').innerHTML = '‚ûï Crear Nuevo S√≠ntoma';
            document.getElementById('btnSubmit').textContent = 'Crear S√≠ntoma';
            document.getElementById('btnCancelarEdicion').classList.add('hidden');
            document.getElementById('seccionMedicamentos').classList.add('hidden');
            document.getElementById('resultadosBusqueda').classList.add('hidden');
            document.getElementById('buscarMedicamento').value = '';
            document.getElementById('sintomaId').value = '';
            document.getElementById('nombreSintoma').value = '';
            document.getElementById('descripcionSintoma').value = '';
        }
        // ==========================================
        // FUNCI√ìN: ELIMINAR S√çNTOMA
        // ==========================================
        function eliminarSintoma(id, nombre, totalMedicamentos) {
            let mensaje = `¬øEst√°s seguro de eliminar el s√≠ntoma "${nombre}"?`;
            if (totalMedicamentos > 0) {
                mensaje += `
‚ö†Ô∏è ATENCI√ìN: Este s√≠ntoma tiene ${totalMedicamentos} medicamento(s) asociado(s).`;
                mensaje += `
Se eliminar√°n tambi√©n esas relaciones.`;
            }
            if (!confirm(mensaje)) {
                return;
            }
            fetch(`/admin/sintomas/${id}/eliminar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    mostrarMensaje(data.mensaje, 'success');
                    cargarSintomas();
                } else {
                    mostrarMensaje(data.error || 'Error al eliminar s√≠ntoma', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error de conexi√≥n al eliminar s√≠ntoma', 'error');
            });
        }
        // ==========================================
        // FUNCI√ìN: SUBMIT FORMULARIO (CREAR O EDITAR)
        // ==========================================
        document.getElementById('formSintoma').addEventListener('submit', function(e) {
            e.preventDefault();
            const nombre = document.getElementById('nombreSintoma').value.trim();
            const descripcion = document.getElementById('descripcionSintoma').value.trim();
            const sintomaId = document.getElementById('sintomaId').value;
            if (!nombre) {
                mostrarMensaje('Por favor ingresa el nombre del s√≠ntoma', 'error');
                return;
            }
            const btnSubmit = document.getElementById('btnSubmit');
            const textoOriginal = btnSubmit.textContent;
            btnSubmit.disabled = true;
            btnSubmit.textContent = modoEdicion ? 'Actualizando...' : 'Creando...';
            const url = modoEdicion 
                ? `/admin/sintomas/${sintomaId}/actualizar`
                : '/admin/sintomas/crear';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nombre: nombre,
                    descripcion: descripcion
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    mostrarMensaje(data.mensaje, 'success');
                    if (modoEdicion) {
                        sintomaActual.nombre = nombre;
                        sintomaActual.sinonimos = descripcion;
                    } else {
                        cancelarEdicion();
                    }
                    cargarSintomas();
                } else {
                    mostrarMensaje(data.error || 'Error al procesar s√≠ntoma', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error de conexi√≥n', 'error');
            })
            .finally(() => {
                btnSubmit.disabled = false;
                btnSubmit.textContent = textoOriginal;
            });
        });
        // ==========================================
        // FUNCI√ìN: MOSTRAR MENSAJES
        // ==========================================
        function mostrarMensaje(texto, tipo) {
            const mensajeDiv = document.getElementById('mensajeResultado');
            mensajeDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800');
            if (tipo === 'success') {
                mensajeDiv.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
            } else {
                mensajeDiv.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            }
            mensajeDiv.className += ' p-4 rounded-lg';
            mensajeDiv.textContent = texto;
            setTimeout(() => {
                mensajeDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>