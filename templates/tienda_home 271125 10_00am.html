<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda - Medicamentos a Domicilio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1rem;  /* üÜï Reducido de 1.5rem */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.3rem;  /* üÜï Reducido de 1.8rem */
            margin-bottom: 0.25rem;  /* üÜï Reducido de 0.5rem */
        }

        .header p {
            opacity: 0.9;
            font-size: 0.8rem;  /* üÜï Reducido de 0.9rem */
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.5rem;  /* üÜï Reducido de 0.75rem */
        }

        @media (min-width: 768px) {
            .container {
                padding: 1rem;  /* üÜï Reducido de 1.5rem */
            }
        }
        
        .filtros {
            background: white;
            padding: 1rem;  /* üÜï Reducido de 1.5rem */
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;  /* üÜï Reducido de 2rem */
        }

        .filtros h3 {
            margin-bottom: 0.5rem;  /* üÜï Reducido de 1rem */
            color: #667eea;
            font-size: 1rem;  /* üÜï Reducido de 1.1rem */
        }
        
        .filtro-grupo {
            margin-bottom: 1rem;
        }
        
        .filtro-grupo label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #555;
        }
        
        .filtro-grupo input, .filtro-grupo select, .filtro-grupo textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .filtro-grupo textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .filtro-grupo input:focus, .filtro-grupo select:focus, .filtro-grupo textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .btn-buscar {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-buscar:hover {
            background: #5568d3;
        }
        
        /* üÜï ESTILOS PARA DIAGN√ìSTICOS DETECTADOS */
        .diagnosticos-detectados {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 0.75rem;  /* üÜï Reducido de 1rem */
            margin-bottom: 1rem;  /* üÜï Reducido de 1.5rem */
        }

        .diagnosticos-detectados h4 {
            color: #667eea;
            margin-bottom: 0.4rem;  /* üÜï Reducido de 0.5rem */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;  /* üÜï M√°s peque√±o */
        }
        
        .sintomas-detectados {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .sintoma-tag {
            background: #667eea;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .diagnostico-tag {
            background: #e74c3c;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .productos-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            max-width: 100% !important;
            width: 100%;
            padding: 0;
            margin: -3 -3rem;
        }
        
        /* üÜï RESPONSIVE LAYOUT */
        @media (min-width: 768px) {
            .productos-grid {
                grid-template-columns: repeat(2, 1fr);
                max-width: 100%;
                width: 100%;
            }
        }
        
        /* Mobile: 2 columnas solo cuando est√° activado */
        .productos-grid.dos-columnas {
            grid-template-columns: repeat(2, 1fr);
            max-width: 100% !important;
            width: 100%;
            gap: 0.75rem;  /* Reducir gap en m√≥vil */
            padding: 0;
            margin: 0;
        }
        
        /* üÜï BOT√ìN TOGGLE DE COLUMNAS */
        .toggle-columnas {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;  /* üÜï Reducido de 1.5rem */
            padding: 0.75rem;  /* üÜï Reducido de 1rem */
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .toggle-columnas label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            margin: 0;
        }
        
        .toggle-columnas input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
        }
        
        @media (min-width: 768px) {
            .toggle-columnas {
                display: none;
            }
        }
        
        .producto-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .producto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        
        .producto-imagen {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f9f9f9;
            padding: 1rem;
        }
        
        .producto-info {
            padding: 1rem;
        }
        
        .producto-nombre {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .producto-fabricante {
            color: #667eea;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .producto-presentacion {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .producto-diagnostico {
            background: #ffe6e6;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .producto-precio {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2ecc71;
            margin: 0.5rem 0;
        }
        
        .btn-agregar {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            width: calc(100% - 2rem);
        }
        
        .btn-agregar:hover {
            background: #5568d3;
        }
        
        .sin-resultados {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .carrito-flotante {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #667eea;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .carrito-flotante:hover {
            transform: scale(1.1);
        }
        
        .carrito-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .productos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üè• Medicamentos a Domicilio</h1>
            <p>Entrega en 30 minutos - Zona Norte de Cali</p>
        </div>
    </div>
    
    <div class="container">
        <!-- Filtros UNIFICADOS -->
        <div class="filtros">
            <h3>üîç BUSCA POR NOMBRE DE MEDICAMENTO Y/O DESCRIBE TUS SINTOMAS,AFECCIONES O NECESIDADES</h3>
            
            <div class="filtro-grupo" style="margin-bottom: 1rem;">
                <textarea 
                    id="busqueda_unificada" 
                    placeholder="Escribe aqui el nombre del medicamento o describe brevemente lo que sientes (necesidades, afecciones o sintomas)"
                    rows="1"
                    style="
                        width: 100%;
                        padding: 1rem;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        font-size: 1.1rem;
                        font-family: inherit;
                        resize: none;
                        overflow: hidden;
                        transition: border-color 0.3s;
                        min-height: 42px;  /* üÜï M√°s peque√±o */
                    "
                    oninput="autoExpand(this); clearTimeout(window.busquedaTimeout); window.busquedaTimeout = setTimeout(() => buscarProductos(), 800);"
                    onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); buscarProductos(); }"
                ></textarea>
                <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
                    üí° Escribe libremente lo que necesitas. Presiona Enter para buscar o espera 0.8s.
                </small>
            </div>
            
            <!-- Filtros de precio (opcional, colapsados) -->
            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; color: #667eea; font-weight: 600; user-select: none;">
                    ‚öôÔ∏è Filtros avanzados (opcional)
                </summary>
                <div class="filtros-grid" style="margin-top: 1rem;">
                    <div class="filtro-grupo">
                        <label>Precio M√≠nimo</label>
                        <input type="number" id="precioMin" placeholder="0">
                    </div>
                    
                    <div class="filtro-grupo">
                        <label>Precio M√°ximo</label>
                        <input type="number" id="precioMax" placeholder="50000">
                    </div>
                </div>
            </details>
        </div>
        
        <!-- üÜï Diagn√≥sticos Detectados -->
        <div id="diagnosticosDetectados" style="display: none;" class="diagnosticos-detectados">
            <h4>ü©∫ An√°lisis de tus s√≠ntomas:</h4>
            <div id="diagnosticosContent"></div>
            <div id="sintomasDetectados" class="sintomas-detectados"></div>
        </div>
        
        <!-- üÜï TOGGLE DE COLUMNAS (solo m√≥vil) -->
        <div class="toggle-columnas" id="toggleColumnasContainer">
            <label>
                <input type="checkbox" id="toggleDosColumnas">
                 Ver 2 medicamentos por pantalla
            </label>
        </div>
        
        <!-- Productos -->
        <div id="productosContainer" class="loading">
            Cargando productos...
        </div>
    </div>
    
    <!-- Carrito Flotante -->
    <div class="carrito-flotante" onclick="verCarrito()">
        üõí
        <span class="carrito-badge" id="carritoCount">0</span>
    </div>
    
    <script>
        let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
        actualizarBadgeCarrito();
        
        // Cargar productos al inicio
        window.addEventListener('DOMContentLoaded', () => {
            buscarProductos();
        });

        // Funci√≥n para auto-expandir el textarea
        function autoExpand(field) {
            field.style.height = 'inherit';
            
            const computed = window.getComputedStyle(field);
            const height = field.scrollHeight
                + parseInt(computed.getPropertyValue('border-top-width'), 10)
                + parseInt(computed.getPropertyValue('border-bottom-width'), 10);
            
            const maxHeight = 200;
            
            if (height > maxHeight) {
                field.style.height = maxHeight + 'px';
                field.style.overflowY = 'auto';
            } else {
                field.style.height = height + 'px';
                field.style.overflowY = 'hidden';
            }
        }

        function buscarProductos() {
            const busquedaUnificada = document.getElementById('busqueda_unificada').value;
            
            // üÜï No buscar si hay menos de 3 caracteres
            if (busquedaUnificada.trim().length > 0 && busquedaUnificada.trim().length < 3) {
                return; // Esperar a que escriba m√°s
            }
            
            const precioMin = document.getElementById('precioMin').value;
            const precioMax = document.getElementById('precioMax').value;
            const params = new URLSearchParams();
            
            if (busquedaUnificada) {
                params.append('sintomas_busqueda', busquedaUnificada);
                params.append('q', busquedaUnificada);
            }
            
            if (precioMin) params.append('precio_min', precioMin);
            if (precioMax) params.append('precio_max', precioMax);
            
            document.getElementById('productosContainer').innerHTML = '<div class="loading">Buscando...</div>';
            
            fetch(`/api/productos?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        mostrarDiagnosticos(data.sintomas_detectados || [], data.diagnosticos_posibles || []);
                        mostrarProductos(data.productos, data);  // üÜï Pasar todo el objeto data
                    } else {
                        document.getElementById('productosContainer').innerHTML = 
                            '<div class="sin-resultados">Error al cargar productos</div>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('productosContainer').innerHTML = 
                        '<div class="sin-resultados">Error de conexi√≥n</div>';
                });
        }
        


        function mostrarDiagnosticos(sintomas, diagnosticos) {
            const container = document.getElementById('diagnosticosDetectados');
            const content = document.getElementById('diagnosticosContent');
            const sintomasDiv = document.getElementById('sintomasDetectados');
            
            if (sintomas.length === 0 && diagnosticos.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const diagnosticosDirectos = diagnosticos.filter(d => d.es_directo);
            const diagnosticosPorSintomas = diagnosticos.filter(d => !d.es_directo);
            
            let html = '';
            
            if (diagnosticosDirectos.length > 0) {
                diagnosticosDirectos.forEach(d => {
                    html += `
                        <div class="diagnostico-directo" style="
                            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
                            border: 2px solid #667eea;
                            border-radius: 10px;
                            padding: 1rem;
                            margin-bottom: 1rem;
                        ">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">üéØ</span>
                                <strong style="color: #667eea; font-size: 1.1rem;">Diagn√≥stico y/o tratamiento identificado:</strong>
                                <span style="color: #333; font-size: 1.1rem; font-weight: 600;">${d.nombre}</span>
                            </div>
                    `;
                    
                    if (d.sintomas_faltantes && d.sintomas_faltantes.length > 0) {
                        html += `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    ‚ùì ¬øTambi√©n presentas estos s√≠ntomas y/o indicaciones?
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        `;
                        
                        d.sintomas_faltantes.forEach(sintoma => {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 5px; transition: background 0.2s;" 
                                       onmouseover="this.style.background='#f0f0f0'" 
                                       onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" 
                                           class="sintoma-faltante-check" 
                                           data-sintoma-id="${sintoma.id}" 
                                           data-sintoma-nombre="${sintoma.nombre}"
                                           style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: #555; font-size: 0.95rem;">${sintoma.nombre}</span>
                                </label>
                            `;
                        });
                        
                        html += `
                                </div>
                                <button onclick="refinarBusquedaConSintomasFaltantes()" 
                                        style="
                                            margin-top: 0.75rem;
                                            background: #667eea;
                                            color: white;
                                            border: none;
                                            padding: 0.5rem 1rem;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-weight: 600;
                                            transition: background 0.3s;
                                        "
                                        onmouseover="this.style.background='#5568d3'"
                                        onmouseout="this.style.background='#667eea'">
                            Refinar b√∫squeda
                        </button>
                    </div>
                `;
            }
            
            html += `</div>`;
        });
    }
    
    if (diagnosticosPorSintomas.length > 0) {
        diagnosticosPorSintomas.forEach(d => {
            html += `
                <div class="diagnostico-sintomas" style="
                    background: linear-gradient(135deg, #e74c3c15 0%, #c0392b15 100%);
                    border: 2px solid #e74c3c;
                    border-radius: 10px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                ">
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                        <span style="font-size: 1.5rem;">ü©∫</span>
                        <strong style="color: #e74c3c; font-size: 1rem;">Posible diagn√≥stico y/o tratamiento:</strong>
                        <span style="color: #333; font-size: 1rem; font-weight: 600;">${d.nombre}</span>
                        <span style="
                            background: #e74c3c;
                            color: white;
                            padding: 0.25rem 0.75rem;
                            border-radius: 15px;
                            font-size: 0.85rem;
                            font-weight: 600;
                        ">
                            ${d.coincidencias} de ${d.total_sintomas} s√≠ntomas - ${Math.round(d.porcentaje)}% match
                        </span>
                    </div>
                </div>
            `;
        });
    }
    
    if (diagnosticos.length === 0 && sintomas.length > 0) {
        html = '<p style="color: #666; font-size: 0.9rem;">No se detect√≥ un diagn√≥stico y/o tratamiento espec√≠fico, pero encontramos medicamentos para tus s√≠ntomas y/o indicaciones.</p>';
    }
    
    content.innerHTML = html;
    
    if (sintomas.length > 0) {
        sintomasDiv.innerHTML = `
            <strong style="display: block; margin-bottom: 0.5rem; color: #667eea;">S√≠ntomas y/o indicaciones detectadas:</strong>
            ${sintomas.map(s => `<span class="sintoma-tag">‚úì ${s}</span>`).join('')}
        `;
    }
}

        function refinarBusquedaConSintomasFaltantes() {
            const checkboxes = document.querySelectorAll('.sintoma-faltante-check:checked');
            
            if (checkboxes.length === 0) {
                alert('Por favor selecciona al menos un s√≠ntoma y/o indicaci√≥n adicional');
                return;
            }
            
            const busquedaActual = document.getElementById('busqueda_unificada').value;
            const nombresAdicionales = Array.from(checkboxes).map(cb => cb.dataset.sintomaNombre).join(' ');
            const nuevaBusqueda = busquedaActual + ' ' + nombresAdicionales;
            
            document.getElementById('busqueda_unificada').value = nuevaBusqueda;
            autoExpand(document.getElementById('busqueda_unificada'));
            buscarProductos();
            
            const mensaje = document.createElement('div');
            mensaje.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2ecc71;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            `;
            mensaje.innerHTML = `
                <strong>‚úÖ B√∫squeda refinada</strong><br>
                <span style="font-size: 0.9rem;">Incluyendo ${checkboxes.length} s√≠ntoma(s) y/o indicaci√≥n(es) adicional(es)</span>
            `;
            document.body.appendChild(mensaje);
            
            setTimeout(() => {
                mensaje.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => mensaje.remove(), 300);
            }, 3000);
        }

        if (!document.getElementById('diagnosticos-animations')) {
            const style = document.createElement('style');
            style.id = 'diagnosticos-animations';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
       
        
        
        function mostrarProductos(productos, data) {  // üÜï Agregamos 'data'
            const container = document.getElementById('productosContainer');
            
            // üÜï DETECTAR si es b√∫squeda por s√≠ntomas/diagn√≥sticos
            const esBusquedaInteligente = (data.sintomas_detectados && data.sintomas_detectados.length > 0) || 
                                        (data.diagnosticos_posibles && data.diagnosticos_posibles.length > 0);
            
            if (productos.length === 0) {
                // üÜï Detectar si es b√∫squeda de producto espec√≠fico o s√≠ntomas
                const busquedaActual = document.getElementById('busqueda_unificada').value.trim();
                const esProducto = esProductoEspecifico(busquedaActual);
                
                let mensaje = '';
                let tipoBusqueda = '';
                
                if (esProducto) {
                    tipoBusqueda = 'producto';
                    mensaje = `
                        <div class="sin-resultados" style="text-align: center; padding: 3rem 1.5rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîÑ</div>
                            <h3 style="color: #667eea; margin-bottom: 1rem;">Actualizando inventario</h3>
                            <p style="color: #666; margin-bottom: 2rem; line-height: 1.6;">
                                Este producto est√° en proceso de ingreso al sistema.<br>
                                <strong>¬øQuieres que verifiquemos disponibilidad inmediata?</strong>
                            </p>
                            <button onclick="abrirModalTelefono('${busquedaActual.replace(/'/g, "\\'")}', '${tipoBusqueda}')" 
                                    style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: white;
                                        border: none;
                                        padding: 1rem 2.5rem;
                                        border-radius: 50px;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        cursor: pointer;
                                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                                        transition: all 0.3s;
                                    "
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">
                                ‚úÖ Verificar disponibilidad ahora
                            </button>
                        </div>
                    `;
                } else {
                    tipoBusqueda = 'sintoma';
                    mensaje = `
                        <div class="sin-resultados" style="text-align: center; padding: 3rem 1.5rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ü©∫</div>
                            <h3 style="color: #667eea; margin-bottom: 1rem;">No encontramos productos exactos</h3>
                            <p style="color: #666; margin-bottom: 2rem; line-height: 1.6;">
                                Para estos s√≠ntomas o necesidades espec√≠ficas,<br>
                                <strong>nuestro equipo puede asesorarte personalmente</strong>
                            </p>
                            <button onclick="abrirModalTelefono('${busquedaActual.replace(/'/g, "\\'")}', '${tipoBusqueda}')" 
                                    style="
                                        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
                                        color: white;
                                        border: none;
                                        padding: 1rem 2.5rem;
                                        border-radius: 50px;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        cursor: pointer;
                                        box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
                                        transition: all 0.3s;
                                    "
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(46, 204, 113, 0.6)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(46, 204, 113, 0.4)';">
                                üí¨ Contactar asesor ahora
                            </button>
                        </div>
                    `;
                }
                
                container.innerHTML = mensaje;
                return;
            }
            
            container.classList.add('productos-grid');
            // üÜï MANTENER LA CLASE dos-columnas si est√° activada
            if (localStorage.getItem('productosDosColunas') === 'true') {
                container.classList.add('dos-columnas');
            }
            container.innerHTML = productos.map(p => `
            
            
                <div class="producto-card" onclick="abrirModalProducto(${JSON.stringify(p).replace(/"/g, '&quot;')})" style="cursor: pointer;">
                    
                    <img src="${p.imagen ? '/static/uploads/' + p.imagen : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23eee%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2220%22%3ESin imagen%3C/text%3E%3C/svg%3E'}"
                        alt="${p.nombre}"
                        class="producto-imagen"
                        style="cursor: pointer;"
                        onclick="event.stopPropagation(); abrirModalImagen('${p.imagen ? '/static/uploads/' + p.imagen : 'https://placehold.co/300x300'}', '${p.nombre}')">
                    <div class="producto-info">
                        <div class="producto-nombre">${p.nombre}</div>
                        <div class="producto-fabricante">${p.fabricante}</div>
                        <div class="producto-presentacion">
                           ${p.concentracion && p.concentracion.toUpperCase() !== 'NONE' ? p.concentracion : ''}
                           ${p.presentacion && p.presentacion.toUpperCase() !== 'NONE' ? p.presentacion : ''}
                        </div>
                        
                        ${p.diagnostico_detectado ? `
                            <div class="producto-diagnostico">
                                ü©∫ Posible diagn√≥stico y/o tratamiento: <strong>${p.diagnostico_detectado}</strong>
                            </div>
                        ` : ''}
                        
                        <div class="producto-precio">$${formatearPrecio(p.precio)}</div>
                        
                        ${p.componente_activo ? `<div style="font-size: 0.85rem; color: #764ba2; font-weight: 500; margin-bottom: 0.5rem;">üíä Principio Activo: ${p.componente_activo}</div>` : ''}
                        
                        ${p.coincidencias > 0 ? `<div style="font-size: 0.85rem; color: #2ecc71; font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Trata ${p.coincidencias} de tus s√≠ntomas y/o indicaciones</div>` : ''}
                        
                        ${p.sintomas_filtrados && p.sintomas_filtrados.length > 0 ? `<div style="font-size: 0.85rem; color: #667eea; font-weight: 500; margin-bottom: 0.5rem;">‚úÖ Trata: ${p.sintomas_filtrados.join(', ')}</div>` : ''}
                        
                        <button type="button" id="btn-sintomas-${p.precio_id}" style="font-size: 0.8rem; color: #667eea; background: none; border: none; cursor: pointer; text-decoration: underline; padding: 0;" onclick="toggleSintomas(${p.precio_id})">
                            ${esBusquedaInteligente ? 'üîº' : 'üîΩ'} ${esBusquedaInteligente ? 'Ocultar' : 'Ver'} s√≠ntomas y/o indicaciones
                        </button>
                        <div id="sintomas-${p.precio_id}" style="display: ${esBusquedaInteligente ? 'block' : 'none'}; font-size: 0.85rem; color: #667eea; font-weight: 500; margin: 0.5rem 0;">
                            ‚úÖ Trata: ${p.sintomas_totales.join(', ')}
                        </div>
                        
                        <div style="margin-bottom: 2.5rem;"></div>
                        <button class="btn-agregar" onclick='agregarAlCarrito(${JSON.stringify(p)})'>
                            Agregar al Carrito
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function formatearPrecio(precio) {
            return new Intl.NumberFormat('es-CO').format(precio);
        }
        
        function agregarAlCarrito(producto) {
            if (!producto.precio || producto.precio <= 0) {
                alert('Este producto no tiene precio disponible');
                return;
            }
            
            const index = carrito.findIndex(item => item.precio_id === producto.precio_id);
            
            if (index >= 0) {
                carrito[index].cantidad++;
            } else {
                carrito.push({
                    ...producto,
                    cantidad: 1
                });
            }
            
            localStorage.setItem('carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            
            alert(`${producto.nombre} (${producto.fabricante}) agregado al carrito`);
        }
        
        function actualizarBadgeCarrito() {
            const total = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            document.getElementById('carritoCount').textContent = total;
        }
        
        function verCarrito() {
            window.location.href = '/tienda/carrito';
        }

        function toggleSintomas(precioId) {
            const div = document.getElementById(`sintomas-${precioId}`);
            const btn = document.getElementById(`btn-sintomas-${precioId}`);
            
            if (div.style.display === 'none') {
                div.style.display = 'block';
                btn.innerHTML = 'üîº Ocultar s√≠ntomas y/o indicaciones';
            } else {
                div.style.display = 'none';
                btn.innerHTML = 'üîΩ Ver s√≠ntomas y/o indicaciones';
            }
        }

        // üÜï MODAL COMPLETO DEL PRODUCTO
        function abrirModalProducto(producto) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: flex-start;
                justify-content: center;
                z-index: 9999;
                overflow-y: auto;
                padding: 0.5rem;
                padding-top: 2rem;
            `;
            
            const contenido = document.createElement('div');
            contenido.style.cssText = `
                position: relative;
                background: white;
                border-radius: 15px;
                max-width: 500px;
                width: 100%;
                padding: 1.5rem;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            const imagenHtml = producto.imagen ? `/static/uploads/${producto.imagen}` : 'https://placehold.co/300x300';
            
            contenido.innerHTML = `
                <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; font-weight: bold;">‚úï</button>
                
                <img src="${imagenHtml}" alt="${producto.nombre}" style="width: 100%; height: 250px; object-fit: contain; border-radius: 10px; margin-bottom: 1.5rem;">
                
                <div style="margin-bottom: 1rem;">
                    <h2 style="font-size: 1.5rem; color: #333; margin-bottom: 0.5rem;">${producto.nombre}</h2>
                    <p style="font-size: 1.1rem; color: #667eea; font-weight: 600; margin-bottom: 0.5rem;">${producto.fabricante}</p>
                    ${producto.concentracion && producto.concentracion.toUpperCase() !== 'NONE' ? `<p style="font-size: 0.95rem; color: #666;">${producto.concentracion}</p>` : ''}
                    ${producto.presentacion && producto.presentacion.toUpperCase() !== 'NONE' ? `<p style="font-size: 0.95rem; color: #666;">${producto.presentacion}</p>` : ''}
                </div>
                
                ${producto.diagnostico_detectado ? `
                    <div style="background: #e8f4f8; border-left: 4px solid #667eea; padding: 0.75rem; margin-bottom: 1rem; border-radius: 5px;">
                        <div style="font-size: 0.9rem; color: #667eea; font-weight: 600;">ü©∫ Posible diagn√≥stico y/o tratamiento:</div>
                        <div style="font-size: 0.95rem; color: #333; margin-top: 0.25rem;">${producto.diagnostico_detectado}</div>
                    </div>
                ` : ''}
                
                ${producto.componente_activo ? `
                    <div style="background: #f0f4ff; padding: 0.75rem; margin-bottom: 1rem; border-radius: 5px;">
                        <div style="font-size: 0.9rem; color: #764ba2; font-weight: 600;">üíä Principio Activo:</div>
                        <div style="font-size: 0.95rem; color: #333; margin-top: 0.25rem;">${producto.componente_activo}</div>
                    </div>
                ` : ''}
                
                ${producto.sintomas_totales && producto.sintomas_totales.length > 0 ? `
                    <div style="background: #e8f8f0; padding: 0.75rem; margin-bottom: 1rem; border-radius: 5px;">
                        <div style="font-size: 0.9rem; color: #2ecc71; font-weight: 600;">‚úÖ Trata estos s√≠ntomas y/o indicaciones:</div>
                        <div style="font-size: 0.85rem; color: #333; margin-top: 0.5rem; line-height: 1.6;">${producto.sintomas_totales.join(', ')}</div>
                    </div>
                ` : ''}
                
                <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 1.5rem; border-radius: 10px; text-align: center; margin-bottom: 2.5rem;">
                    <div style="font-size: 2rem; font-weight: 700;">$${formatearPrecio(producto.precio)}</div>
                </div>
                
                <button class="btn-agregar" onclick='agregarAlCarrito(${JSON.stringify(producto)})' style="position: relative !important; bottom: auto !important; left: auto !important; right: auto !important; width: 100% !important; box-sizing: border-box; padding: 1.2rem; font-size: 1.3rem; font-weight: 700; margin-bottom: 0.75rem; line-height: 1.4;">
                    ‚úÖ Agregar al Carrito
                </button>
                
                <button onclick="this.closest('div').parentElement.remove()" style="width: 100%; padding: 1rem; font-size: 1rem; background: #e0e0e0; color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Volver
                </button>
            `;
            
            modal.appendChild(contenido);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        function abrirModalImagen(imagenSrc, nombreProducto) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
            `;
            
            const contenido = document.createElement('div');
            contenido.style.cssText = `
                position: relative;
                background: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 600px;
                max-height: 80vh;
                overflow: auto;
            `;
            
            contenido.innerHTML = `
                <img src="${imagenSrc}" alt="${nombreProducto}" style="width: 100%; border-radius: 8px;">
                <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px;">‚úï</button>
            `;
            
            modal.appendChild(contenido);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        // üÜï L√ìGICA DEL TOGGLE DE COLUMNAS
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('toggleDosColumnas');
            const container = document.getElementById('productosContainer');
            
            // Cargar preferencia guardada
            const dosColumnasGuardada = localStorage.getItem('productosDosColunas') === 'true';
            toggle.checked = dosColumnasGuardada;
            
            if (dosColumnasGuardada && window.innerWidth < 768) {
                container.classList.add('dos-columnas');
            }
            
            // Manejar cambios
            toggle.addEventListener('change', function() {
                localStorage.setItem('productosDosColunas', this.checked);
                
                if (this.checked) {
                    container.classList.add('dos-columnas');
                } else {
                    container.classList.remove('dos-columnas');
                }
            });
        });
        
        // üÜï BOT√ìN VOLVER ARRIBA FLOTANTE
        const scrollButton = document.createElement('button');
        scrollButton.id = 'scrollToTop';
        scrollButton.innerHTML = '‚¨ÜÔ∏è Arriba';
        scrollButton.style.cssText = `
            position: fixed;
            bottom: 40px;
            left: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.8rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            display: none;
            z-index: 999;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        `;
        
        scrollButton.addEventListener('mouseover', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.6)';
        });
        
        scrollButton.addEventListener('mouseout', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
        });
        
        scrollButton.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        document.body.appendChild(scrollButton);
        
        window.addEventListener('scroll', function() {
            if (window.scrollY > 300) {
                scrollButton.style.display = 'block';
            } else {
                scrollButton.style.display = 'none';
            }
        });



        // ============================================
        // üÜï FUNCIONES PARA SOLICITUDES ESPECIALES
        // ============================================
        
        function esProductoEspecifico(texto) {
            /**
             * Detecta si la b√∫squeda es un producto espec√≠fico o s√≠ntomas/necesidades
             * Retorna: true = producto, false = s√≠ntomas
             */
            if (!texto || texto.length < 3) return false;
            
            const textoLower = texto.toLowerCase().trim();
            const palabras = textoLower.split(/\s+/);
            
            // Palabras que indican S√çNTOMAS (no producto)
            const indicadoresSintomas = [
                'me', 'tengo', 'siento', 'duele', 'dolor', 'arde', 'ardor',
                'pica', 'picaz√≥n', 'molesta', 'siento', 'estoy', 'sufro',
                'padezco', 'presento', 'ten√≠a', 'sent√≠a'
            ];
            
            // Si tiene palabras de s√≠ntomas = NO es producto
            const tieneSintomas = palabras.some(p => indicadoresSintomas.includes(p));
            if (tieneSintomas) return false;
            
            // Si es muy largo (m√°s de 6 palabras) = probablemente s√≠ntomas
            if (palabras.length > 6) return false;
            
            // Patrones que indican PRODUCTO espec√≠fico
            const patronesProducto = [
                /\d+\s*(mg|ml|g|mcg|ui)/i,  // Tiene dosis: 500mg, 20ml
                /(forte|plus|max|extra|duo|triple)/i,  // Sufijos comerciales
                /(mk|bayer|genfar|tecnoquimicas|lafrancol)/i,  // Laboratorios
                /^[a-z]+(\s+[a-z]+){0,2}$/i  // 1-3 palabras simples
            ];
            
            const esProducto = patronesProducto.some(patron => patron.test(textoLower));
            if (esProducto) return true;
            
            // Por defecto: si es corto (1-3 palabras) = producto
            return palabras.length <= 3;
        }
        
        function abrirModalTelefono(busqueda, tipo) {
            /**
             * Abre modal para capturar tel√©fono del cliente
             * @param {string} busqueda - Lo que busc√≥ el cliente
             * @param {string} tipo - 'producto' o 'sintoma'
             */
            const modal = document.createElement('div');
            modal.id = 'modalSolicitudEspecial';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 1rem;
            `;
            
            const emoji = tipo === 'producto' ? 'üíä' : 'ü©∫';
            const titulo = tipo === 'producto' ? 'Verificar disponibilidad' : 'Asesor√≠a personalizada';
            const colorBoton = tipo === 'producto' ? '#667eea' : '#2ecc71';
            const colorBotonHover = tipo === 'producto' ? '#5568d3' : '#27ae60';
            
            const contenido = document.createElement('div');
            contenido.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 2rem;
                max-width: 450px;
                width: 100%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            contenido.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${emoji}</div>
                    <h2 style="color: #333; margin-bottom: 0.5rem; font-size: 1.5rem;">${titulo}</h2>
                    <p style="color: #666; font-size: 0.95rem; line-height: 1.5;">
                        Para confirmar disponibilidad inmediata,<br>necesitamos tu n√∫mero de contacto
                    </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Buscaste:</div>
                    <div style="font-weight: 600; color: #333;">"${busqueda}"</div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 600; color: #555; margin-bottom: 0.5rem;">
                        Tel√©fono celular üì± <span style="color: #e74c3c;">*</span>
                    </label>
                    <input 
                        type="tel" 
                        id="telefonoSolicitud"
                        placeholder="300 123 4567"
                        maxlength="12"
                        style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 1.1rem;
                            text-align: center;
                            letter-spacing: 1px;
                            transition: border-color 0.3s;
                        "
                        oninput="formatearTelefono(this)"
                        onkeypress="if(event.key === 'Enter') enviarSolicitudEspecial('${busqueda}', '${tipo}')"
                    >
                    <div id="errorTelefono" style="color: #e74c3c; font-size: 0.85rem; margin-top: 0.5rem; display: none;"></div>
                    <div style="color: #999; font-size: 0.8rem; margin-top: 0.5rem; text-align: center;">
                        Ejemplo: 300 123 4567 (10 d√≠gitos)
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p style="font-size: 0.85rem; color: #666; line-height: 1.5; text-align: center;">
                        ‚è±Ô∏è Te contactaremos en <strong>menos de 5 minutos</strong> para confirmar disponibilidad y precio
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button 
                        onclick="document.getElementById('modalSolicitudEspecial').remove()"
                        style="
                            flex: 1;
                            padding: 0.9rem;
                            background: #e0e0e0;
                            color: #666;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.3s;
                        "
                        onmouseover="this.style.background='#d0d0d0'"
                        onmouseout="this.style.background='#e0e0e0'">
                        Cancelar
                    </button>
                    <button 
                        onclick="enviarSolicitudEspecial('${busqueda.replace(/'/g, "\\'")}', '${tipo}')"
                        style="
                            flex: 2;
                            padding: 0.9rem;
                            background: ${colorBoton};
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.3s;
                        "
                        onmouseover="this.style.background='${colorBotonHover}'"
                        onmouseout="this.style.background='${colorBoton}'">
                        ‚úÖ Enviar solicitud
                    </button>
                </div>
            `;
            
            modal.appendChild(contenido);
            document.body.appendChild(modal);
            
            // Cerrar con ESC
            document.addEventListener('keydown', function cerrarConEsc(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', cerrarConEsc);
                }
            });
            
            // Cerrar al hacer click fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Focus en el input
            setTimeout(() => {
                document.getElementById('telefonoSolicitud').focus();
            }, 100);
        }
        
        function formatearTelefono(input) {
            /**
             * Formatea el tel√©fono mientras escribe: 300 123 4567
             * Solo permite n√∫meros y auto-formatea con espacios
             */
            let valor = input.value.replace(/\D/g, ''); // Solo n√∫meros
            
            // Limitar a 10 d√≠gitos
            if (valor.length > 10) {
                valor = valor.substring(0, 10);
            }
            
            // Formatear: 300 123 4567
            if (valor.length > 6) {
                valor = valor.substring(0, 3) + ' ' + valor.substring(3, 6) + ' ' + valor.substring(6);
            } else if (valor.length > 3) {
                valor = valor.substring(0, 3) + ' ' + valor.substring(3);
            }
            
            input.value = valor;
            
            // Cambiar borde a verde si est√° completo
            const soloNumeros = valor.replace(/\s/g, '');
            if (soloNumeros.length === 10 && soloNumeros.startsWith('3')) {
                input.style.borderColor = '#2ecc71';
            } else {
                input.style.borderColor = '#e0e0e0';
            }
        }
        
        function validarTelefono(telefono) {
            /**
             * Valida que el tel√©fono sea correcto
             * @returns {object} {valido: boolean, error: string}
             */
            const soloNumeros = telefono.replace(/\s/g, '');
            
            if (!soloNumeros) {
                return {valido: false, error: 'El tel√©fono es obligatorio'};
            }
            
            if (soloNumeros.length !== 10) {
                return {valido: false, error: 'Debe tener exactamente 10 d√≠gitos'};
            }
            
            if (!soloNumeros.startsWith('3')) {
                return {valido: false, error: 'Debe ser un celular (iniciar con 3)'};
            }
            
            return {valido: true, error: ''};
        }
        
        function enviarSolicitudEspecial(busqueda, tipo) {
            /**
             * Env√≠a la solicitud especial al backend
             */
            const input = document.getElementById('telefonoSolicitud');
            const errorDiv = document.getElementById('errorTelefono');
            const telefono = input.value;
            
            // Validar
            const validacion = validarTelefono(telefono);
            if (!validacion.valido) {
                errorDiv.textContent = '‚ùå ' + validacion.error;
                errorDiv.style.display = 'block';
                input.style.borderColor = '#e74c3c';
                input.focus();
                return;
            }
            
            // Limpiar error
            errorDiv.style.display = 'none';
            
            // Tel√©fono sin espacios para enviar
            const telefonoLimpio = telefono.replace(/\s/g, '');
            
            // Deshabilitar bot√≥n mientras env√≠a
            const btnEnviar = event.target;
            const textoOriginal = btnEnviar.innerHTML;
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '‚è≥ Enviando...';
            btnEnviar.style.opacity = '0.6';
            
            // Enviar a Flask
            fetch('/tienda/solicitud_especial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    telefono: telefonoLimpio,
                    busqueda: busqueda,
                    tipo: tipo
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    // Cerrar modal
                    document.getElementById('modalSolicitudEspecial').remove();
                    
                    // Mostrar confirmaci√≥n
                    mostrarConfirmacionSolicitud(data.mensaje, tipo);
                } else {
                    errorDiv.textContent = '‚ùå ' + (data.error || 'Error al enviar solicitud');
                    errorDiv.style.display = 'block';
                    btnEnviar.disabled = false;
                    btnEnviar.innerHTML = textoOriginal;
                    btnEnviar.style.opacity = '1';
                }
            })
            .catch(err => {
                console.error('Error:', err);
                errorDiv.textContent = '‚ùå Error de conexi√≥n. Intenta nuevamente';
                errorDiv.style.display = 'block';
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = textoOriginal;
                btnEnviar.style.opacity = '1';
            });
        }
        
        function mostrarConfirmacionSolicitud(mensaje, tipo) {
            /**
             * Muestra confirmaci√≥n visual despu√©s de enviar solicitud
             */
            const emoji = tipo === 'producto' ? 'üíä' : 'ü©∫';
            const color = tipo === 'producto' ? '#667eea' : '#2ecc71';
            
            const confirmacion = document.createElement('div');
            confirmacion.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 2.5rem;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
                max-width: 400px;
                animation: aparecer 0.3s ease-out;
            `;
            
            confirmacion.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 1rem;">${emoji}</div>
                <div style="font-size: 3rem; color: #2ecc71; margin-bottom: 1rem;">‚úÖ</div>
                <h3 style="color: ${color}; margin-bottom: 1rem; font-size: 1.4rem;">¬°Solicitud recibida!</h3>
                <p style="color: #666; line-height: 1.6; margin-bottom: 1.5rem;">
                    ${mensaje}
                </p>
                <button 
                    onclick="this.parentElement.remove()"
                    style="
                        padding: 0.9rem 2rem;
                        background: ${color};
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                    ">
                    Entendido
                </button>
            `;
            
            document.body.appendChild(confirmacion);
            
            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                if (confirmacion.parentElement) {
                    confirmacion.remove();
                }
            }, 5000);
        }
        
        // Agregar animaci√≥n
        if (!document.getElementById('animacion-solicitud')) {
            const style = document.createElement('style');
            style.id = 'animacion-solicitud';
            style.textContent = `
                @keyframes aparecer {
                    from { 
                        opacity: 0;
                        transform: translate(-50%, -50%) scale(0.9);
                    }
                    to { 
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1);
                    }
                }
            `;
            document.head.appendChild(style);
        }



        <!-- üîí Sistema de acceso oculto y reporte interno -->
        
        document.addEventListener('DOMContentLoaded', () => {
            // 1. A√±adir listener al t√≠tulo para activar autenticaci√≥n
            const titulo = document.querySelector('.header h1');
            if (titulo) {
                let intentos = 0;
                titulo.addEventListener('click', () => {
                    intentos++;
                    if (intentos < 3) return; // Requiere 3 clics r√°pidos (opcional para m√°s secreto)
                    intentos = 0;

                    const claveSecreta = prompt("üîê Clave de acceso (invisible):");
                    if (claveSecreta === "admin123") { // üîë Cambia esta clave si lo deseas
                        mostrarReporteInterno();
                    }
                });
            }
        });

        function mostrarReporteInterno() {
            // Buscar datos ya cargados (asumiendo que ya se llam√≥ a buscarProductos)
            const productos = window.ultimosProductos || [];

            const total = productos.length;
            const sinSintomas = productos.filter(p => 
                !p.sintomas_totales || p.sintomas_totales.length === 0
            ).length;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                font-family: monospace;
            `;
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 0 30px rgba(0,0,0,0.6);
                ">
                    <h3 style="color: #e74c3c; margin-bottom: 1.5rem;">üîí Reporte Interno (Solo Admin)</h3>
                    <p><strong>üïó Fecha/hora:</strong> ${new Date().toLocaleString('es-CO')}</p>
                    <p><strong>üì¶ Total productos montados:</strong> ${total}</p>
                    <p><strong>‚ö†Ô∏è Productos sin s√≠ntomas:</strong> ${sinSintomas}</p>
                    <p style="margin-top: 1.5rem; font-size: 0.85rem; color: #666;">
                        Este reporte se basa en la √∫ltima carga de productos.
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-top: 1.5rem; padding: 0.5rem 1.5rem; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Cerrar
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Guardar productos globalmente para el reporte
        const originalBuscarProductos = window.buscarProductos;
        window.buscarProductos = function() {
            const busquedaUnificada = document.getElementById('busqueda_unificada').value;
            if (busquedaUnificada.trim().length > 0 && busquedaUnificada.trim().length < 3) return;

            const precioMin = document.getElementById('precioMin').value;
            const precioMax = document.getElementById('precioMax').value;
            const params = new URLSearchParams();
            if (busquedaUnificada) {
                params.append('sintomas_busqueda', busquedaUnificada);
                params.append('q', busquedaUnificada);
            }
            if (precioMin) params.append('precio_min', precioMin);
            if (precioMax) params.append('precio_max', precioMax);

            document.getElementById('productosContainer').innerHTML = '<div class="loading">Buscando...</div>';
            fetch(`/api/productos?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        window.ultimosProductos = data.productos; // ‚úÖ Guardar para el reporte
                        mostrarDiagnosticos(data.sintomas_detectados || [], data.diagnosticos_posibles || []);
                        mostrarProductos(data.productos, data);
                    } else {
                        document.getElementById('productosContainer').innerHTML = 
                            '<div class="sin-resultados">Error al cargar productos</div>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('productosContainer').innerHTML = 
                        '<div class="sin-resultados">Error de conexi√≥n</div>';
                });
        };





    </script>
</body>
</html>