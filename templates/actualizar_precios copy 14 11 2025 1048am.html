<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Actualizar Precios</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 620px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        h1 { color: #007b5e; font-size: 1.4em; }
        
        /* Panel de configuraci√≥n */
        .panel-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .panel-config h2 {
            margin-top: 0;
            font-size: 1.1em;
            color: #495057;
            margin-bottom: 12px;
        }
        .config-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .config-item {
            flex: 1;
            min-width: 140px;
        }
        .config-item label {
            display: block;
            font-size: 0.82em;
            color: #555;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .config-item input,
        .config-item select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.92em;
            box-sizing: border-box;
        }
        .config-feedback {
            font-size: 0.85em;
            color: #28a745;
            margin-left: 8px;
            min-width: 90px;
            align-self: flex-end;
            padding-bottom: 6px;
        }

        /* Medicamento */
        .medicamento-card { 
            background: #f9f9f9; 
            padding: 15px; 
            margin: 0; 
            border-radius: 8px; 
            border-left: 4px solid #007b5e;
        }
        input[type="text"], input[type="number"], select { 
            padding: 6px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .input-ancho {
            flex: 1 !important;
            min-width: 0 !important;
            width: auto !important;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .btn { 
            padding: 6px 12px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.9em; 
            white-space: nowrap;
        }
        .btn-buscar { background: #007b5e; color: white; padding: 4px 8px; font-size: 0.8em; }
        .btn-guardar { background: #28a745; color: white; }
        .btn-agregar { background: #17a2b8; color: white; }
        .btn-siguiente { background: #ffc107; color: black; }
        .btn-escaso {
            padding: 4px 10px;
            font-size: 0.85em;
            border-radius: 4px;
            margin-left: 8px;
        }
        .btn-escaso.normal { background: #6c757d; color: white; }
        .btn-escaso.escaso { background: #fd7e14; color: white; }
        .btn-nuevo-fab { 
            background: #6c757d; 
            color: white; 
            padding: 4px 10px; 
            font-size: 0.85em;
            border-radius: 4px;
            margin-left: 8px;
            white-space: nowrap;
        }
        .precio-sugerido-input {
            width: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1em;
        }
        .guardado-ok { 
            color: #28a745; 
            font-size: 0.9em; 
            margin-left: 10px; 
        }
        .imagen-preview {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        .imagen-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .sin-medicamentos {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 1.1em;
        }
        .imagen-activa {
            border-color: #28a745 !important;
            background: #e8f5e9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Actualizar Precios con Competencia</h1>
        
        <!-- PANEL DE CONFIGURACI√ìN GLOBAL -->
        <div class="panel-config">
            <h2>‚öôÔ∏è Reglas de precios (se guardan autom√°ticamente)</h2>
            <div class="config-row">
                <div class="config-item">
                    <label>Descuento vs. competencia ($)</label>
                    <input type="number" id="cfg_descuento" value="{{ config.descuento_competencia or 200 }}" min="0" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Redondeo superior ($)</label>
                    <input type="number" id="cfg_redondeo" value="{{ config.redondeo_superior or 100 }}" min="10" step="10" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Recargo para escasos (%)</label>
                    <input type="number" id="cfg_recargo" value="{{ config.recargo_escaso or 30 }}" min="0" max="100" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Ganancia m√≠nima escaso ($)</label>
                    <input type="number" id="cfg_ganancia_min" value="{{ config.ganancia_min_escaso or 2000 }}" min="0" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Ganancia m√°xima escaso ($)</label>
                    <input type="number" id="cfg_ganancia_max" value="{{ config.ganancia_max_escaso or 10000 }}" min="0" onblur="guardarConfiguracionSimple()">
                </div>
                <div class="config-item">
                    <label>Base para c√°lculo en modo escaso</label>
                    <select id="cfg_base_escaso" onchange="guardarConfiguracionSimple()">
                        <option value="minimo" {% if config.base_escaso == 'minimo' %}selected{% endif %}>M√≠nimo de competencia</option>
                        <option value="maximo" {% if config.base_escaso == 'maximo' %}selected{% endif %}>M√°ximo de competencia</option>
                    </select>
                </div>
                <div class="config-feedback" id="cfg_feedback"></div>
            </div>
        </div>

        {% if medicamentos and medicamentos|length > 0 %}
            {% set med = medicamentos[0] %}
            <div class="medicamento-card" 
                 data-med-id="{{ med[0] }}" 
                 data-precio-id="{{ med[5] }}"
                 data-nombre-original="{{ med[1] }}">
                
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 1; min-width: 0; width: 0;">
                        <div style="margin-bottom: 15px;margin-top: auto;">
                            <div style="margin-bottom: -15px;">
                                <label style="font-size: 0.9em; color: #666;">Medicamento:</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="text"
                                        id="nombre_{{ med[0] }}"
                                        value="{{ med[1] }}"
                                        placeholder="Nombre del medicamento"
                                        onblur="actualizarNombre({{ med[0] }})"
                                        style="width: 100% !important; min-width: 400px !important; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; box-sizing: border-box;">
                                    <button class="btn btn-escaso normal" id="btn_escaso_{{ med[0] }}" onclick="toggleEscaso({{ med[0] }})">
                                        Normal
                                    </button>
                                    
                                </div>
                                <span id="guardado_nombre_{{ med[0] }}" class="NOMBRE MODIFICADO!" style="margin-left: 10px;"></span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <button class="btn" style="margin-left: 350px; background: #dc3545; color: white;" onclick="eliminarMedicamento({{ med[0] }})">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                            <div>
                                <label style="font-size: 0.9em; color: #666;">Fabricante:</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <select id="fabricante_{{ med[0] }}" class="input-ancho">
                                        {% for fab in fabricantes %}
                                        <option value="{{ fab[0] }}" {% if fab[0] == med[2] %}selected{% endif %}>
                                            {{ fab[1] }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-nuevo-fab" onclick="crearFabricante({{ med[0] }})">
                                        ‚ûï Nuevo
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            {% for comp in competidores %}
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="min-width: 100px; font-size: 0.9em; font-weight: bold; color: #666;">
                                    {{ comp[1] }}
                                </label>
                                <div style="display: flex; align-items: center; gap: 0; flex: 1;">
                                    <span style="font-size: 0.9em; padding: 6px 4px;">$</span>
                                    <input type="number" 
                                        class="precio-competidor" 
                                        data-comp-id="{{ comp[0] }}"
                                        data-med-id="{{ med[0] }}"
                                        placeholder="0"
                                        oninput="calcularSugerido({{ med[0] }})"
                                        style="width: 115px; padding: 6px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; font-size: 0.85em;">
                                    <button class="btn btn-buscar" 
                                            onclick="buscarEnFarmacia('{{ comp[1] }}', {{ med[0] }}, {{ comp[0] }})"
                                            style="padding: 6px 10px; font-size: 0.9em; background: #007b5e; color: white; border-radius: 0 4px 4px 0; border: 1px solid #007b5e; margin-left: -1px;">
                                        üîç
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; align-self: flex-end;">
                        <!-- ‚úÖ SIEMPRE UNA IMAGEN, incluso si no existe -->
                        <div class="imagen-preview" 
                             id="imagen-contenedor_{{ med[0] }}"
                             data-precio-id="{{ med[5] }}"
                             data-med-id="{{ med[0] }}"
                             title="Clic para pegar o cambiar imagen">
                            <img id="imagen_{{ med[0] }}"
                                src="{% if med[6] %}/static/uploads/{{ med[6] }}{% else %}data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'><rect fill='%23f0f0f0' width='150' height='150'/><text x='50%' y='50%' fill='%23999' font-size='14' text-anchor='middle' dominant-baseline='middle'>+</text></svg>{% endif %}"
                                alt="Imagen producto"
                                style="cursor: pointer;">
                        </div>
                        <small style="color: #666; font-size: 0.8em; text-align: center;">
                            Imagen del producto (para la tienda)
                        </small>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center; margin: 15px 0;">
                    <label style="font-weight: bold; color: #666;">üí∞ Precio sugerido:</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="font-size: 0.9em;">$</span>
                        <input type="number" 
                            id="sugerido_{{ med[0] }}" 
                            class="precio-sugerido-input"
                            data-med-id="{{ med[0] }}"
                            placeholder="0"
                            value="{{ med[3] or 0 }}"
                            oninput="guardarSugeridoManual({{ med[0] }})">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-guardar" onclick="guardarPrecios({{ med[0] }}, this.closest('[data-med-id]').dataset.precioId || null)">
                        üíæ Guardar
                    </button>
                    <button class="btn btn-agregar" onclick="agregarFabricante({{ med[0] }})">
                        ‚ûï Otro fabricante
                    </button>
                    <button class="btn btn-siguiente" onclick="location.reload()">
                        ‚è≠Ô∏è Siguiente medicamento
                    </button>
                    <span id="guardado_precio_{{ med[0] }}" class="guardado-ok"></span>
                </div>
            </div>
        {% else %}
            <div class="sin-medicamentos">
                ‚úÖ ¬°Todos los medicamentos ya tienen precio asignado!<br>
                <small>No hay medicamentos pendientes por actualizar.</small>
            </div>
        {% endif %}
    </div>

    <script>
        // === CONFIGURACI√ìN GLOBAL ===
        let reglas = {
            descuento: parseInt(document.getElementById('cfg_descuento').value) || 200,
            recargo: parseInt(document.getElementById('cfg_recargo').value) || 30,
            redondeo: parseInt(document.getElementById('cfg_redondeo').value) || 100,
            gananciaMin: parseInt(document.getElementById('cfg_ganancia_min').value) || 2000,
            gananciaMax: parseInt(document.getElementById('cfg_ganancia_max').value) || 10000,
            baseEscaso: document.getElementById('cfg_base_escaso').value || 'minimo'
        };

        function guardarConfiguracionSimple() {
            const payload = {
                descuento_competencia: parseInt(document.getElementById('cfg_descuento').value) || 200,
                recargo_escaso: parseInt(document.getElementById('cfg_recargo').value) || 30,
                redondeo_superior: parseInt(document.getElementById('cfg_redondeo').value) || 100,
                ganancia_min_escaso: parseInt(document.getElementById('cfg_ganancia_min').value) || 2000,
                ganancia_max_escaso: parseInt(document.getElementById('cfg_ganancia_max').value) || 10000,
                base_escaso: document.getElementById('cfg_base_escaso').value || 'minimo'
            };

            reglas = {
                descuento: payload.descuento_competencia,
                recargo: payload.recargo_escaso,
                redondeo: payload.redondeo_superior,
                gananciaMin: payload.ganancia_min_escaso,
                gananciaMax: payload.ganancia_max_escaso,
                baseEscaso: payload.base_escaso
            };

            fetch('/admin/guardar-configuracion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    const feedback = document.getElementById('cfg_feedback');
                    feedback.textContent = '‚úÖ Actualizado';
                    setTimeout(() => { feedback.textContent = ''; }, 2000);
                }
            })
            .catch(err => {
                console.error('Error al guardar configuraci√≥n:', err);
                alert('‚ùå Error al guardar: ' + err.message);
            });
        }

        // === L√ìGICA DE PRECIOS ===
        function redondearArriba(valor, base) {
            return Math.ceil(valor / base) * base;
        }

        function calcularSugerido(medId) {
            const esEscaso = document.getElementById(`btn_escaso_${medId}`).classList.contains('escaso');
            const precios = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
            const valores = Array.from(precios)
                .map(input => parseFloat(input.value) || 0)
                .filter(val => val > 0);

            let sugerido = 0;
            if (valores.length === 0) {
                sugerido = 0;
            } else if (esEscaso || valores.length === 1) {
                let precioBase;
                if (valores.length === 1) {
                    precioBase = valores[0];
                } else {
                    if (reglas.baseEscaso === 'maximo') {
                        precioBase = Math.max(...valores);
                    } else {
                        precioBase = Math.min(...valores);
                    }
                }
                const recargoPorcentual = precioBase * (reglas.recargo / 100);
                const ganancia = Math.max(
                    reglas.gananciaMin,
                    Math.min(reglas.gananciaMax, recargoPorcentual)
                );
                sugerido = precioBase + ganancia;
            } else {
                const maxCompetencia = Math.max(...valores);
                sugerido = Math.max(0, maxCompetencia - reglas.descuento);
            }

            if (sugerido > 0) {
                sugerido = redondearArriba(sugerido, reglas.redondeo);
            }

            document.getElementById(`sugerido_${medId}`).value = Math.round(sugerido);
        }

        function guardarSugeridoManual(medId) {
            // Permitir edici√≥n manual sin sobrescribir
        }

        function toggleEscaso(medId) {
            const btn = document.getElementById(`btn_escaso_${medId}`);
            if (btn.classList.contains('normal')) {
                btn.classList.replace('normal', 'escaso');
                btn.textContent = 'Escaso';
            } else {
                btn.classList.replace('escaso', 'normal');
                btn.textContent = 'Normal';
            }
            calcularSugerido(medId);
        }

        // === RESTO DE FUNCIONES ===
        function crearFabricante(medId) {
            const nombreNuevo = prompt("Ingresa el nombre del nuevo fabricante:");
            if (!nombreNuevo || nombreNuevo.trim() === '') return;

            fetch('/admin/fabricantes/by_name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: nombreNuevo.trim() })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok && data.fabricante) {
                    const select = document.getElementById(`fabricante_${medId}`);
                    const fab = data.fabricante;
                    if (!select.querySelector(`option[value="${fab.id}"]`)) {
                        const option = document.createElement('option');
                        option.value = fab.id;
                        option.textContent = fab.nombre;
                        select.appendChild(option);
                    }
                    select.value = fab.id;
                    alert('‚úÖ Fabricante listo: ' + fab.nombre);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'No se pudo procesar la solicitud'));
                }
            })
            .catch(err => {
                alert('‚ùå Error de red: ' + err.message);
            });
        }

        function limpiarNombreMedicamento(nombre) {
            const presentaciones = [
                'tableta', 'tablet', 'capsula', 'c√°psula', 'jarabe', 'soluci√≥n',
                'inyecci√≥n', 'inyeccion', 'spray', 'crema', 'ung√ºento', 'polvo',
                'gotas', 'gota', 'comprimido', 'c√°psula', 'ampolla', 'vial',
                'suspensi√≥n', 'emulsi√≥n', 'loci√≥n', 'pasta', 'pomada', 'gel'
            ];
            let resultado = nombre;
            resultado = resultado.replace(/\b(caja|display|blister|tubo|frasco)\s+[x|por]\s*\d+\b/gi, '');
            resultado = resultado.replace(/\bx\s*\d+\b/gi, '');
            resultado = resultado.replace(/\bpor\s*\d+\b/gi, '');
            let resultadoLower = resultado.toLowerCase();
            for (let palabra of presentaciones) {
                const index = resultadoLower.indexOf(palabra);
                if (index !== -1) {
                    resultado = resultado.substring(0, index).trim();
                    resultadoLower = resultado.toLowerCase();
                    break;
                }
            }
            resultado = resultado.replace(/\s+/g, ' ').trim();
            return resultado || nombre;
        }

        function buscarEnFarmacia(nombreFarmacia, medId, compId) {
            const inputActivo = document.querySelector(
                `.precio-competidor[data-med-id="${medId}"][data-comp-id="${compId}"]`
            );
            const nombre = document.getElementById(`nombre_${medId}`).value;
            const medLimpio = limpiarNombreMedicamento(nombre);
            const medEncodificado = encodeURIComponent(medLimpio);
            let url;
            if (nombreFarmacia === 'Cruz Verde') {
                url = `https://www.cruzverde.com.co/search?query=${medEncodificado}`;
            } else if (nombreFarmacia === 'Farmatodo') {
                url = `https://www.farmatodo.com.co/buscar?product=${medEncodificado}&departamento=Todos&filtros=`;
            } else if (nombreFarmacia === 'Locatel') {
                url = `https://www.locatelcolombia.com/search?q=${medEncodificado}`;
            } else if (nombreFarmacia === 'La Rebaja') {
                url = `https://www.larebajavirtual.com/search?query=${medEncodificado}`;
            }
            window.open(url, '_blank');
            window.addEventListener('focus', () => {
                if (inputActivo) {
                    setTimeout(() => {
                        inputActivo.focus();
                        navigator.clipboard.readText().then(texto => {
                            const limpio = texto.trim();
                            if (!limpio) return;
                            const soloDigitos = limpio.replace(/[.,]/g, '');
                            const esNumero = /^\d+[.,]?\d*$/.test(limpio) || /^\d+$/.test(limpio);
                            if (esNumero && soloDigitos !== '') {
                                inputActivo.value = soloDigitos;
                                calcularSugerido(inputActivo.dataset.medId);
                            }
                        }).catch(() => {});
                    }, 100);
                }
            }, { once: true });
        }

        function actualizarNombre(medId) {
            const input = document.getElementById(`nombre_${medId}`);
            const nombreOriginal = document.querySelector(`[data-med-id="${medId}"]`).dataset.nombreOriginal;
            const nuevoNombre = input.value.trim();
            if (nuevoNombre === nombreOriginal) return;
            const formData = new FormData();
            formData.append('accion', 'actualizar_nombre');
            formData.append('medicamento_id', medId);
            formData.append('nuevo_nombre', nuevoNombre);
            fetch('/admin/actualizar_precios', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    document.getElementById(`guardado_nombre_${medId}`).innerHTML = '‚úÖ NOMBRE ACTUALIZADO!';
                    setTimeout(() => { document.getElementById(`guardado_nombre_${medId}`).innerHTML = ''; }, 3000);
                    document.querySelector(`[data-med-id="${medId}"]`).dataset.nombreOriginal = nuevoNombre;
                }
            });
        }

        function guardarPrecios(medId, precioId) {
            const fabricanteId = document.getElementById(`fabricante_${medId}`).value;
            if (!fabricanteId) {
                alert('Selecciona un fabricante');
                return;
            }
            
            const precios = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
            const valores = Array.from(precios)
                .map(input => parseFloat(input.value) || 0)
                .filter(val => val > 0);

            const precioSugeridoInput = document.getElementById(`sugerido_${medId}`);
            const precioSugerido = parseFloat(precioSugeridoInput.value) || 0;

            if (precioSugerido <= 0) {
                alert('Ingresa precios v√°lidos de las farmacias');
                return;
            }
            
            const esEscaso = document.getElementById(`btn_escaso_${medId}`).classList.contains('escaso');
            const usarMinimo = esEscaso || valores.length === 1;
            
            let advertencia = false;
            let mensaje = "";
            
            if (valores.length > 0) {
                if (usarMinimo) {
                    const minCompetencia = Math.min(...valores);
                    if (precioSugerido < minCompetencia) {
                        advertencia = true;
                        mensaje = `Tu precio ($${precioSugerido}) est√° DEBAJO del √∫nico precio de competencia ($${minCompetencia})`;
                    }
                } else {
                    const maxCompetencia = Math.max(...valores);
                    if (precioSugerido > maxCompetencia) {
                        advertencia = true;
                        mensaje = `Tu precio ($${precioSugerido}) est√° ARRIBA del m√°ximo de competencia ($${maxCompetencia})`;
                    }
                }
            }

            if (advertencia) {
                const confirmar = confirm(`‚ö†Ô∏è ADVERTENCIA\n\n${mensaje}\n\n¬øDeseas continuar?`);
                if (!confirmar) return;
            }

            fetch('/admin/precios/guardar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: precioId || null,
                    medicamento_id: medId,
                    fabricante_id: fabricanteId,
                    precio: precioSugerido
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    if (!precioId && data.precio_id) {
                        const card = document.querySelector(`[data-med-id="${medId}"]`);
                        card.dataset.precioId = data.precio_id;
                        const contenedorImg = document.getElementById(`imagen-contenedor_${medId}`);
                        if (contenedorImg) {
                            contenedorImg.dataset.precioId = data.precio_id;
                        }
                    }
                    const aviso = document.getElementById(`guardado_precio_${medId}`);
                    aviso.textContent = '‚úÖ Guardado';
                    
                    const elementos = [
                        ...document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`),
                        document.getElementById(`sugerido_${medId}`),
                        document.getElementById(`fabricante_${medId}`)
                    ];
                    const handler = () => {
                        aviso.textContent = '';
                        elementos.forEach(el => {
                            el.removeEventListener('input', handler);
                            el.removeEventListener('change', handler);
                        });
                    };
                    elementos.forEach(el => {
                        el.addEventListener('input', handler);
                        el.addEventListener('change', handler);
                    });
                } else {
                    alert('‚ùå Error: ' + (data.error || 'desconocido'));
                }
            })
            .catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        }

        function agregarFabricante(medId) {
            const precios = document.querySelectorAll(`.precio-competidor[data-med-id="${medId}"]`);
            precios.forEach(input => input.value = '');
            document.getElementById(`sugerido_${medId}`).value = '';
            document.getElementById(`fabricante_${medId}`).selectedIndex = 0;
            const card = document.querySelector(`[data-med-id="${medId}"]`);
            card.dataset.precioId = '';
            const contenedorImg = document.getElementById(`imagen-contenedor_${medId}`);
            if (contenedorImg) {
                contenedorImg.dataset.precioId = '';
                const img = contenedorImg.querySelector('img');
                img.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'><rect fill='%23f0f0f0' width='150' height='150'/><text x='50%' y='50%' fill='%23999' font-size='14' text-anchor='middle' dominant-baseline='middle'>+</text></svg>";
            }
            card.scrollIntoView({ behavior: 'smooth' });
        }

        // === ‚ú® FUNCI√ìN CORREGIDA: PROCESAR IMAGEN DESDE BLOB ===
        async function procesarImagenDesdeBlob(blob, precioId, contenedor) {
            const formData = new FormData();
            formData.append('imagen', blob, 'imagen.jpg');

            contenedor.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#e8f5e9;">‚è≥</div>';

            try {
                const res = await fetch(`/admin/precios/${precioId}/imagen`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.ok && data.imagen) {
                    // ‚úÖ Obtener medId directamente del contenedor (evita el error de "medId is not defined")
                    const medId = contenedor.dataset.medId || '';
                    contenedor.innerHTML = `
                        <img id="imagen_${medId}"
                            src="/static/uploads/${data.imagen}?t=${Date.now()}"
                            alt="Imagen producto"
                            style="cursor: pointer;">
                    `;
                    alert('‚úÖ Imagen guardada autom√°ticamente desde portapapeles');
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (err) {
                console.error('Error en procesarImagenDesdeBlob:', err);
                alert('‚ùå Error guardando imagen');
                // Restaurar placeholder
                contenedor.innerHTML = `<img src="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'><rect fill='%23f0f0f0' width='150' height='150'/><text x='50%' y='50%' fill='%23999' font-size='14' text-anchor='middle' dominant-baseline='middle'>+</text></svg>" style="cursor: pointer;">`;
            }
        }

        // ü™Ñ Listener m√°gico de clic en imagen
        document.addEventListener('click', async function(e) {
            const contenedor = e.target.closest('.imagen-preview');
            if (!contenedor) return;

            const precioId = contenedor.dataset.precioId;
            const medId = contenedor.dataset.medId;

            if (!precioId) {
                alert("‚ö†Ô∏è Primero guarda el precio, luego podr√°s pegar la imagen");
                return;
            }

            // ‚ú® Intentar leer del portapapeles autom√°ticamente
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            await procesarImagenDesdeBlob(blob, precioId, contenedor);
                            return;
                        }
                    }
                }
                // Si no hay imagen, activar modo pegado (fallback)
                contenedor.classList.add('imagen-activa');
                setTimeout(() => {
                    contenedor.classList.remove('imagen-activa');
                }, 30000);
            } catch (err) {
                console.warn('No se pudo acceder al portapapeles. Activando modo pegado manual.');
                contenedor.classList.add('imagen-activa');
                setTimeout(() => {
                    contenedor.classList.remove('imagen-activa');
                }, 30000);
            }
        });

        // Listener de pegado manual (fallback)
        document.addEventListener('paste', function(e) {
            const contenedorActivo = document.querySelector('.imagen-preview.imagen-activa');
            if (!contenedorActivo) return;

            const precioId = contenedorActivo.dataset.precioId;
            const items = e.clipboardData?.items;
            if (!items) return;

            for (let item of items) {
                if (item.type.indexOf('image') === -1) continue;

                e.preventDefault();
                const blob = item.getAsFile();
                if (blob && precioId) {
                    procesarImagenDesdeBlob(blob, precioId, contenedorActivo);
                }
                break;
            }
            contenedorActivo.classList.remove('imagen-activa');
        });

        function eliminarMedicamento(medId) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar este medicamento y todos sus datos asociados?')) return;
            
            fetch(`/medicamentos/eliminar/${medId}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    alert('‚úÖ ' + data.mensaje);
                    location.reload();
                } else {
                    alert('‚ùå ' + data.error);
                }
            })
            .catch(err => {
                alert('‚ùå Error: ' + err.message);
            });
        }
    </script>
</body>
</html>

