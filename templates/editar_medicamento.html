<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‚úèÔ∏è Editar Medicamento</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; }
.paste-zone {
border: 2px dashed #cbd5e1;
transition: all 0.3s ease;
padding: 20px;
border-radius: 8px;
background-color: #f8fafc;
}
.paste-zone.active {
border-color: #4f46e5;
background-color: #eef2ff;
}
/* üÜï BOT√ìN FLOTANTE */
.boton-flotante-guardar {
position: fixed;
top: 20px;
right: 20px;
z-index: 1000;
padding: 12px 20px;
background: #4f46e5;
color: white;
border: none;
border-radius: 8px;
font-weight: bold;
cursor: pointer;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
transition: all 0.3s ease;
display: none;
}
.boton-flotante-guardar:hover {
background: #4338ca;
box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
transform: translateY(-2px);
}
.boton-flotante-guardar.visible {
display: flex;
align-items: center;
gap: 8px;
}
/* Mostrar cuando haya cambios */
@media (max-width: 768px) {
.boton-flotante-guardar {
padding: 10px 16px;
font-size: 14px;
}
}


/* üÜï ANIMACI√ìN DE PARPADEO */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.boton-siguiente-visible {
    display: block !important;
    animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite !important;
}


/* üÜï ZOOM IMAGEN PRECIOS */
.imagen-preview img {
    transition: transform 0.2s ease;
    cursor: zoom-in;
}

.imagen-preview img:hover {
    transform: scale(3.5);
    position: relative;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}


</style>
</head>
<body class="p-4 sm:p-8 bg-gray-100">
<!-- üî¥ BANNER FLOTANTE - Estado de guardado -->
<div id="estado-guardado" class="hidden fixed top-0 left-0 right-0 bg-yellow-100 border-l-4 border-yellow-600 text-yellow-800 p-4 z-50 shadow-lg">
<div class="container mx-auto flex items-center justify-between">
<div class="flex items-center">
<i class="fas fa-exclamation-circle mr-2"></i>
<span class="font-semibold">
{% if es_nuevo %}
‚ö†Ô∏è Medicamento NO CREADO - Haz clic en "Crear Medicamento" para guardar
{% else %}
‚ö†Ô∏è CAMBIOS SIN GUARDAR - Haz clic en "Guardar Cambios" para confirmar
{% endif %}
</span>
</div>
<button type="button" onclick="document.getElementById('estado-guardado').classList.add('hidden')" class="text-yellow-600 hover:text-yellow-800">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<main class="container mx-auto max-w-lg bg-white p-6 rounded-xl shadow-2xl mt-10">
<h1 class="text-3xl font-extrabold text-center text-indigo-700 mb-6 border-b pb-4">
{% if es_nuevo %}
‚ú® Crear Nuevo Medicamento
{% else %}
‚úèÔ∏è Editar: {{ medicamento.nombre }}
{% endif %}
</h1>


<!-- üÜï INDICADOR DE COMPLETITUD (LLENADOR) -->
<div id="indicador-completitud" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <p class="text-sm font-semibold text-blue-800 mb-2">
        <i class="fas fa-tasks mr-2"></i> Datos m√≠nimos requeridos:
    </p>
    <div class="flex gap-2 flex-wrap">
        <span id="badge-sintoma" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
            <i class="fas fa-times-circle mr-1"></i> 1 S√≠ntoma
        </span>
        <span id="badge-precio" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
            <i class="fas fa-times-circle mr-1"></i> Precio + Fabricante
        </span>
        <span id="badge-imagen" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
            <i class="fas fa-times-circle mr-1"></i> Imagen
        </span>
    </div>
</div>


<!-- üîç DEBUG: Ver si llegan los datos -->
{% if medicamento.laboratorio_sugerido %}
<div class="p-3 bg-blue-100 text-blue-700 rounded mb-4 text-sm">
‚ÑπÔ∏è <strong>Laboratorio sugerido:</strong> {{ medicamento.laboratorio_sugerido }}
</div>
{% endif %}
<!-- Mensajes flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="space-y-3 mb-4">
{% for category, message in messages %}
<div class="p-3 text-sm rounded-lg
{% if category == 'success' %} bg-green-100 text-green-700 {% elif category == 'danger' or category == 'error' %} bg-red-100 text-red-700 {% else %} bg-blue-100 text-blue-700 {% endif %}">
{{ message }}
</div>
{% endfor %}
</div>
{% endif %}
{% endwith %}
<form action="{% if es_nuevo %}/admin/medicamentos/editar/nuevo{% else %}{{ url_for('editar_medicamento_admin', medicamento_id=medicamento.id) }}{% endif %}"
method="POST" enctype="multipart/form-data" class="space-y-4">
<input type="hidden" name="stock_actual" value="{{ medicamento.stock_actual | default(0) }}">
<!-- Nombre Comercial -->
<div>
<label for="nombre" class="block text-sm font-medium text-gray-700">Nombre Comercial</label>
<input type="text" id="nombre" name="nombre" value="{{ medicamento.nombre }}" required
class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
</div>
<!-- üÜï COMPONENTE ACTIVO -->
<div>
<label for="componente_activo_id" class="block text-sm font-medium text-gray-700">Componente Activo</label>
<!-- ‚ö†Ô∏è Advertencia si es componente activo de otros -->
<div id="advertencia-componente" class="hidden mb-3 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
<p class="font-semibold mb-2">‚ö†Ô∏è No se puede asignar componente activo</p>
<p class="text-sm mb-2">Este medicamento es componente activo de:</p>
<ul id="lista-medicamentos-que-lo-usan" class="ml-4 text-sm list-disc"></ul>
</div>

<!-- Campo combinado para seleccionar o crear componente activo -->
<div class="mt-3">
  <label for="input-componente-activo" class="block text-sm font-medium text-gray-700">Buscar o crear componente activo</label>
  
  <input id="input-componente-activo"
         type="text"
         placeholder="Escribe o busca componente activo"
         class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">

  <button id="btn-crear-rapido"
          type="button"
          class="hidden mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 px-3 rounded-lg shadow-sm">
    ‚ûï Crear nuevo medicamento con este nombre y asociar a este como componente activo
  </button>

  <p id="msg-crear-rapido" class="hidden mt-2 text-green-600 text-sm font-medium"></p>
</div>


<!-- Campo oculto con el componente_activo_id actual -->
<input type="hidden" id="componente_activo_id_actual" value="{{ medicamento.componente_activo_id or '' }}">
<!-- Dropdown de componentes activos -->
<select id="componente_activo_id" name="componente_activo_id"
class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
<option value="">-- Seleccionar componente activo --</option>
</select>
<!-- üÜï BOT√ìN BUSCAR EN GOOGLE -->
<button type="button" id="btn-buscar-componente-google"
class="mt-2 w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
<i class="fas fa-google mr-2"></i> üîç Buscar componente activo en Google
</button>
</div>
<!-- üí∞ Bloque de precios sugeridos -->
<div id="precio-info" class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 text-sm text-gray-700 hidden">
<div class="flex items-center mb-2">
<i class="fas fa-tags text-indigo-500 mr-2"></i>
<span class="font-semibold text-indigo-700">Precios detectados en l√≠nea</span>
</div>
<ul id="lista-precios" class="list-disc ml-6 text-gray-800"></ul>
<p id="precio-promedio" class="mt-2 font-bold text-indigo-700"></p>
</div>
<div id="precio-cargando" class="hidden text-sm text-gray-500 italic mb-2">
<i class="fas fa-spinner fa-spin mr-1"></i> Buscando precios en l√≠nea...
</div>
<div id="precio-error" class="hidden text-sm text-red-600 italic mb-2"></div>
<!-- BLOQUE DE EDICI√ìN DE PRECIOS -->
<div id="precios-container" class="mb-4">
<h3 class="font-semibold mb-2">Precios por fabricante</h3>
<table border="1" width="100%" id="tabla-precios" class="text-sm border-collapse" style="table-layout: fixed;">
  <thead>
    <tr class="bg-gray-100">
      <th class="p-0" style="width: 80px">Imagen</th>
      <th class="p-0" style="width: 200px">Fabricante</th>
      <th class="p-0" style="width: 90px">Precio</th>
      <th class="p-0" style="width: 90px">Fecha</th>
    </tr>
  </thead>
  <tbody id="tbody-precios"></tbody>
</table>
<button id="btn-nuevo-precio" type="button"
{% if es_nuevo %}
disabled
style="background: #180d0d; color: #a31e1e; cursor: not-allowed;"
title="Crea el medicamento primero"
{% else %}
class="mt-2 px-4 py-2 bg-green-500 hover:bg-green-500 text-white rounded shadow text-sm font-semibold">
{% endif %}
Nuevo Precio y Fabricante
</button>
</div>
<!-- INDICACIONES - S√çNTOMAS - AFECCIONES Y M√ÅS -->
<div class="border-t pt-4 mt-4">
<h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
<i class="fas fa-stethoscope mr-2 text-red-500"></i> Indicaciones - s√≠ntomas - afecciones y m√°s que trata este medicamento
</h2>
<!-- Bot√≥n para buscar indicaciones autom√°ticamente -->
<button type="button" id="buscar-sintomas-online"
class="mb-4 w-full flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
<i class="fas fa-search mr-2"></i> üîç Buscar Indicaciones en L√≠nea
</button>

<!-- üÜï PANEL PARA VER B√öSQUEDA EN GOOGLE -->
<div id="panel-google-search" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
  <p class="text-sm font-semibold text-blue-800 mb-2">
    <i class="fas fa-search mr-2"></i> B√∫squeda en Google: <span id="titulo-busqueda"></span>
  </p>
  <div id="contenedor-resultados" class="bg-white border border-blue-100 rounded p-3 max-h-64 overflow-y-auto text-sm text-gray-700">
    Cargando resultados...
  </div>
</div>

<!-- √Årea de sugerencias -->
<div id="sintomas-sugeridos" class="hidden mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
<div class="flex items-center mb-3">
<i class="fas fa-lightbulb text-purple-600 mr-2"></i>
<span class="font-semibold text-purple-700">Indicaciones sugeridas encontradas en l√≠nea:</span>
</div>
<div id="lista-sintomas-sugeridos" class="space-y-2"></div>
<p class="text-xs text-gray-500 mt-2">Haz clic en las indicaciones para agregarlas</p>
</div>
<div id="sintomas-buscando" class="hidden text-sm text-gray-500 italic mb-3">
<i class="fas fa-spinner fa-spin mr-1"></i> Buscando indicaciones en l√≠nea...
</div>
<!-- Buscador manual -->
<div class="mb-3">
<label for="buscar-sintoma" class="block text-sm font-medium text-gray-700 mb-1">
Buscar indicaci√≥n manualmente
</label>
<input
type="text"
id="buscar-sintoma"
placeholder="Escribe: enfermedad, s√≠ntoma, infecci√≥n, afecci√≥n..."
class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
>
</div>

<!-- BOT√ìN CREAR INDICACI√ìN NUEVA -->
<button type="button" id="btn-crear-indicacion-manual"
  class="mb-4 w-full flex items-center justify-center bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
  <i class="fas fa-plus-circle mr-2"></i> ‚ûï Crear Indicaci√≥n Nueva
</button>

<!-- Indicaciones seleccionadas -->
<div id="sintomas-seleccionados" class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg min-h-[60px]">
<p class="text-xs font-semibold text-green-700 mb-2">
<i class="fas fa-check-circle mr-1"></i> Indicaciones seleccionadas (clic para remover):
</p>
<div id="lista-sintomas-seleccionados" class="flex flex-wrap gap-2">
<p class="text-sm text-gray-500 italic">Cargando...</p>
</div>
</div>
<!-- Lista disponible -->
<div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
<div id="lista-sintomas" class="space-y-1">
<p class="text-sm text-gray-500 italic p-2">Cargando indicaciones...</p>
</div>
</div>
<p class="text-xs text-gray-500 mt-2">
<i class="fas fa-info-circle mr-1"></i> Los cambios se guardan autom√°ticamente
</p>
</div>
<!-- Presentaci√≥n -->
<div>
<label for="presentacion" class="block text-sm font-medium text-gray-700">Presentaci√≥n (Opcional)</label>
<input type="text" id="presentacion" name="presentacion" value="{{ medicamento.presentacion }}"
class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
</div>
<!-- Concentraci√≥n -->
<div>
<label for="concentracion" class="block text-sm font-medium text-gray-700">Concentraci√≥n (Opcional)</label>
<input type="text" id="concentracion" name="concentracion" value="{{ medicamento.concentracion }}"
class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
</div>
<!-- Estado Activo -->
<div>
<label class="flex items-center space-x-3 cursor-pointer">
<input type="checkbox" id="activo" name="activo" value="1"
{% if es_nuevo or medicamento.activo == '1' %}checked{% endif %}
class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
<span class="text-sm font-medium text-gray-700">
<i class="fas fa-eye mr-2"></i>Medicamento Activo (Visible en tienda)
</span>
</label>
<p class="text-xs text-gray-500 mt-1 ml-8">Desmarca para ocultar este medicamento de la tienda sin eliminarlo</p>
</div>
<!-- C√≥digo ATC -->
<div>
<label for="codigo_atc_puro" class="block text-sm font-medium text-gray-700">C√≥digo ATC (Opcional)</label>
<input type="text" id="codigo_atc_puro" name="codigo_atc_puro" value="{{ medicamento.codigo_atc_puro | default('') }}"
class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border uppercase">
<input type="hidden" name="descripcion_tecnica_atc" value="{{ medicamento.descripcion_tecnica_atc | default('') }}">
<p class="text-xs text-gray-500 mt-1">Si lo tiene, el c√≥digo ATC.</p>
</div>
<!-- Gesti√≥n de Imagen -->
<div class="border-t pt-4 mt-4">
<h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
<i class="fas fa-camera mr-2"></i> Gesti√≥n de Imagen
</h2>
<p class="text-sm text-gray-600 mb-2">Imagen actual:</p>
<div class="relative inline-block mb-3">
{% if medicamento.imagen %}
<img id="imagen-actual" src="{{ url_for('static', filename='uploads/' + medicamento.imagen) }}"
alt="Imagen actual" onerror="this.onerror=null;this.src='https://placehold.co/192x192/f3f4f6/4b5563?text=Error';"
class="w-48 h-48 object-cover rounded-lg border-2 border-indigo-300 shadow-md">
<button type="button" id="btn-eliminar-imagen"
class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg transition duration-200">
<i class="fas fa-trash-alt text-sm"></i>
</button>
{% else %}
<img id="imagen-actual" src="https://placehold.co/192x192/f3f4f6/4b5563?text=Sin+Imagen"
alt="Imagen actual"
class="w-48 h-48 object-cover rounded-lg border-2 border-indigo-300 shadow-md">
<button type="button" id="btn-eliminar-imagen"
class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg hidden transition duration-200">
<i class="fas fa-trash-alt text-sm"></i>
</button>
{% endif %}
</div>
<!-- Buscar Imagen -->
<button type="button" id="search-button"
class="mb-4 w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
<i class="fab fa-google mr-2"></i> Buscar Imagen en Google para el medicamento
</button>
<!-- Zona de Pegado -->
<div id="paste-zone" class="paste-zone mb-4 text-center cursor-pointer hover:border-indigo-400">
<p class="text-sm text-gray-700 font-medium">
<i class="fas fa-paste mr-2"></i> Pega una imagen aqu√≠ (Ctrl+V)
</p>
<p class="text-xs text-gray-500 mt-1">O arrastra una imagen desde tu computadora</p>
</div>
<label for="imagen" class="block text-sm font-medium text-gray-700 mt-4">O selecciona desde archivo</label>
<input type="file" id="imagen" name="imagen" accept="image/*"
class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
<p class="text-xs text-gray-500 mt-1">Archivos permitidos: PNG, JPG, GIF.</p>
<div id="file-info" class="mt-2 p-2 bg-indigo-50 rounded border border-indigo-200 hidden">
<p class="text-xs text-indigo-700">
<i class="fas fa-check-circle mr-1"></i>
Archivo a guardar como: <strong id="filename-preview">medicamento.jpg</strong>
</p>
</div>
</div>
<!-- üÜï BOT√ìN FLOTANTE GUARDAR -->
<button type="submit" id="boton-flotante" class="boton-flotante-guardar">
<i class="fas fa-save"></i>
<span id="texto-boton-flotante">Guardar Cambios</span>
</button>


<!-- üÜï BOT√ìN SIGUIENTE MEDICAMENTO (PARPADEANTE) -->
<button type="button" id="btn-siguiente-medicamento" class="hidden w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 animate-pulse" style="animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
    <i class="fas fa-arrow-right mr-2"></i> ‚û°Ô∏è Siguiente Medicamento
</button>


<button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
{% if es_nuevo %}
<i class="fas fa-plus-circle mr-2"></i> Crear Medicamento
{% else %}
<i class="fas fa-save mr-2"></i> Guardar Cambios
{% endif %}
</button>
</form>
<a href="{{ url_for('lista_medicamentos') }}" class="w-full block text-center mt-6 text-sm text-gray-600 hover:text-indigo-700 font-semibold transition duration-150">
<i class="fas fa-arrow-left mr-1"></i> Cancelar y Volver a la Lista
</a>
</main>
<!-- ================================================
√öNICO SCRIPT CON TODO FUSIONADO
================================================ -->




// ================================================
<script>
const medicamentoId = {{ medicamento.id if medicamento.id else 'null' }};
const medicamentoNombre = "{{ medicamento.nombre }}";
console.log('medicamentoId:', medicamentoId);
console.log('medicamentoNombre:', medicamentoNombre);
function mostrarMensaje(texto, tipo) {
const div = document.createElement('div');
div.className = tipo === 'success' ?
'p-4 mb-4 bg-green-100 text-green-800 rounded-lg border border-green-300 font-bold text-center text-lg' :
'p-4 mb-4 bg-red-100 text-red-800 rounded-lg border border-red-300 font-bold text-center text-lg';
div.textContent = texto;
document.querySelector('main').insertBefore(div, document.querySelector('main').firstChild);
setTimeout(() => div.remove(), 5000);
}
// ================================================
// GESTOR DE INDICACIONES (antiguamente S√çNTOMAS)
// ================================================
let todosLosSintomas = [];
let sintomasSeleccionados = new Set();
let sintomasSugeridos = [];
async function inicializarSintomas() {
try {
const respSintomas = await fetch('/admin/sintomas/json');
const dataSintomas = await respSintomas.json();
if (dataSintomas.ok) {
todosLosSintomas = dataSintomas.sintomas;
}
const respAsociados = await fetch(`/admin/medicamentos/${medicamentoId}/sintomas`);
const dataAsociados = await respAsociados.json();
if (dataAsociados.ok) {
dataAsociados.sintomas.forEach(s => {
sintomasSeleccionados.add(s.sintoma_id);
});
}
renderizarListaSintomas();
actualizarSintomasSeleccionados();
} catch (error) {
console.error('Error inicializando indicaciones:', error);
document.getElementById('lista-sintomas').innerHTML =
'<p class="text-sm text-red-600 p-2">Error cargando indicaciones</p>';
}
}
function renderizarListaSintomas(filtro = '') {
const lista = document.getElementById('lista-sintomas');
lista.innerHTML = '';
const sintomasFiltrados = todosLosSintomas.filter(s => {
if (!filtro) return true;
const textoCompleto = `${s.nombre} ${s.sinonimos}`.toLowerCase();
return textoCompleto.includes(filtro.toLowerCase());
});
if (sintomasFiltrados.length === 0) {
lista.innerHTML = '<p class="text-sm text-gray-500 italic p-2">No se encontraron indicaciones</p>';
return;
}
sintomasFiltrados.forEach(sintoma => {
const div = document.createElement('div');
const estaSeleccionado = sintomasSeleccionados.has(sintoma.id);
const estaSugerido = sintomasSugeridos.some(s => s.id === sintoma.id);
let claseExtra = '';
if (estaSeleccionado) {
claseExtra = 'bg-green-100 border-l-4 border-green-500 text-green-800 font-semibold';
} else if (estaSugerido) {
claseExtra = 'bg-purple-50 border-l-4 border-purple-400';
}
div.className = `p-2 rounded cursor-pointer transition-colors hover:bg-gray-100 ${claseExtra} border-l-4 ${!claseExtra && 'border-transparent'}`;
div.innerHTML = `
<div class="flex items-center justify-between">
<div class="flex-1">
<span class="text-sm font-medium">${sintoma.nombre}</span>
<span class="text-xs text-gray-500 ml-2">(${sintoma.sinonimos})</span>
${estaSugerido && !estaSeleccionado ? '<span class="ml-2 text-xs bg-purple-500 text-white px-2 py-0.5 rounded">Sugerido</span>' : ''}
</div>
<i class="fas ${estaSeleccionado ? 'fa-check-circle text-green-600' : 'fa-plus-circle text-gray-400'}"></i>
</div>
`;
div.addEventListener('click', () => toggleSintoma(sintoma.id));
lista.appendChild(div);
});
}
let guardandoSintomas = false;
let ultimoToggleTime = 0;
async function toggleSintoma(sintomaId) {
const ahora = Date.now();
if (ahora - ultimoToggleTime < 800) {
console.log('‚è≥ Clic muy r√°pido, ignorando...');
return;
}
ultimoToggleTime = ahora;
if (guardandoSintomas) {
console.log('‚è≥ Guardado en proceso, ignorando clic...');
return;
}
guardandoSintomas = true;
console.log(`üîÑ Toggle indicaci√≥n ${sintomaId}`);
if (sintomasSeleccionados.has(sintomaId)) {
sintomasSeleccionados.delete(sintomaId);
console.log(`‚ûñ Eliminada indicaci√≥n ${sintomaId}`);
} else {
sintomasSeleccionados.add(sintomaId);
console.log(`‚ûï Agregada indicaci√≥n ${sintomaId}`);
}
actualizarSintomasSeleccionados();
renderizarListaSintomas(document.getElementById('buscar-sintoma').value);
await guardarSintomas();
actualizarIndicadorCompletitud(); // üÜï Actualizar indicador en tiempo real
setTimeout(() => {
guardandoSintomas = false;
console.log('‚úÖ Listo para nuevo clic');
}, 800);
}
function actualizarSintomasSeleccionados() {
const contenedor = document.getElementById('lista-sintomas-seleccionados');
contenedor.innerHTML = '';
if (sintomasSeleccionados.size === 0) {
contenedor.innerHTML = '<p class="text-sm text-gray-500 italic">Ninguna indicaci√≥n seleccionada</p>';
return;
}
sintomasSeleccionados.forEach(id => {
const sintoma = todosLosSintomas.find(s => s.id === id);
if (!sintoma) return;
const badge = document.createElement('span');
badge.className = 'inline-flex items-center gap-1 px-3 py-1 bg-green-500 text-white text-sm rounded-full cursor-pointer hover:bg-green-600 transition-colors';
badge.innerHTML = `${sintoma.nombre} <i class="fas fa-times-circle"></i>`;
badge.addEventListener('click', () => toggleSintoma(id));
contenedor.appendChild(badge);
});
}
async function guardarSintomas() {
    try {
        const sintomasArray = Array.from(sintomasSeleccionados);
        console.log(`üíæ Guardando ${sintomasArray.length} indicaciones...`);
        
        const maxReintentos = 3;
        let intento = 0;
        
        while (intento < maxReintentos) {
            intento++;
            
            try {
                const resp = await fetch(`/admin/medicamentos/${medicamentoId}/sintomas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sintomas: sintomasArray})
                });
                
                const data = await resp.json();
                
                if (data.ok) {
                    console.log('‚úÖ Indicaciones guardadas correctamente en intento', intento);
                    return; // ‚úÖ √âXITO
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (error) {
                console.error(`‚ö†Ô∏è Error intento ${intento}:`, error.message);
                
                if (intento < maxReintentos) {
                    const espera = intento * 800;
                    console.log(`‚è≥ Reintentando en ${espera}ms...`);
                    await new Promise(resolve => setTimeout(resolve, espera));
                } else {
                    throw error;
                }
            }
        }
    } catch (error) {
        console.error('‚ùå Error guardando indicaciones:', error);
        alert('‚ùå Error guardando indicaciones. Intenta de nuevo.');
    }
}

async function mostrarResultadosGoogle(nombre_medicamento) {
    const panel = document.getElementById('panel-google-search');
    const titulo = document.getElementById('titulo-busqueda');
    const contenedor = document.getElementById('contenedor-resultados');
    
    // üÜï LIMPIAR NOMBRE (M√ÅS SUAVE)
    nombre_medicamento = nombre_medicamento.toLowerCase();
    nombre_medicamento = nombre_medicamento.replace(/\s+(inyecci√≥n|inyeccion|comprimido|c√°psula|capsula|ampolla|jarabe|crema|gel|polvo|spray|parche|paquete|pack|caja|frasco|botella).*/gi, '');
    nombre_medicamento = nombre_medicamento.replace(/\s+\d+\s*(mg|ml|g|gr|%|ui).*/gi, '');
    nombre_medicamento = nombre_medicamento.replace(/\s+/g, ' ').trim();

    titulo.textContent = `"para que sirve ${nombre_medicamento}"`;
    contenedor.textContent = 'Buscando en Google...';
    panel.classList.remove('hidden');
    
    try {
        const query = `para que sirve ${nombre_medicamento}`;
        const url = `https://www.googleapis.com/customsearch/v1?key=AIzaSyCiAtNFl95bJJFuqiNsiYynBS3LuDisq9g&cx=40c8305664a9147e9&q=${encodeURIComponent(query)}&num=5`;
        
        const resp = await fetch(url);
        const data = await resp.json();
        
        if (data.items) {
            let html = '';
            data.items.forEach((item, idx) => {
                html += `
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                        <a href="${item.link}" target="_blank" style="color: #0066cc; font-weight: bold; text-decoration: none;">
                            ${idx + 1}. ${item.title}
                        </a>
                        <p style="margin: 4px 0; font-size: 12px; color: #006633;">${item.link}</p>
                        <p style="margin: 4px 0; color: #545454;">${item.snippet}</p>
                    </div>
                `;
            });
            contenedor.innerHTML = html;
        } else {
            contenedor.textContent = 'No se encontraron resultados';
        }
    } catch (error) {
        contenedor.textContent = 'Error al buscar en Google';
        console.error(error);
    }
}

// ================================================
// B√öSQUEDA AUTOM√ÅTICA DE INDICACIONES EN L√çNEA
// ================================================
async function buscarSintomasEnLinea() {
const btnBuscar = document.getElementById('buscar-sintomas-online');
const divBuscando = document.getElementById('sintomas-buscando');
const divSugeridos = document.getElementById('sintomas-sugeridos');
const listaSugeridos = document.getElementById('lista-sintomas-sugeridos');
btnBuscar.disabled = true;
btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Buscando...';
divBuscando.classList.remove('hidden');
divSugeridos.classList.add('hidden');
try {
const resp = await fetch(`/admin/buscar_sintomas_medicamento?nombre=${encodeURIComponent(medicamentoNombre)}&medicamento_id=${medicamentoId}`);
const data = await resp.json();
// üÜï Mostrar b√∫squeda en Google
mostrarResultadosGoogle(medicamentoNombre);
divBuscando.classList.add('hidden');


if (data.ok && (data.sintomas_encontrados.length > 0 || data.sintomas_nuevos_sugeridos.length > 0)) {
sintomasSugeridos = data.sintomas_encontrados;
listaSugeridos.innerHTML = '';
if (data.sintomas_encontrados.length > 0) {
const tituloExistentes = document.createElement('h4');
tituloExistentes.className = 'font-bold text-green-700 mb-2 flex items-center';
tituloExistentes.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Indicaciones ya catalogadas:';
listaSugeridos.appendChild(tituloExistentes);
data.sintomas_encontrados.forEach(sintoma => {
const yaSeleccionado = sintomasSeleccionados.has(sintoma.id);
const div = document.createElement('div');
div.className = `p-2 rounded border cursor-pointer transition-colors mb-2 ${yaSeleccionado ? 'bg-green-100 border-green-400' : 'bg-white border-green-300 hover:bg-green-50'}`;
div.innerHTML = `
<div class="flex items-center justify-between">
<div>
<span class="font-medium text-sm">${sintoma.nombre}</span>
<span class="text-xs text-gray-600 ml-2">(${sintoma.motivo})</span>
</div>
<span class="text-xs px-2 py-1 rounded bg-green-500 text-white">
${yaSeleccionado ? '‚úì Ya agregada' : 'Clic para agregar'}
</span>
</div>
`;
if (!yaSeleccionado) {
div.addEventListener('click', () => {
toggleSintoma(sintoma.id);
buscarSintomasEnLinea();
});
}
listaSugeridos.appendChild(div);
});
}
if (data.sintomas_nuevos_sugeridos && data.sintomas_nuevos_sugeridos.length > 0) {
const tituloNuevos = document.createElement('h4');
tituloNuevos.className = 'font-bold text-orange-700 mb-2 mt-4 flex items-center';
tituloNuevos.innerHTML = '<i class="fas fa-lightbulb mr-2"></i>Indicaciones nuevas detectadas:';
listaSugeridos.appendChild(tituloNuevos);
const infoNuevos = document.createElement('p');
infoNuevos.className = 'text-xs text-orange-600 mb-2';
infoNuevos.textContent = 'Estas indicaciones no est√°n en tu cat√°logo. Haz clic para crearlas:';
listaSugeridos.appendChild(infoNuevos);
data.sintomas_nuevos_sugeridos.forEach(sintoma => {
    const div = document.createElement('div');
    div.className = 'p-2 rounded border transition-colors mb-2 bg-orange-50 border-orange-300';
    div.innerHTML = `
    <div class="flex items-center justify-between">
    <div>
    <span class="font-medium text-sm text-orange-900">${sintoma.nombre_sugerido}</span>
    <span class="text-xs bg-orange-200 text-orange-800 px-2 py-0.5 rounded ml-2">NUEVA</span>
    </div>
    <div class="flex gap-2">
    <button type="button" class="btn-buscar-indicacion text-xs px-2 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 transition">
    <i class="fas fa-search mr-1"></i>¬øQu√© es?
    </button>
    <button type="button" class="btn-crear-indicacion text-xs px-2 py-1 rounded bg-orange-500 text-white hover:bg-orange-600 transition">
    <i class="fas fa-plus mr-1"></i>Crear
    </button>
    <button type="button" class="btn-descartar-indicacion text-xs px-2 py-1 rounded bg-red-500 text-white hover:bg-red-600 transition">
    <i class="fas fa-ban mr-1"></i>Descartar
    </button>
    </div>
    </div>
    `;
    
    // Bot√≥n para buscar en Google qu√© es la indicaci√≥n
    div.querySelector('.btn-buscar-indicacion').addEventListener('click', () => {
        const busqueda = `¬øQu√© es ${sintoma.nombre_sugerido}?`;
        window.open(`https://www.google.com/search?q=${encodeURIComponent(busqueda)}`, '_blank');
    });
    
    // Bot√≥n para crear la indicaci√≥n
    div.querySelector('.btn-crear-indicacion').addEventListener('click', () => {
        mostrarModalNuevoSintoma(sintoma.nombre_sugerido, sintoma.descripcion_sugerida);
    });
    
    // Bot√≥n para descartar la indicaci√≥n (NO vuelve a sugerirse)
    div.querySelector('.btn-descartar-indicacion').addEventListener('click', async () => {
        if (confirm(`¬øEst√°s seguro que descartas "${sintoma.nombre_sugerido}"?\n\nNo volver√° a sugerirse en ning√∫n medicamento.`)) {
            try {
                const resp = await fetch('/admin/indicaciones/rechazar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        indicacion_nombre: sintoma.descripcion_sugerida
                    })
                });
                const data = await resp.json();
                if (data.ok) {
                    div.style.opacity = '0.5';
                    div.style.textDecoration = 'line-through';
                    div.querySelector('.btn-descartar-indicacion').disabled = true;
                    alert(`‚úÖ "${sintoma.nombre_sugerido}" descartada`);
                    console.log('‚úÖ Indicaci√≥n descartada:', sintoma.descripcion_sugerida);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error descartando indicaci√≥n');
                console.error(error);
            }
        }
    });
    
    listaSugeridos.appendChild(div);
});
}
divSugeridos.classList.remove('hidden');
renderizarListaSintomas();
} else {
listaSugeridos.innerHTML = '<p class="text-sm text-gray-600">No se encontraron sugerencias. Puedes agregar indicaciones manualmente.</p>';
divSugeridos.classList.remove('hidden');
}
} catch (error) {
divBuscando.classList.add('hidden');
listaSugeridos.innerHTML = '<p class="text-sm text-red-600">Error al buscar indicaciones en l√≠nea.</p>';
divSugeridos.classList.remove('hidden');
console.error('Error:', error);
} finally {
btnBuscar.disabled = false;
btnBuscar.innerHTML = '<i class="fas fa-search mr-2"></i> üîç Buscar Indicaciones en L√≠nea';
}
}
function mostrarModalNuevoSintoma(nombre, descripcion) {
const modal = document.getElementById('modal-nuevo-sintoma');
document.getElementById('modal-nombre-sintoma').value = nombre;
document.getElementById('modal-descripcion-sintoma').value = descripcion || '';
modal.classList.remove('hidden');
}
function cerrarModal() {
document.getElementById('modal-nuevo-sintoma').classList.add('hidden');
}
async function crearYAsociarSintoma() {
    const nombre = document.getElementById('modal-nombre-sintoma').value.trim();
    const descripcion = document.getElementById('modal-descripcion-sintoma').value.trim();
    
    if (!nombre) {
        alert('El nombre de la indicaci√≥n es obligatorio');
        return;
    }
    
    const maxReintentos = 3;
    let intento = 0;
    
    while (intento < maxReintentos) {
        try {
            intento++;
            console.log(`üîÑ Intento ${intento}/${maxReintentos} - Creando indicaci√≥n: ${nombre}`);
            
            const resp = await fetch('/admin/sintomas/crear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nombre: nombre,
                    descripcion: descripcion,
                    medicamento_id: medicamentoId
                })
            });
            
            if (!resp.ok) {
                throw new Error(`Error HTTP ${resp.status}`);
            }
            
            const data = await resp.json();
            
            if (data.ok) {
                console.log('‚úÖ Indicaci√≥n creada en intento', intento);
                todosLosSintomas.push({
                    id: data.sintoma_id,
                    nombre: nombre,
                    sinonimos: descripcion
                });
                todosLosSintomas.sort((a, b) => a.nombre.localeCompare(b.nombre));
                sintomasSeleccionados.add(data.sintoma_id);
                actualizarSintomasSeleccionados();
                renderizarListaSintomas();
                cerrarModal();
                alert(`‚úÖ Indicaci√≥n "${nombre}" creada correctamente`);
                return; // ‚úÖ √âXITO - Salir
            } else {
                // Error del servidor, reintentar
                console.warn(`‚ö†Ô∏è Error en intento ${intento}:`, data.error);
                if (intento < maxReintentos) {
                    const espera = intento * 500; // 500ms, 1000ms, 1500ms
                    console.log(`‚è≥ Esperando ${espera}ms antes de reintentar...`);
                    await new Promise(resolve => setTimeout(resolve, espera));
                } else {
                    throw new Error(data.error || 'Error desconocido en la BD');
                }
            }
        } catch (error) {
            console.error(`‚ùå Error en intento ${intento}:`, error.message);
            
            if (intento < maxReintentos) {
                const espera = intento * 500;
                console.log(`‚è≥ Esperando ${espera}ms antes de reintentar...`);
                await new Promise(resolve => setTimeout(resolve, espera));
            } else {
                alert(`‚ùå Error al crear la indicaci√≥n (${intento} intentos fallidos):\n${error.message}`);
            }
        }
    }
}
// ================================================
// GESTOR DE COMPONENTE ACTIVO
// ================================================
/* async function inicializarComponenteActivo() {
console.log('üîß Inicializando componente activo...');
const componenteActualId = document.getElementById('componente_activo_id_actual').value;
console.log(`üìå Componente activo actual en BD: ${componenteActualId || 'ninguno'}`);
try {
const resp = await fetch(`/admin/medicamentos/componentes_activos/lista?medicamento_id=${medicamentoId}`);
const data = await resp.json();
if (data.ok) {
const select = document.getElementById('componente_activo_id');
data.componentes_activos.forEach(comp => {
const option = document.createElement('option');
option.value = comp.id;
option.textContent = comp.nombre;
select.appendChild(option);
});
console.log(`‚úÖ ${data.componentes_activos.length} componentes cargados`);
if (componenteActualId) {
select.value = componenteActualId;
console.log(`‚úÖ Pre-seleccionado: ${componenteActualId}`);
}
}
} catch (error) {
console.error('‚ùå Error cargando componentes:', error);
}
if (medicamentoId && medicamentoId !== 'null' && medicamentoId !== '') {
try {
const resp = await fetch(`/admin/medicamentos/${medicamentoId}/es_componente_activo`);
const data = await resp.json();
if (data.ok && data.es_componente_activo) {
console.log('‚ö†Ô∏è Este medicamento es componente activo de otros');
document.getElementById('advertencia-componente').classList.remove('hidden');
const lista = document.getElementById('lista-medicamentos-que-lo-usan');
data.medicamentos_que_lo_usan.forEach(med => {
const li = document.createElement('li');
li.textContent = med.nombre;
lista.appendChild(li);
});
document.getElementById('componente_activo_id').disabled = true;
console.log('üîí Dropdown deshabilitado');
} else {
console.log('‚úÖ Este medicamento NO es componente activo de otros');
}
} catch (error) {
console.error('‚ùå Error verificando:', error);
}
}
const inputBuscar = document.getElementById('buscar-componente-activo');
const select = document.getElementById('componente_activo_id');
inputBuscar.addEventListener('input', (e) => {
const filtro = e.target.value.toLowerCase();
Array.from(select.options).forEach(option => {
if (option.value === '') {
option.style.display = 'block';
return;
}
const texto = option.textContent.toLowerCase();
option.style.display = texto.includes(filtro) ? 'block' : 'none';
});
});
}
*/






// ================================================
// HEREDAR S√çNTOMAS DE MEDICAMENTOS HERMANOS
// ================================================

async function cargarYMostrarHermanosComponente(componenteActivoId) {
    if (!medicamentoId || medicamentoId === 'null' || medicamentoId === '') {
        console.log('‚ö†Ô∏è Medicamento nuevo, sin hermanos a√∫n');
        return;
    }
    try {
        const resp = await fetch(`/admin/medicamentos/${medicamentoId}/hermanos_componente?componente_activo_id=${componenteActivoId}`);
        const data = await resp.json();
        
        if (!data.ok) {
            console.log('‚ö†Ô∏è Error obteniendo hermanos:', data.error);
            return;
        }
        if (!data.componente_nombre || data.medicamentos_hermanos.length === 0) {
            console.log('‚ÑπÔ∏è Sin medicamentos hermanos');
            return;
        }
        mostrarModalHerenciaSintomas(data);
    } catch (error) {
        console.error('‚ùå Error:', error);
    }
}

function mostrarModalHerenciaSintomas(data) {
    const modal = document.createElement('div');
    modal.id = 'modal-herencia-sintomas';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-link text-indigo-600 mr-2"></i>
                    Heredar S√≠ntomas - ${data.componente_nombre}
                </h3>
                <button type="button" onclick="document.getElementById('modal-herencia-sintomas').remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">
                Medicamentos que comparten <strong>${data.componente_nombre}</strong>:
            </p>
            <div id="lista-hermanos" class="space-y-3 mb-6">
                ${data.medicamentos_hermanos.map((hermano, idx) => `
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-gray-800">${hermano.nombre}</h4>
                            <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">
                                ${hermano.cantidad_sintomas} s√≠ntomas
                            </span>
                        </div>
                        <div class="mb-3 p-3 bg-white rounded border-l-4 border-indigo-400">
                            <div class="space-y-2">
                                ${hermano.sintomas.map(sint => {
                                    const tieneYa = data.sintomas_actuales.includes(sint.id);
                                    return `
                                        <div class="flex items-center gap-2 text-sm ${tieneYa ? 'text-green-600' : 'text-gray-700'}">
                                            ${tieneYa ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-circle text-gray-300"></i>'}
                                            ${tieneYa ? '<span class="line-through opacity-70">' : '<span>'}
                                                ${sint.nombre}
                                            </span>
                                            ${tieneYa ? '<span class="text-xs text-green-600 ml-auto">(ya tienes)</span>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <button type="button" class="w-full py-2 px-3 rounded bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold transition-colors"
                            onclick="heredarSintomasDeHermano(${hermano.id}, '${hermano.nombre}', ${medicamentoId}, ${JSON.stringify(data.sintomas_actuales).replace(/"/g, '&quot;')})">
                            <i class="fas fa-copy mr-1"></i> Agregar nuevos s√≠ntomas
                        </button>
                    </div>
                `).join('')}
            </div>
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="document.getElementById('modal-herencia-sintomas').remove()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    Cerrar
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function heredarSintomasDeHermano(hermanoId, hermanoNombre, medicamentoIdActual, sintomasActualesStr) {
    console.log('üîÑ Iniciando herencia...');
    console.log('hermanoId:', hermanoId);
    console.log('hermanoNombre:', hermanoNombre);
    console.log('medicamentoIdActual:', medicamentoIdActual);
    console.log('sintomasActualesStr:', sintomasActualesStr);
    
    try {
        // Parsear s√≠ntomas actuales
        let sintomasActuales = [];
        try {
            // Intentar parsear como JSON array
            sintomasActuales = JSON.parse('[' + sintomasActualesStr.replace(/&quot;/g, '"') + ']');
            console.log('‚úÖ S√≠ntomas actuales parseados:', sintomasActuales);
        } catch (e) {
            console.error('‚ùå Error parseando s√≠ntomas actuales:', e);
            sintomasActuales = [];
        }
        
        // Obtener s√≠ntomas del hermano
        console.log('üîó Fetching s√≠ntomas de hermano ID:', hermanoId);
        const respHermano = await fetch(`/admin/medicamentos/${hermanoId}/sintomas`);
        console.log('üìç Status respuesta:', respHermano.status);
        
        const dataHermano = await respHermano.json();
        console.log('üì¶ Datos hermano:', dataHermano);
        
        if (!dataHermano.ok) {
            alert('‚ùå Error obteniendo s√≠ntomas: ' + (dataHermano.error || 'desconocido'));
            return;
        }
        
        const sintomasHermano = dataHermano.sintomas.map(s => s.sintoma_id);
        console.log('üìã S√≠ntomas hermano:', sintomasHermano);
        
        // Filtrar solo los nuevos
        const sintomasNuevos = sintomasHermano.filter(id => !sintomasActuales.includes(id));
        console.log('‚ú® S√≠ntomas nuevos:', sintomasNuevos);
        
        if (sintomasNuevos.length === 0) {
            alert(`‚úì "${hermanoNombre}" solo tiene s√≠ntomas que ya tienes.`);
            return;
        }
        
        const totalDespues = sintomasActuales.length + sintomasNuevos.length;
        const confirmar = confirm(
            `üìã Resumen de cambios:\n\n` +
            `De: ${hermanoNombre}\n` +
            `S√≠ntomas nuevos: ${sintomasNuevos.length}\n` +
            `${sintomasActuales.length > 0 ? `S√≠ntomas que ya tienes: ${sintomasActuales.length}\n` : ''}` +
            `Total despu√©s: ${totalDespues}\n\n` +
            `¬øAgregar estos s√≠ntomas?`
        );
        
        if (!confirmar) {
            console.log('‚ùå Usuario cancel√≥');
            return;
        }
        
        console.log('‚ûï Agregando s√≠ntomas...');
        sintomasNuevos.forEach(id => sintomasSeleccionados.add(id));
        
        actualizarSintomasSeleccionados();
        renderizarListaSintomas();
        
        console.log('üíæ Guardando en BD...');
        await guardarSintomas();
        
        alert(`‚úÖ Se agregaron ${sintomasNuevos.length} s√≠ntomas nuevos`);
        
        const modalElement = document.getElementById('modal-herencia-sintomas');
        if (modalElement) modalElement.remove();
        
    } catch (error) {
        console.error('‚ùå Error completo:', error);
        console.error('Stack:', error.stack);
        alert('‚ùå Error al heredar s√≠ntomas: ' + error.message);
    }
}





// ================================================
// üÜï LLENADOR DE DATOS - VARIABLES GLOBALES
// ================================================
let enModoLlenado = false;
let tieneMinimo = {
    sintoma: false,
    precio: false,
    imagen: false
};

// Detectar si estamos en modo llenado
function inicializarModoLlenado() {
    const urlParams = new URLSearchParams(window.location.search);
    enModoLlenado = urlParams.has('modo') && urlParams.get('modo') === 'llenado';
    
    if (enModoLlenado) {
        console.log('üü¢ MODO LLENADO ACTIVADO');
        document.getElementById('indicador-completitud').classList.remove('hidden');
        actualizarIndicadorCompletitud();
    }
}

// Actualizar el indicador visual
function actualizarIndicadorCompletitud() {
    // Verificar s√≠ntomas
    tieneMinimo.sintoma = sintomasSeleccionados.size >= 1;
    const badgeSintoma = document.getElementById('badge-sintoma');
    if (tieneMinimo.sintoma) {
        badgeSintoma.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700';
        badgeSintoma.innerHTML = '<i class="fas fa-check-circle mr-1"></i> ‚úÖ 1 S√≠ntoma';
    } else {
        badgeSintoma.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700';
        badgeSintoma.innerHTML = '<i class="fas fa-times-circle mr-1"></i> 1 S√≠ntoma';
    }
    
    // Verificar precio
    tieneMinimo.precio = document.querySelectorAll('#tbody-precios tr').length > 0;
    const badgePrecio = document.getElementById('badge-precio');
    if (tieneMinimo.precio) {
        badgePrecio.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700';
        badgePrecio.innerHTML = '<i class="fas fa-check-circle mr-1"></i> ‚úÖ Precio';
    } else {
        badgePrecio.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700';
        badgePrecio.innerHTML = '<i class="fas fa-times-circle mr-1"></i> Precio + Fab.';
    }
    
    // Verificar imagen
    const imagenActual = document.getElementById('imagen-actual');
    const filasConImagen = document.querySelectorAll('#tbody-precios .imagen-preview img');
    tieneMinimo.imagen = filasConImagen.length > 0;
                         !imagenActual.src.includes('placehold.co') &&
                         !imagenActual.src.includes('Sin+Imagen');
    const badgeImagen = document.getElementById('badge-imagen');
    if (tieneMinimo.imagen) {
        badgeImagen.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700';
        badgeImagen.innerHTML = '<i class="fas fa-check-circle mr-1"></i> ‚úÖ Imagen';
    } else {
        badgeImagen.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700';
        badgeImagen.innerHTML = '<i class="fas fa-times-circle mr-1"></i> Imagen';
    }
    
    // Mostrar bot√≥n siguiente si cumple 3 requisitos
    const btnSiguiente = document.getElementById('btn-siguiente-medicamento');
    if (tieneMinimo.sintoma && tieneMinimo.precio && tieneMinimo.imagen && enModoLlenado) {
        btnSiguiente.classList.add('boton-siguiente-visible');
    } else {
        btnSiguiente.classList.remove('boton-siguiente-visible');
    }
}

// Obtener siguiente medicamento incompleto
async function obtenerSiguienteMedicamento() {
    try {
        const resp = await fetch('/admin/medicamentos/siguiente_incompleto');
        const data = await resp.json();
        
        if (data.ok && data.medicamento_id) {
            // Ir al siguiente medicamento
            window.location.href = `/admin/medicamentos/editar/${data.medicamento_id}?modo=llenado`;
        } else {
            // No hay m√°s medicamentos incompletos
            mostrarMensajeExito();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error obteniendo siguiente medicamento');
    }
}

// Mostrar mensaje de √©xito y volver a lista
function mostrarMensajeExito() {
    const mensaje = document.createElement('div');
    mensaje.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    mensaje.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md text-center">
            <div style="font-size: 60px; margin-bottom: 20px;">üéâ</div>
            <h2 class="text-2xl font-bold text-green-600 mb-3">¬°Completado!</h2>
            <p class="text-gray-700 mb-6">
                Todos los medicamentos han sido completados con la informaci√≥n m√≠nima requerida.
            </p>
            <button onclick="window.location.href='/admin/medicamentos/lista'" 
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">
                ‚úÖ Volver a la Lista
            </button>
        </div>
    `;
    document.body.appendChild(mensaje);
}

// Event listener del bot√≥n siguiente
function configurarBtnSiguiente() {
    const btn = document.getElementById('btn-siguiente-medicamento');
    if (btn) {
        btn.addEventListener('click', async () => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';
            
            // Guardar cambios antes de ir al siguiente
            const form = document.querySelector('form');
            const formData = new FormData(form);
            
            try {
                const resp = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                
                if (resp.ok) {
                    // Obtener siguiente medicamento
                    await obtenerSiguienteMedicamento();
                } else {
                    alert('‚ùå Error guardando cambios');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i> ‚û°Ô∏è Siguiente Medicamento';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error guardando: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i> ‚û°Ô∏è Siguiente Medicamento';
            }
        });
    }
}





// ================================================
// √öNICO DOMCONTENTLOADED CON TODO FUSIONADO ‚úÖ
// ================================================
window.addEventListener('DOMContentLoaded', () => {
console.log('üéØ DOMContentLoaded INICIADO');


// üÜï INICIALIZAR MODO LLENADO
inicializarModoLlenado();
configurarBtnSiguiente();


// ===== INICIALIZADORES =====
inicializarSintomas();
// inicializarComponenteActivo(); // ‚ö†Ô∏è Funci√≥n eliminada - ahora usa el nuevo script
// ===== ELEMENTOS =====
const form = document.querySelector('form');
const estadoBanner = document.getElementById('estado-guardado');
const botonFlotante = document.getElementById('boton-flotante');
const textoBotonFlotante = document.getElementById('texto-boton-flotante');
let hubosCambios = false;
// ===== MODAL =====
document.getElementById('modal-cerrar').addEventListener('click', cerrarModal);
document.getElementById('modal-cancelar').addEventListener('click', cerrarModal);
document.getElementById('modal-confirmar').addEventListener('click', async () => {
    const btnConfirmar = document.getElementById('modal-confirmar');
    const textoOriginal = btnConfirmar.innerHTML;
    
    // üîí Desabilitar bot√≥n
    btnConfirmar.disabled = true;
    btnConfirmar.textContent = '‚è≥ Creando...';
    
    // ‚úÖ Crear la indicaci√≥n
    await crearYAsociarSintoma();
    
    // ‚è≥ ESPERAR 1 SEGUNDO para que la BD se sincronice
    console.log('‚è≥ Esperando 1 segundo para sincronizar base de datos...');
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // üîì Habilitar bot√≥n de nuevo
    btnConfirmar.disabled = false;
    btnConfirmar.innerHTML = textoOriginal;
    
    console.log('‚úÖ Listo para siguiente acci√≥n');
});

document.getElementById('modal-nuevo-sintoma').addEventListener('click', (e) => {
if (e.target.id === 'modal-nuevo-sintoma') {
cerrarModal();
}
});
// ===== EVENT LISTENERS INDICACIONES =====
document.getElementById('buscar-sintoma').addEventListener('input', (e) => {
renderizarListaSintomas(e.target.value);
});
document.getElementById('buscar-sintomas-online').addEventListener('click', buscarSintomasEnLinea);

// ===== BOT√ìN CREAR INDICACI√ìN MANUAL =====
document.getElementById('btn-crear-indicacion-manual').addEventListener('click', () => {
    mostrarModalNuevoSintoma('', '');
});


// ===== BOT√ìN BUSCAR COMPONENTE EN GOOGLE ‚úÖ
document.getElementById('btn-buscar-componente-google').addEventListener('click', function() {
const nombreMedicamento = document.getElementById('nombre').value;
if (nombreMedicamento) {
const busqueda = `componente activo de ${nombreMedicamento}`;
window.open(`https://www.google.com/search?q=${encodeURIComponent(busqueda)}`, '_blank');
} else {
alert('Primero ingresa el nombre del medicamento');
}
});
// ===== DETECTAR CAMBIOS DEL FORMULARIO =====
const esNuevoForm = {{ 'true' if es_nuevo else 'false' }};
if (esNuevoForm) {
textoBotonFlotante.textContent = 'Crear Medicamento';
botonFlotante.querySelector('i').className = 'fas fa-plus-circle';
}
form.addEventListener('change', () => {
if (!hubosCambios) {
hubosCambios = true;
estadoBanner.classList.remove('hidden');
botonFlotante.classList.add('visible');
}
});
form.addEventListener('input', () => {
if (!hubosCambios) {
hubosCambios = true;
estadoBanner.classList.remove('hidden');
botonFlotante.classList.add('visible');
}
});
form.addEventListener('submit', () => {
estadoBanner.classList.add('hidden');
botonFlotante.classList.remove('visible');
hubosCambios = false;
});
if (esNuevoForm) {
estadoBanner.classList.remove('hidden');
botonFlotante.classList.add('visible');
}
// ===== PRECIOS EN L√çNEA =====
const info = document.getElementById('precio-info');
const cargando = document.getElementById('precio-cargando');
const error = document.getElementById('precio-error');
const lista = document.getElementById('lista-precios');
const promedio = document.getElementById('precio-promedio');
const preciosContainer = document.getElementById('precios-container');
if (!medicamentoNombre || medicamentoNombre.trim() === '') {
console.log('‚ö†Ô∏è Sin nombre, saltando b√∫squeda de precios');
preciosContainer.classList.remove('hidden');
} else {
cargando.classList.remove('hidden');
fetch(`/admin/buscar_precios?nombre=${encodeURIComponent(medicamentoNombre)}`)
.then(r => r.json())
.then(data => {
cargando.classList.add('hidden');
if (data.ok && data.fabricantes && data.fabricantes.length > 0) {
lista.innerHTML = '';
data.fabricantes.forEach(fabInfo => {
const divFab = document.createElement('div');
divFab.className = 'mb-4 p-3 bg-gray-50 rounded border';
const titulo = document.createElement('h4');
titulo.className = 'font-bold text-blue-700 mb-2';
titulo.textContent = `${fabInfo.fabricante} - Mediana: $${fabInfo.mediana.toLocaleString('es-CO')} (${data.presentacion})`;
divFab.appendChild(titulo);
const ul = document.createElement('ul');
ul.className = 'ml-4';
fabInfo.detalles.forEach(detalle => {
const li = document.createElement('li');
li.className = 'mb-1 text-sm';
const texto = document.createElement('span');
texto.textContent = `${detalle.fuente}: $${detalle.precio.toLocaleString('es-CO')} `;
const link = document.createElement('a');
link.href = detalle.link;
link.target = '_blank';
link.className = 'text-blue-600 hover:text-blue-800 text-xs';
link.innerHTML = '<i class="fas fa-external-link-alt"></i> Ver';
li.appendChild(texto);
li.appendChild(link);
ul.appendChild(li);
});
divFab.appendChild(ul);
lista.appendChild(divFab);
});
promedio.textContent = `‚úÖ Encontrados ${data.total_fabricantes} fabricante(s) - Presentaci√≥n: ${data.presentacion}`;
info.classList.remove('hidden');
} else {
error.textContent = data.error || 'No se encontraron precios en l√≠nea para este medicamento.';
error.classList.remove('hidden');
}
})
.catch(() => {
cargando.classList.add('hidden');
error.textContent = 'Error al consultar los precios en l√≠nea.';
error.classList.remove('hidden');
})
.finally(() => {
preciosContainer.classList.remove('hidden');
});
}
// ===== TABLA DE PRECIOS =====
const tbody = document.getElementById("tbody-precios");
async function cargarPrecios() {
tbody.innerHTML = "";
const resp = await fetch(`/admin/precios/${medicamentoId}`);
const data = await resp.json();
if (!data.ok) return alert("Error cargando precios");
data.precios.forEach(p => {
agregarFila(p.fabricante_id, p.fabricante, p.precio, p.imagen, p.fecha_actualizacion, p.id);
});
}
let fabricantesDisponibles = [];
async function cargarFabricantes() {
const resp = await fetch('/admin/fabricantes');
const data = await resp.json();
if (data.ok) {
fabricantesDisponibles = data.fabricantes;
}
}
function agregarFila(fabricanteId = null, fabricanteNombre = "", precio = "", imagen = "", fecha = "", precioId = null) {
    let optionsFab = '<option value="">Selecciona fabricante...</option>';
    fabricantesDisponibles.forEach(f => {
        const selected = f.id === fabricanteId ? 'selected' : '';
        optionsFab += `<option value="${f.id}" ${selected}>${f.nombre}</option>`;
    });
    optionsFab += '<option value="nuevo">‚úèÔ∏è Escribir nuevo...</option>';

    const imagenPreview = imagen
        ? `<img src="/static/uploads/${imagen}" class="w-16 h-16 object-cover rounded border">`
        : `<div class="w-16 h-16 bg-gray-100 rounded border flex items-center justify-center text-gray-400 text-xs">Sin img</div>`;

    // FILA PRINCIPAL: 4 COLUMNAS SEPARADAS
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td class="p-2" style="width: 140px; vertical-align: top;">
            <div class="flex flex-col items-center gap-1">
                <div class="imagen-preview">${imagenPreview}</div>
                <div class="paste-zone-precio w-16 text-center text-xs text-gray-500 border-2 border-dashed border-gray-300 rounded p-1 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition-colors">üìã</div>
                <div class="flex gap-1">
                    <button type="button" class="btn-buscar-google text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">üîç</button>
                    <button type="button" class="btn-cambiar-imagen text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">üì∑</button>
                </div>
                <input type="file" class="imagen-file hidden" accept="image/*">
            </div>
        </td>
        <td class="p-2" style="width: 200px; vertical-align: center;">
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <select class="fabricante-select w-full p-1 border rounded text-sm">${optionsFab}</select>
                <input type="text" class="fabricante-input hidden w-full p-1 border rounded text-sm" placeholder="Nombre nuevo fabricante">
            </div>
        </td>
        <td class="p-2" style="width: 130px; vertical-align: center;">
            <input type="number" step="0.01" min="0" value="${precio || ""}" class="precio-input w-full p-1 border rounded text-sm" placeholder="Precio">
        </td>
        <td class="p-2 text-xs text-gray-600" style="width: 100px; vertical-align: center;">
            ${fecha || "-"}
        </td>
    `;

    // ===== EVENT LISTENERS =====
    
    // SELECT FABRICANTE - mostrar/ocultar input nuevo
    const selectFab = tr.querySelector(".fabricante-select");
    const inputFab = tr.querySelector(".fabricante-input");
    selectFab.onchange = () => {
        if (selectFab.value === "nuevo") {
            inputFab.classList.remove("hidden");
            inputFab.focus();
        } else {
            inputFab.classList.add("hidden");
        }
    };

    // BOT√ìN BUSCAR IMAGEN EN GOOGLE
    const btnBuscarGoogle = tr.querySelector(".btn-buscar-google");
    btnBuscarGoogle.onclick = () => {
        let nombreFabricante = "";
        const selectVal = selectFab.value;
        if (selectVal === "nuevo") {
            nombreFabricante = inputFab.value.trim();
            if (!nombreFabricante) {
                alert("Primero selecciona o escribe un fabricante");
                return;
            }
        } else if (selectVal) {
            const fabSeleccionado = fabricantesDisponibles.find(f => f.id == selectVal);
            nombreFabricante = fabSeleccionado ? fabSeleccionado.nombre : "";
        } else {
            nombreFabricante = fabricanteNombre;
        }
        if (!nombreFabricante) {
            alert("Primero selecciona un fabricante");
            return;
        }
        const busqueda = `${medicamentoNombre} ${nombreFabricante}`;
        window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(busqueda)}`, '_blank');
    };

    // BOT√ìN CAMBIAR IMAGEN
    const btnCambiarImg = tr.querySelector(".btn-cambiar-imagen");
    const fileInput = tr.querySelector(".imagen-file");
    const imagenPreviewDiv = tr.querySelector(".imagen-preview");

    btnCambiarImg.onclick = () => fileInput.click();

    fileInput.onchange = async (e) => {
        if (!precioId) {
            alert("‚ö†Ô∏è Primero guarda el precio, luego podr√°s subir la imagen");
            fileInput.value = '';
            return;
        }
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('imagen', file);
        btnCambiarImg.disabled = true;
        btnCambiarImg.innerHTML = '‚è≥...';

        try {
            const resp = await fetch(`/admin/precios/${precioId}/imagen`, {
                method: 'POST',
                body: formData
            });
            const data = await resp.json();
            if (data.ok) {
                imagenPreviewDiv.innerHTML = `<img src="/static/uploads/${data.imagen}?t=${Date.now()}" class="w-16 h-16 object-cover rounded border">`;
                alert('‚úÖ Imagen actualizada');
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        } catch (err) {
            alert('‚ùå Error subiendo imagen');
            console.error(err);
        } finally {
            btnCambiarImg.disabled = false;
            btnCambiarImg.innerHTML = 'üì∑';
            fileInput.value = '';
        }
    };

    // ZONA DE PEGADO
    const pasteZone = tr.querySelector(".paste-zone-precio");
    let pasteListenerActivo = false;

    pasteZone.onclick = () => {
        if (!precioId) {
            alert("‚ö†Ô∏è Primero guarda el precio, luego podr√°s pegar la imagen");
            return;
        }
        pasteZone.classList.add('active');
        pasteZone.textContent = '‚úÖ Listo! Pega con Ctrl+V';
        pasteListenerActivo = true;
        document.removeEventListener('paste', handlePaste);

        async function handlePaste(event) {
            if (!pasteListenerActivo) return;
            const items = event.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const blob = item.getAsFile();
                    const formData = new FormData();
                    formData.append('imagen', blob, 'imagen.jpg');
                    pasteZone.textContent = '‚è≥ Guardando...';
                    try {
                        const resp = await fetch(`/admin/precios/${precioId}/imagen`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await resp.json();
                        if (data.ok) {
                            imagenPreviewDiv.innerHTML = `<img src="/static/uploads/${data.imagen}?t=${Date.now()}" class="w-16 h-16 object-cover rounded border">`;
                            pasteZone.classList.remove('active');
                            pasteZone.textContent = 'üìã';
                            alert(`‚úÖ Imagen guardada`);
                        } else {
                            alert('‚ùå Error: ' + data.error);
                            pasteZone.classList.remove('active');
                            pasteZone.textContent = 'üìã';
                        }
                    } catch (err) {
                        alert('‚ùå Error subiendo imagen');
                        console.error(err);
                        pasteZone.classList.remove('active');
                        pasteZone.textContent = 'üìã';
                    } finally {
                        pasteListenerActivo = false;
                        document.removeEventListener('paste', handlePaste);
                    }
                    break;
                }
            }
        }
        document.addEventListener('paste', handlePaste);
        setTimeout(() => {
            if (pasteListenerActivo) {
                pasteListenerActivo = false;
                pasteZone.classList.remove('active');
                pasteZone.textContent = 'üìã';
                document.removeEventListener('paste', handlePaste);
            }
        }, 30000);
    };

    // FILA DE BOTONES (segunda fila)
    const tr2 = document.createElement("tr");
    tr2.innerHTML = `
        <td colspan="4" class="p-2"style="vertical-align: top;">
            <div style="display: flex; gap: 8px; justify-content: center;">
                <button class="guardar px-4 py-2 bg-blue-600 text-white rounded text-sm font-semibold hover:bg-blue-700">${precioId ? "Guardar" : "Crear"}</button>
                <button type="button" class="eliminar px-4 py-2 bg-red-600 text-white rounded text-sm font-semibold hover:bg-red-700" onclick="eliminarPrecio(${precioId})" ${!precioId ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
                    Eliminar
                </button>
            </div>
        </td>
    `;

    // BOT√ìN GUARDAR
    const btn = tr2.querySelector(".guardar");
    btn.onclick = async () => {
        const selectVal = selectFab.value;
        let nombreFab = "";
        let fabricante_id = null;

        if (selectVal === "nuevo") {
            nombreFab = inputFab.value.trim();
            if (!nombreFab) return alert("Escribe el nombre del fabricante");
            const fabResp = await fetch("/admin/fabricantes/by_name", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({nombre: nombreFab})
            });
            const fabData = await fabResp.json();
            if (!fabData.ok) return alert("Error con fabricante");
            fabricante_id = fabData.fabricante.id;
        } else {
            if (!selectVal) return alert("Selecciona un fabricante");
            fabricante_id = parseInt(selectVal);
        }

        const valor = parseFloat(tr.querySelector(".precio-input").value || 0);
        if (isNaN(valor) || valor <= 0) return alert("Precio inv√°lido");

        const guardarResp = await fetch("/admin/precios/guardar", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                id: precioId,
                medicamento_id: medicamentoId,
                fabricante_id,
                precio: valor
            })
        });
        const guardarData = await guardarResp.json();
        if (!guardarData.ok) return alert("Error guardando precio");
        alert("‚úÖ Precio guardado");
        actualizarIndicadorCompletitud();
        cargarPrecios();
        if (window.location.search.includes('modo=llenado')) {
            window.history.replaceState({}, '', window.location.pathname + '?modo=llenado');
        }
    };

    tbody.appendChild(tr);
    tbody.appendChild(tr2);
}


document.getElementById("btn-nuevo-precio").onclick = () => {
if (!medicamentoId || medicamentoId === 'null' || medicamentoId === '') {
alert('‚ö†Ô∏è Primero debes CREAR el medicamento antes de agregar precios.');
return;
}
agregarFila();
};
cargarFabricantes().then(() => {
if (medicamentoId && medicamentoId !== 'None' && medicamentoId !== '') {
cargarPrecios();

// Mantener modo llenado
if (window.location.search.includes('modo=llenado')) {
    window.history.replaceState({}, '', window.location.pathname + '?modo=llenado');
}

} else {
console.log('üÜï Medicamento nuevo: tabla de precios vac√≠a');
document.getElementById('precios-container').classList.remove('hidden');
}
});
// ===== B√öSQUEDA DE IMAGEN =====
document.getElementById('search-button').addEventListener('click', function() {
const nombre = document.getElementById('nombre').value;
if (nombre) {
window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(nombre)}`, '_blank');
} else {
alert('Por favor, ingresa un nombre de medicamento');
}
});
// ===== PEGAR IMAGEN =====
document.addEventListener('paste', function(event) {
if (document.querySelector('.paste-zone-precio.active')) {
return;
}
const items = event.clipboardData.items;
for (let item of items) {
if (item.type.indexOf('image') !== -1) {
event.preventDefault();
const blob = item.getAsFile();
const formData = new FormData();
formData.append('imagen', blob, 'imagen.jpg');
mostrarMensaje('‚è≥ Guardando imagen...', 'info');
fetch(`/admin/medicamentos/guardar_imagen_pegada/${medicamentoId}`, {
method: 'POST',
body: formData
})
.then(r => r.json())
.then(data => {
if (data.success) {
document.getElementById('imagen-actual').src = `/static/uploads/${data.imagen}?t=${Date.now()}`;
document.getElementById('btn-eliminar-imagen').classList.remove('hidden');
mostrarMensaje('‚úÖ Medicamento actualizado con la nueva imagen', 'success');
} else {
mostrarMensaje('‚ùå Error: ' + data.error, 'error');
}
});
break;
}
}
});
// ===== CARGA MANUAL DE IMAGEN =====
document.getElementById('imagen').addEventListener('change', function(event) {
const file = event.target.files[0];
if (file) {
const ext = file.name.split('.').pop().toLowerCase();
const nombre = `${medicamentoNombre}.${ext}`;
document.getElementById('filename-preview').textContent = nombre;
document.getElementById('file-info').classList.remove('hidden');
}
});


// Listener para cambios en componente activo
if (document.getElementById('componente_activo_id')) {
    document.getElementById('componente_activo_id').addEventListener('change', () => {
        const componenteActivoId = document.getElementById('componente_activo_id').value;
        console.log('üîÑ Componente activo cambi√≥ a ID:', componenteActivoId);
        
        if (componenteActivoId) { // Solo si hay componente seleccionado
            setTimeout(() => {
                cargarYMostrarHermanosComponente(componenteActivoId);
            }, 500);
        }
    });
}


console.log('‚úÖ DOMContentLoaded COMPLETADO');
}); // üéØ √öNICO DOMCONTENTLOADED CERRADO



// üÜï ELIMINAR PRECIO
async function eliminarPrecio(precioId) {
    if (!precioId) {
        alert('‚ö†Ô∏è Primero guarda el precio antes de eliminarlo');
        return;
    }
    
    if (!confirm('¬øEliminar este precio?')) return;
    
    try {
        const resp = await fetch(`/admin/precios/${precioId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await resp.json();
        
        if (data.ok) {
            alert('‚úÖ Precio eliminado');
            location.reload(); // Recarga la p√°gina
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Error eliminando: ' + error.message);
    }
}


</script>


<!-- Modal para confirmar creaci√≥n de indicaci√≥n nueva -->
<div id="modal-nuevo-sintoma" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
<div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
<div class="flex items-center justify-between mb-4">
<h3 class="text-xl font-bold text-gray-800">
<i class="fas fa-plus-circle text-indigo-600 mr-2"></i>
Crear Indicaci√≥n Nueva
</h3>
<button id="modal-cerrar" class="text-gray-400 hover:text-gray-600">
<i class="fas fa-times text-xl"></i>
</button>
</div>
<p class="text-sm text-gray-600 mb-4">
Esta indicaci√≥n no existe en la base de datos. ¬øDeseas crearla y asociarla a este medicamento?
</p>
<div class="space-y-3">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la indicaci√≥n</label>
<input type="text" id="modal-nombre-sintoma"
class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Sin√≥nimos (opcional)</label>
<input type="text" id="modal-descripcion-sintoma"
placeholder="Ej: dolor de cabeza, cefalea"
class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
<p class="text-xs text-gray-500 mt-1">Separa con comas</p>
</div>
</div>
<div class="flex gap-3 mt-6">
<button id="modal-cancelar" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
Cancelar
</button>
<button id="modal-confirmar" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
<i class="fas fa-check mr-1"></i> Crear y Asociar
</button>
</div>
</div>
</div>




<script>
// üéØ SCRIPT PARA CREAR COMPONENTE ACTIVO R√ÅPIDO
document.addEventListener('DOMContentLoaded', () => {
  const inputComponente = document.getElementById('input-componente-activo');
  const btnCrear = document.getElementById('btn-crear-rapido');
  const msgCrear = document.getElementById('msg-crear-rapido');
  const selectComponente = document.getElementById('componente_activo_id');

  // Validar que existan todos los elementos
  if (!inputComponente || !btnCrear || !msgCrear) {
    console.error('‚ö†Ô∏è Faltan elementos del componente activo');
    return;
  }

  // üÜï CARGAR COMPONENTES ACTIVOS EN EL SELECT
  async function cargarComponentesActivos() {
    console.log('üîß Cargando componentes activos...');
    const componenteActualId = document.getElementById('componente_activo_id_actual').value;
    console.log(`üìå Componente activo actual en BD: ${componenteActualId || 'ninguno'}`);
    
    try {
      const resp = await fetch(`/admin/medicamentos/componentes_activos/lista?medicamento_id=${medicamentoId}`);
      const data = await resp.json();
      
      if (data.ok) {
        // Limpiar select (excepto la primera opci√≥n)
        selectComponente.innerHTML = '<option value="">-- Seleccionar componente activo --</option>';
        
        // Agregar todos los componentes
        data.componentes_activos.forEach(comp => {
          const option = document.createElement('option');
          option.value = comp.id;
          option.textContent = comp.nombre;
          selectComponente.appendChild(option);
        });
        
        console.log(`‚úÖ ${data.componentes_activos.length} componentes cargados`);
        
        // Pre-seleccionar el actual si existe
        if (componenteActualId) {
          selectComponente.value = componenteActualId;
          console.log(`‚úÖ Pre-seleccionado: ${componenteActualId}`);
          
          // üÜï Actualizar el input con el nombre del componente seleccionado
          const selectedOption = selectComponente.options[selectComponente.selectedIndex];
          if (selectedOption) {
            inputComponente.value = selectedOption.textContent;
            console.log(`üìù Input actualizado: ${selectedOption.textContent}`);
          }
        }
      }
    } catch (error) {
      console.error('‚ùå Error cargando componentes:', error);
    }
    
    // Verificar si este medicamento es componente activo de otros
    if (medicamentoId && medicamentoId !== 'null' && medicamentoId !== '') {
      try {
        const resp = await fetch(`/admin/medicamentos/${medicamentoId}/es_componente_activo`);
        const data = await resp.json();
        
        if (data.ok && data.es_componente_activo) {
          console.log('‚ö†Ô∏è Este medicamento es componente activo de otros');
          document.getElementById('advertencia-componente').classList.remove('hidden');
          const lista = document.getElementById('lista-medicamentos-que-lo-usan');
          lista.innerHTML = ''; // Limpiar lista
          data.medicamentos_que_lo_usan.forEach(med => {
            const li = document.createElement('li');
            li.textContent = med.nombre;
            lista.appendChild(li);
          });
          selectComponente.disabled = true;
          console.log('üîí Dropdown deshabilitado');
        } else {
          console.log('‚úÖ Este medicamento NO es componente activo de otros');
        }
      } catch (error) {
        console.error('‚ùå Error verificando:', error);
      }
    }
  }
  
  // Cargar componentes al iniciar
  cargarComponentesActivos();

  let timer = null;

  // Detectar escritura en el input
  inputComponente.addEventListener('input', async () => {
    const texto = inputComponente.value.trim();
    btnCrear.classList.add('hidden');
    msgCrear.classList.add('hidden');

    // üÜï FILTRAR opciones del select mientras escribe
    const filtroLower = texto.toLowerCase();
    Array.from(selectComponente.options).forEach(option => {
      if (option.value === '') {
        option.style.display = 'block'; // Siempre mostrar la opci√≥n vac√≠a
        return;
      }
      const textoOpcion = option.textContent.toLowerCase();
      option.style.display = textoOpcion.includes(filtroLower) ? 'block' : 'none';
    });

    if (texto.length === 0) {
      // Si no hay texto, mostrar todas las opciones
      Array.from(selectComponente.options).forEach(opt => opt.style.display = 'block');
      return;
    }

    // Esperar un poco para no consultar en cada tecla
    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const resp = await fetch(`/buscar_medicamentos?nombre=${encodeURIComponent(texto)}`);
        const data = await resp.json();

        if (!data.ok || !data.medicamentos || data.medicamentos.length === 0) {
          // No hay coincidencias ‚Üí mostrar bot√≥n para crear
          btnCrear.classList.remove('hidden');
          btnCrear.dataset.nombre = texto;
        } else {
          btnCrear.classList.add('hidden');
        }
      } catch (err) {
        console.error('Error al buscar medicamentos:', err);
      }
    }, 400);
  });

  // Crear nuevo medicamento al hacer clic
  btnCrear.addEventListener('click', async () => {
    const nombre = btnCrear.dataset.nombre;
    if (!nombre) return;

    btnCrear.disabled = true;
    btnCrear.textContent = 'Creando...';

    try {
      const resp = await fetch('/crear_medicamento_rapido', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          nombre: nombre,
          medicamento_id: medicamentoId  // üÜï Enviar ID del medicamento actual
        })
      });
      const data = await resp.json();

      if (data.ok) {
        msgCrear.textContent = data.exists
          ? `‚úÖ Ya exist√≠a el medicamento "${data.nombre}". Asociado correctamente.`
          : `‚úÖ Medicamento "${data.nombre}" creado y asociado.`;
        msgCrear.classList.remove('hidden');
        msgCrear.classList.remove('text-red-600');
        msgCrear.classList.add('text-green-600');

        // Agregar al select si no existe
        if (selectComponente) {
          // Verificar si ya existe en el select
          const existeEnSelect = Array.from(selectComponente.options).some(opt => opt.value == data.id);
          
          if (!existeEnSelect) {
            const option = new Option(data.nombre, data.id, true, true);
            selectComponente.appendChild(option);
          }
          
          selectComponente.value = data.id;
        }

        inputComponente.value = data.nombre;
      } else {
        msgCrear.textContent = `‚ùå Error: ${data.error || 'No se pudo crear el medicamento'}`;
        msgCrear.classList.remove('hidden');
        msgCrear.classList.add('text-red-600');
        msgCrear.classList.remove('text-green-600');
      }
    } catch (err) {
      console.error('Error al crear medicamento:', err);
      msgCrear.textContent = '‚ùå Error de conexi√≥n';
      msgCrear.classList.remove('hidden');
      msgCrear.classList.add('text-red-600');
    } finally {
      btnCrear.disabled = false;
      btnCrear.textContent = '‚ûï Crear nuevo medicamento con este nombre y asociar a este como componente activo';
      btnCrear.classList.add('hidden');
    }
  });

  // üÜï Sincronizar select con input cuando se selecciona una opci√≥n
  selectComponente.addEventListener('change', () => {
    const selectedOption = selectComponente.options[selectComponente.selectedIndex];
    if (selectedOption && selectedOption.value !== '') {
      inputComponente.value = selectedOption.textContent;
      console.log(`‚úÖ Seleccionado del dropdown: ${selectedOption.textContent}`);
    } else {
      inputComponente.value = '';
    }
  });
});
</script>
</body>
</html>